<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asesmen Oxfam (RIEA) - SATGAS USU</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <style>
    body { background: #f8fafc; }
    .sticky-actions { position: sticky; top: 0; z-index: 10; background: #f8fafc; padding: 12px 0; border-bottom: 1px solid #e5e7eb; }
    .card-header small { opacity: .8; }
    .q-label { font-weight: 600; }
    .q-hint { font-size: 12px; color: #64748b; }
    .req-star { color: #ef4444; font-weight: 700; }
    .note-box { background: #fff; border: 1px dashed #cbd5e1; border-radius: 10px; padding: 12px; }
    .toc a { text-decoration: none; }
    #mapPick { height: 280px; border-radius: 12px; border: 1px solid #e5e7eb; }
    .option-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px 14px; }
  </style>
</head>
<body>
  <div class="container py-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div>
        <h3 class="mb-0">Asesmen Oxfam (RIEA)</h3>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="{{ url_for('map_view') }}">
          <i class="fas fa-arrow-left me-1"></i> Kembali ke Peta
        </a>
      </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="sticky-actions">
      <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div class="text-muted">Pastikan <b>Posko</b>, <b>Waktu</b>, dan <b>Koordinat</b> terisi.</div>
        <button type="submit" form="formOxfam" class="btn btn-success">
          <i class="fas fa-save me-1"></i> Simpan Asesmen
        </button>
      </div>
    </div>

    <form id="formOxfam" method="POST" action="{{ url_for('asesmen_oxfam_submit') }}" class="mt-3">
      <div class="card mb-3">
        <div class="card-header bg-white">
          <div class="fw-bold"><i class="fas fa-map-marker-alt me-2"></i>Data Meta</div>
          <small class="text-muted">Koordinat, waktu (WIB), dan posko (wajib).</small>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Posko <span class="req-star">*</span></label>
              <select class="form-select" name="kode_posko" required>
                <option value="">-- Pilih Posko --</option>
                {% for p in (posko_options or []) %}
                  <option value="{{ p.kode_posko }}" {% if (prefill.kode_posko or '') == p.kode_posko %}selected{% endif %}>
                    {{ p.kode_posko }} - {{ p.nama_posko }}
                  </option>
                {% endfor %}
              </select>
              <div class="q-hint">Diambil dari data_lokasi (jenis: Posko Pengungsian). Jika kosong, cek data posko di peta.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Waktu (WIB) <span class="req-star">*</span></label>
              <input class="form-control" type="datetime-local" name="waktu" value="{{ prefill.waktu_local or '' }}" required />
              <div class="q-hint">Format input browser (akan disimpan sebagai WIB).</div>
            </div>

            <div class="col-md-3">
              <label class="form-label">Latitude <span class="req-star">*</span></label>
              <input class="form-control" type="number" step="any" name="latitude" id="latitude" value="{{ prefill.latitude or '' }}" required />
            </div>
            <div class="col-md-3">
              <label class="form-label">Longitude <span class="req-star">*</span></label>
              <input class="form-control" type="number" step="any" name="longitude" id="longitude" value="{{ prefill.longitude or '' }}" required />
            </div>
            <div class="col-md-6 d-flex align-items-end gap-2">
              <button class="btn btn-outline-primary" type="button" id="btnGps">
                <i class="fas fa-location-crosshairs me-1"></i> Ambil Lokasi GPS
              </button>
              <button class="btn btn-outline-secondary" type="button" id="btnCenterSumut">
                <i class="fas fa-crosshairs me-1"></i> Center Sumut
              </button>
              <div class="text-muted small">Klik peta untuk mengisi lat/lon.</div>
            </div>
          </div>

          <div class="mt-3">
            <div id="mapPick"></div>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header bg-white">
          <div class="fw-bold"><i class="fas fa-list-check me-2"></i>Daftar Bagian</div>
          <small class="text-muted">Klik untuk lompat ke bagian tertentu.</small>
        </div>
        <div class="card-body toc">
          <div class="row g-2">
            {% for g in (form_nodes or []) if g.kind == 'group' %}
              <div class="col-md-6">
                <a href="#grp-{{ g.name }}"><i class="fas fa-chevron-right me-1"></i>{{ g.label or g.name }}</a>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      {% macro render_node(node, depth=0) %}
        {% if node.kind == 'group' %}
          <div class="card mb-3 relevant-node" data-relevant="{{ node.relevant or '' }}">
            <div class="card-header bg-white">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <div class="fw-bold" id="grp-{{ node.name }}">{{ node.label or node.name }}</div>
                  {% if node.hint %}<small class="text-muted">{{ node.hint }}</small>{% endif %}
                </div>
                <span class="badge text-bg-light">Bagian</span>
              </div>
            </div>
            <div class="card-body">
              {% for ch in (node.children or []) %}
                {{ render_node(ch, depth+1) }}
              {% endfor %}
            </div>
          </div>
        {% elif node.kind == 'question' %}
          {% set q = node %}
          <div class="mb-3 relevant-node" data-relevant="{{ q.relevant or '' }}">
            {% if q.qtype == 'note' %}
              <div class="note-box">{{ q.label or '' }}</div>
              {% if q.hint %}<div class="q-hint mt-1">{{ q.hint }}</div>{% endif %}
            {% else %}
              <label class="form-label q-label">
                {{ q.label or q.name }}
                {% if q.required %}<span class="req-star">*</span>{% endif %}
              </label>

              {% if q.qtype in ['text'] %}
                <input class="form-control" type="text" name="{{ q.name }}" {% if q.required %}required{% endif %} />

              {% elif q.qtype in ['integer'] %}
                <input class="form-control" type="number" step="1" name="{{ q.name }}" {% if q.required %}required{% endif %} />

              {% elif q.qtype in ['decimal'] %}
                <input class="form-control" type="number" step="any" name="{{ q.name }}" {% if q.required %}required{% endif %} />

              {% elif q.qtype == 'select_one' %}
                <select class="form-select" name="{{ q.name }}" {% if q.required %}required{% endif %}>
                  <option value="">-- pilih --</option>
                  {% for opt in (choices.get(q.list_name, []) or []) %}
                    <option value="{{ opt.name }}">{{ opt.label }}</option>
                  {% endfor %}
                </select>

              {% elif q.qtype == 'select_multiple' %}
                <div class="option-grid">
                  {% for opt in (choices.get(q.list_name, []) or []) %}
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="{{ q.name }}" id="{{ q.name }}__{{ opt.name }}" value="{{ opt.name }}" />
                      <label class="form-check-label" for="{{ q.name }}__{{ opt.name }}">{{ opt.label }}</label>
                    </div>
                  {% endfor %}
                </div>

              {% else %}
                <input class="form-control" type="text" name="{{ q.name }}" {% if q.required %}required{% endif %} />
              {% endif %}

              {% if q.hint %}<div class="q-hint mt-1">{{ q.hint }}</div>{% endif %}
            {% endif %}
          </div>
        {% endif %}
      {% endmacro %}

      {% for node in (form_nodes or []) %}
        {{ render_node(node, 0) }}
      {% endfor %}

      <div class="d-flex justify-content-end pb-5">
        <button type="submit" class="btn btn-success btn-lg">
          <i class="fas fa-save me-1"></i> Simpan Asesmen
        </button>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Mini map pick coordinate ---
    const latEl = document.getElementById('latitude');
    const lonEl = document.getElementById('longitude');

    const defaultCenter = [2.3693, 99.0763];
    const initLat = parseFloat(latEl.value);
    const initLon = parseFloat(lonEl.value);
    const initCenter = (isFinite(initLat) && isFinite(initLon)) ? [initLat, initLon] : defaultCenter;

    const mapPick = L.map('mapPick').setView(initCenter, (initCenter === defaultCenter) ? 7 : 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(mapPick);

    let marker = null;
    function setMarker(lat, lon){
      if (!isFinite(lat) || !isFinite(lon)) return;
      if (marker) marker.remove();
      marker = L.marker([lat, lon]).addTo(mapPick);
      latEl.value = lat;
      lonEl.value = lon;
    }
    if (isFinite(initLat) && isFinite(initLon)) setMarker(initLat, initLon);

    mapPick.on('click', (e) => {
      setMarker(+e.latlng.lat.toFixed(6), +e.latlng.lng.toFixed(6));
    });

    document.getElementById('btnGps').addEventListener('click', () => {
      if (!navigator.geolocation) return alert('Browser tidak mendukung geolocation.');
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = +pos.coords.latitude.toFixed(6);
          const lon = +pos.coords.longitude.toFixed(6);
          mapPick.setView([lat, lon], 15);
          setMarker(lat, lon);
        },
        (err) => alert('Gagal ambil GPS: ' + (err && err.message ? err.message : 'unknown')),
        { enableHighAccuracy: true, timeout: 15000 }
      );
    });

    document.getElementById('btnCenterSumut').addEventListener('click', () => {
      mapPick.setView(defaultCenter, 7);
    });

    // --- Relevant (skip logic sederhana) ---
    function getVal(field){
      const els = document.querySelectorAll(`[name="${CSS.escape(field)}"]`);
      if (!els || !els.length) return null;
      const el0 = els[0];
      if (el0.type === 'checkbox') {
        return Array.from(els).filter(e => e.checked).map(e => e.value);
      }
      if (el0.type === 'radio') {
        const hit = Array.from(els).find(e => e.checked);
        return hit ? hit.value : null;
      }
      return el0.value;
    }

    function selected(field, value){
      const v = getVal(field);
      if (Array.isArray(v)) return v.includes(value);
      return String(v ?? '') === String(value);
    }

    function toJsExpr(expr){
      if (!expr) return '';
      let s = String(expr);
      // selected(${x}, 'y')  (tolerate whitespace; support single/double quotes)
      s = s.replace(/selected\(\s*\$\{([^}]+)\}\s*,\s*'([^']*)'\s*\)/g, (m, f, v) => `selected('${f}','${v}')`);
      s = s.replace(/selected\(\s*\$\{([^}]+)\}\s*,\s*\"([^\"]*)\"\s*\)/g, (m, f, v) => `selected('${f}','${v}')`);
      // ${x}
      s = s.replace(/\$\{([^}]+)\}/g, (m, f) => `getVal('${f}')`);
      // true()/false()
      s = s.replace(/\btrue\(\)/gi, 'true').replace(/\bfalse\(\)/gi, 'false');
      // and/or/not
      s = s.replace(/\band\b/gi, '&&').replace(/\bor\b/gi, '||').replace(/\bnot\b/gi, '!');
      // = -> == (hindari >= <= != ==)
      s = s.replace(/([^<>!=])=([^=])/g, '$1==$2');
      return s;
    }

    const compiledCache = new Map();
    function evalRelevant(expr){
      const raw = (expr || '').trim();
      if (!raw) return true;
      if (compiledCache.has(raw)) {
        try { return !!compiledCache.get(raw)(getVal, selected); } catch(e) { return true; }
      }
      const js = toJsExpr(raw);
      let fn;
      try {
        fn = new Function('getVal','selected', `return (${js});`);
      } catch(e) {
        fn = () => true;
      }
      compiledCache.set(raw, fn);
      try { return !!fn(getVal, selected); } catch(e) { return true; }
    }

    // Saat node disembunyikan oleh skip-logic (relevant=false),
    // field required yang tersembunyi bisa memblokir submit.
    // Solusi: disable field yang tersembunyi + matikan required-nya.
    function _rememberRequired(el){
      if (el && el.dataset && el.dataset.origRequired === undefined) {
        el.dataset.origRequired = el.required ? '1' : '0';
      }
    }

    function _setScopeEnabled(scopeEl, enabled){
      if (!scopeEl) return;
      scopeEl.querySelectorAll('input,select,textarea').forEach(inp => {
        _rememberRequired(inp);
        if (!enabled) {
          inp.disabled = true;
          inp.required = false;
        } else {
          inp.disabled = false;
          inp.required = (inp.dataset.origRequired === '1');
        }
      });
    }

    function refreshVisibility(){
      document.querySelectorAll('.relevant-node').forEach(el => {
        const expr = el.getAttribute('data-relevant') || '';
        const ok = evalRelevant(expr);
        el.style.display = ok ? '' : 'none';
        _setScopeEnabled(el, ok);
      });
    }

    document.addEventListener('input', (e) => {
      if (!e.target) return;
      if (e.target.matches('input,select,textarea')) refreshVisibility();
    });
    document.addEventListener('change', (e) => {
      if (!e.target) return;
      if (e.target.matches('input,select,textarea')) refreshVisibility();
    });

    refreshVisibility();
  </script>
</body>
</html>
