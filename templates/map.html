<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Bencana SUMUT - SATGAS USU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <div class="flash-message-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show shadow-lg" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>Perhatian!</strong> {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}
    </div>

    <div id="map-legend" class="bg-white p-2 rounded shadow-sm"
        style="position: absolute; bottom: 30px; left: 15px; z-index: 999; font-size: 12px;">
        <h6 class="mb-2 fw-bold">Status Wilayah</h6>
        <div class="d-flex align-items-center mb-1">
            <span
                style="width:15px; height:15px; background:#ef4444; display:inline-block; margin-right:5px; border-radius:3px;"></span>
            Tanggap Darurat
        </div>
        <div class="d-flex align-items-center mb-1">
            <span
                style="width:15px; height:15px; background:#eab308; display:inline-block; margin-right:5px; border-radius:3px;"></span>
            Siaga Darurat
        </div>
        <div class="d-flex align-items-center">
            <span
                style="width:15px; height:15px; background:#22c55e; display:inline-block; margin-right:5px; border-radius:3px;"></span>
            Normal
        </div>
    </div>
    <div id="map"></div>

    <!-- Tombol Refresh Map -->
    <button id="refreshMapBtn" type="button" class="btn btn-success shadow-sm" 
        style="position: absolute; top: 15px; left: 48px; z-index: 1000; border-radius: 25px;" 
        title="Refresh Data Map">
        <i class="fas fa-sync-alt"></i> Refresh Map
    </button>

    <button id="sidebarToggle" type="button" class="btn btn-light shadow-sm">
        <i class="fas fa-bars"></i>
    </button>

    <div id="sidebar">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0 sidebar-title">MONITORING SATGAS USU</h4>
            <button id="sidebarClose" class="btn btn-close-sidebar d-lg-none" type="button" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        {% if logged_in %}
        <div class="user-profile-card p-3 mb-3 bg-light border rounded-3 d-flex align-items-center gap-3">
            <div class="bg-white p-2 rounded-circle shadow-sm text-success">
                <i class="fas fa-user-circle fa-lg"></i>
            </div>
            <div>
                <small class="text-muted d-block" style="font-size: 0.75rem; line-height: 1;">Relawan Aktif</small>
                <strong class="text-dark">{{ nama_relawan }}</strong>
            </div>
        </div>

        <div class="d-grid gap-2">
            <button class="btn btn-primary feature-btn" data-bs-toggle="modal" data-bs-target="#permintaanModal">
                <i class="fas fa-box"></i> Permintaan Logistik
            </button>
            <button class="btn btn-success feature-btn" data-bs-toggle="modal" data-bs-target="#absensiModal">
                <i class="fas fa-location-dot"></i> Absensi Lokasi
            </button>
            <form action="{{ url_for('logout') }}" method="post" style="display:inline;" id="logoutForm">
                <button type="button" class="btn btn-danger feature-btn w-100" data-bs-toggle="modal" data-bs-target="#logoutConfirmModal"> <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </form>
        </div>
        {% else %}
            <button class="btn btn-primary feature-btn" data-bs-toggle="modal" data-bs-target="#loginModal"><i class="fas fa-sign-in-alt"></i> TAMBAH DATA</button>
        {% endif %}

        <hr>

        <h5><i class="fas fa-warehouse"></i> Stok Gudang Pusat (Posko Logistik USU)</h5>
        <div class="row row-cols-2 g-2 mb-3">
            {% for stok in stok_gudang %}
            {% if stok.get('kode_gudang') == 'G-ME001' and stok.get('nama_barang') %}
            <div class="col">
                <div class="card data-card border-{{ 'danger' if stok.get('stok_akhir')|int <= 0 else 'success' }}">
                    <div class="card-body p-2">
                        <h6 class="card-title mb-0 small text-truncate">{{ stok.get('nama_barang') }}</h6>
                        <p class="card-text mb-0 fw-bold">
                            {% if stok.get('stok_akhir') >= 0 %}
                            {{ stok.get('stok_akhir') }}
                            {% else %}
                            Kurang {{ stok.get('stok_akhir') | abs }}
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <hr>

        <h5><i class="fas fa-chart-bar"></i> Data Bencana & Korban</h5>
        <div class="bencana-carousel-container">
            <div class="bencana-carousel-wrapper">
                <div class="bencana-carousel-track" id="bencanaCarousel">
                    {% for rekap in rekap_kabkota %}
                        {% if (rekap.get('korban_meninggal') or 0) >= 0
                        or (rekap.get('kk_terdampak') or 0) >= 0 %}
                            <div class="bencana-slide mt-2">
                                <div class="card data-card-kabupaten border-danger mb-2">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1 fw-bold">
                                            {{ rekap.get('kabkota') }}
                                        </h6>
                                        <p class="card-text mb-0 small">
                                            <i class="fas fa-skull-crossbones text-danger"></i>
                                            Meninggal: {{ rekap.get('korban_meninggal') or 0 }}
                                            |
                                            <i class="fas fa-home text-warning"></i>
                                            KK Terdampak: {{ rekap.get('kk_terdampak') or 0 }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="bencana-pagination" id="bencanaPagination"></div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="modal fade" id="logoutConfirmModal" tabindex="-1" aria-labelledby="logoutConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="logoutConfirmModalLabel"><i class="fas fa-sign-out-alt"></i> Konfirmasi Logout</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Anda yakin ingin logout?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" id="confirmLogoutBtn">Yakin</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="loginModalLabel"><i class="fas fa-user-lock"></i> Login Relawan SATGAS
                        USU</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form action="{{ url_for('login') }}" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="nama" class="form-label">Nama Relawan</label>
                            <select class="form-select" id="nama" name="nama" required>
                                <option value="">Pilih Nama Anda</option>
                                {% for relawan in relawan_list %}
                                <option value="{{ relawan.get('nama_relawan') }}">{{ relawan.get('nama_relawan') }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="kode_akses" class="form-label">Kode Akses</label>
                            <input type="text" class="form-control" id="kode_akses" name="kode_akses" placeholder="Masukkan Kode Akses" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="permintaanModal" tabindex="-1" aria-labelledby="permintaanModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="permintaanModalLabel"><i class="fas fa-box-open"></i> Input Permintaan
                        Posko</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form action="{{ url_for('submit_permintaan') }}" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="kode_posko" class="form-label"><i class="fas fa-campground"></i> Posko Tujuan</label>
                            <select class="form-select" id="kode_posko" name="kode_posko" required>
                                <option value="">Pilih Posko Tujuan</option>
                                {% for posko in data_posko %}
                                <option value="{{ posko.kode }}">{{ posko.nama }} ({{ posko.kode }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="kode_barang" class="form-label">Kode Barang</label>
                            <select class="form-select" id="kode_barang" name="kode_barang" required>
                                {% for barang in data_barang %}
                                <option value="{{ barang }}">{{ barang }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="jumlah_diminta" class="form-label">Jumlah Diminta</label>
                            <input type="number" class="form-control" id="jumlah_diminta" name="jumlah_diminta" min="1"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="keterangan" class="form-label">Keterangan Tambahan</label>
                            <textarea class="form-control" id="keterangan" name="keterangan" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">Kirim Permintaan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="absensiModal" tabindex="-1" aria-labelledby="absensiModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="absensiModalLabel"><i class="fas fa-map-marker-alt"></i> Absensi Lokasi
                        Relawan</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form action="{{ url_for('submit_absensi') }}" method="POST" id="absensiForm">
                    <div class="modal-body">
                        <div class="mb-3 p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0"><i class="fas fa-map-marker-alt"></i> Lokasi GPS Saat Ini:</label>
                                <button type="button" class="btn btn-success btn-sm shadow-sm" id="refreshLocationBtn" title="Refresh Lokasi" style="border-radius: 20px;">
                                    <i class="fas fa-sync-alt"></i> 
                                </button>
                            </div>
                            <p class="mb-0"><span id="current-location" class="text-primary fw-bold">Mencari
                                    lokasi...</span></p>
                        </div>
                        <input type="hidden" id="absensi_lat" name="latitude" required>
                        <input type="hidden" id="absensi_lon" name="longitude" required>
                        <div class="mb-3">
                            <label for="catatan" class="form-label">Catatan Kegiatan/Kondisi</label>
                            <textarea class="form-control" id="catatan" name="catatan" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-success" id="btn-submit-absensi" disabled>Submit
                            Absensi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Data Lokasi dari Flask
        let dataLokasi = JSON.parse('{{ data_lokasi | safe }}');

        // Inisialisasi Peta
        var map = L.map('map').setView([2.3693, 99.0763], 9); // Koordinat tengah Sumatera Utara

        let statusData = JSON.parse('{{ status_map | safe }}');
        
        // Layer group untuk marker lokasi (agar bisa dihapus saat refresh)
        let markerLayerGroup = L.layerGroup().addTo(map);

        // 2. Fungsi Penentu Warna
        function getColorByStatus(status) {
            if (!status) return '#22c55e'; // Default Hijau
            let s = status.toLowerCase(); // Ubah ke huruf kecil semua

            if (s.includes('tanggap') || s.includes('awas') || s.includes('merah')) {
                return '#ef4444'; // Merah
            } else if (s.includes('siaga') || s.includes('waspada') || s.includes('kuning')) {
                return '#eab308'; // Kuning
            } else {
                return '#22c55e'; // Hijau
            }
        }

        function cleanName(name) {
            if (!name) return "";

            return name.toUpperCase()
                // 1. Buang kata-kata atribut wilayah
                .replace("KABUPATEN", "")
                .replace("KOTA", "")
                .replace("KAB.", "")
                .replace("KAB ", "")

                // 2. HAPUS SEMUA KECUALI HURUF A-Z 
                // (Spasi, titik, koma, strip, angka -> HILANG SEMUA)
                .replace(/[^A-Z]/g, "");
        }

        // ---------------------------------------------------------
        // UPDATE FUNGSI PENCARI DATA (LEBIH PINTAR)
        // ---------------------------------------------------------
        function getFeatureData(feature) {
            // 1. Ambil nama dari GeoJSON (Sesuai file .dbf kamu: 'kabkota')
            let namaAsli = feature.properties.kabkota ||      // <--- INI YANG PALING MUNGKIN BENAR
                feature.properties.KABKOTA ||      // Jaga-jaga kalau huruf besar
                feature.properties.NAMOBJ ||
                feature.properties.WADMKK ||
                "Wilayah";

            // 2. Bersihkan nama dari Peta (misal: "Kab. Karo" -> "KARO")
            let namaGeoClean = cleanName(namaAsli);

            let status = "Normal";

            // 3. Loop data dari Excel/Sheet
            for (let key in statusData) {
                // Bersihkan nama dari Sheet
                let keyClean = cleanName(key);

                // Bandingkan INTINYA SAJA
                if (namaGeoClean === keyClean) {
                    status = statusData[key];
                    break;
                }
            }

            return { nama: namaAsli, status: status };
        }

        // 3. Load Peta
        fetch("{{ url_for('static', filename='data/kabkota_sumut.json') }}")
            .then(res => res.json())
            .then(data => {
                L.geoJSON(data, {
                    // --- STYLE AWAL ---
                    style: function (feature) {
                        // Panggil fungsi pencari data
                        let info = getFeatureData(feature);

                        return {
                            fillColor: getColorByStatus(info.status),
                            weight: 1,
                            opacity: 1,
                            color: 'white',
                            dashArray: '3',
                            fillOpacity: 0.7
                        };
                    },

                    // --- INTERAKSI ---
                    onEachFeature: function (feature, layer) {
                        // Panggil fungsi pencari data LAGI (Pasti hasilnya sama dengan style)
                        let info = getFeatureData(feature);
                        let statusColor = getColorByStatus(info.status);

                        // Badge Class untuk Popup
                        let badgeClass = 'success';
                        let s = info.status.toLowerCase();
                        if (s.includes('tanggap') || s.includes('merah')) badgeClass = 'danger';
                        else if (s.includes('siaga') || s.includes('kuning')) badgeClass = 'warning';

                        // Popup & Tooltip
                        layer.bindTooltip(`<b>${info.nama}</b>: ${info.status}`, { sticky: true, direction: 'top' });
                        layer.bindPopup(`
                        <div class="text-center">
                            <h6 class="mb-1 fw-bold">${info.nama}</h6>
                            <span class="badge bg-${badgeClass}">${info.status}</span>
                        </div>
                    `);

                        // Logic Hover (Frame Effect)
                        layer.on({
                            mouseover: function (e) {
                                var l = e.target;
                                l.setStyle({
                                    weight: 4,              // Frame Tebal
                                    color: statusColor,     // Warna Frame = Warna Status
                                    dashArray: '',          // Garis Solid
                                    fillColor: 'white',     // Isi Putih
                                    fillOpacity: 0.2
                                });
                                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) l.bringToFront();
                            },
                            mouseout: function (e) {
                                var l = e.target;
                                l.setStyle({
                                    weight: 1,              // Reset Tipis
                                    color: 'white',         // Reset Putih
                                    dashArray: '3',         // Reset Putus-putus
                                    fillColor: statusColor, // ISI BALIK KE WARNA ASAL (Kuning/Merah/Hijau)
                                    fillOpacity: 0.7
                                });
                            },
                            click: function (e) { this.openPopup(); }
                        });
                    }
                }).addTo(map);
            })
            .catch(e => console.error("Error GeoJSON:", e));

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Definisi Ikon Kustom dengan Font Awesome
        function getIcon(jenis) {
            let iconClass, iconColor, bgColor;

            if (jenis.includes('Posko')) {
                // Icon Tenda untuk Posko Pengungsian
                iconClass = 'fas fa-campground';
                iconColor = '#ffffff';
                bgColor = '#ef4444'; // Merah
            } else if (jenis.includes('Gudang')) {
                // Icon Gudang
                iconClass = 'fas fa-warehouse';
                iconColor = '#ffffff';
                bgColor = '#10b981'; // Hijau
            } else if (jenis.includes('Rusak') || jenis.includes('Putus') || jenis.includes('Longsor')) {
                iconClass = 'fas fa-exclamation-triangle';
                iconColor = '#ffffff';
                bgColor = '#f59e0b'; // Orange
            } else {
                iconClass = 'fas fa-map-marker-alt';
                iconColor = '#ffffff';
                bgColor = '#3b82f6'; // Biru
            }

            // Buat custom HTML icon dengan Font Awesome
            const iconHtml = `
                <div style="
                    background-color: ${bgColor};
                    width: 40px;
                    height: 40px;
                    border-radius: 50% 50% 50% 0;
                    transform: rotate(-45deg);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                    border: 3px solid white;
                ">
                    <i class="${iconClass}" style="
                        color: ${iconColor};
                        transform: rotate(45deg);
                        font-size: 18px;
                    "></i>
                </div>
            `;

            return L.divIcon({
                html: iconHtml,
                className: 'custom-marker-icon',
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });
        }

        // 4. Fungsi untuk render marker lokasi ke peta
        function renderMarkers(lokasiData) {
            // Hapus marker lama
            markerLayerGroup.clearLayers();
            
            // Tambah marker baru
            lokasiData.forEach(lokasi => {
                const lat = parseFloat(lokasi.latitude);
                const lon = parseFloat(lokasi.longitude);
                if (!isNaN(lat) && !isNaN(lon)) {
                    let icon = getIcon(lokasi.jenis_lokasi);
                    
                    L.marker([lat, lon], { icon: icon })
                        .addTo(markerLayerGroup)
                        .bindPopup(`
                            <strong class="text-primary">${lokasi.jenis_lokasi}</strong><br>
                            ${lokasi.nama_lokasi || lokasi.kabupaten_kota}<br>
                            <small>Kondisi: <b>${lokasi.kondisi_umum || '-'}</b> | Akses: <b>${lokasi.akses || '-'}</b></small>
                        `);
                }
            });
        }

        // Render marker awal
        renderMarkers(dataLokasi);

        // ==============================================================================
        // FUNGSI REFRESH MAP
        // ==============================================================================
        const refreshMapBtn = document.getElementById('refreshMapBtn');
        let isRefreshingMap = false;

        async function refreshMap() {
            if (isRefreshingMap) return;
            
            isRefreshingMap = true;
            const originalHtml = refreshMapBtn.innerHTML;
            refreshMapBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            refreshMapBtn.disabled = true;

            try {
                const response = await fetch('/api/refresh_map');
                const result = await response.json();

                if (result.success) {
                    // Update data
                    dataLokasi = result.data_lokasi;
                    statusData = result.status_map;

                    // Update status wilayah di peta (reload GeoJSON layer)
                    // Hapus layer GeoJSON lama jika ada
                    map.eachLayer(function(layer) {
                        if (layer instanceof L.GeoJSON) {
                            map.removeLayer(layer);
                        }
                    });

                    // Reload GeoJSON dengan status terbaru
                    fetch("{{ url_for('static', filename='data/kabkota_sumut.json') }}")
                        .then(res => res.json())
                        .then(geoData => {
                            L.geoJSON(geoData, {
                                style: function (feature) {
                                    let info = getFeatureData(feature);
                                    return {
                                        fillColor: getColorByStatus(info.status),
                                        weight: 1,
                                        opacity: 1,
                                        color: 'white',
                                        dashArray: '3',
                                        fillOpacity: 0.7
                                    };
                                },
                                onEachFeature: function (feature, layer) {
                                    let info = getFeatureData(feature);
                                    let statusColor = getColorByStatus(info.status);
                                    let badgeClass = 'success';
                                    let s = info.status.toLowerCase();
                                    if (s.includes('tanggap') || s.includes('merah')) badgeClass = 'danger';
                                    else if (s.includes('siaga') || s.includes('kuning')) badgeClass = 'warning';

                                    layer.bindTooltip(`<b>${info.nama}</b>: ${info.status}`, { sticky: true, direction: 'top' });
                                    layer.bindPopup(`
                                        <div class="text-center">
                                            <h6 class="mb-1 fw-bold">${info.nama}</h6>
                                            <span class="badge bg-${badgeClass}">${info.status}</span>
                                        </div>
                                    `);

                                    layer.on({
                                        mouseover: function (e) {
                                            var l = e.target;
                                            l.setStyle({
                                                weight: 4,
                                                color: statusColor,
                                                dashArray: '',
                                                fillColor: 'white',
                                                fillOpacity: 0.2
                                            });
                                            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) l.bringToFront();
                                        },
                                        mouseout: function (e) {
                                            var l = e.target;
                                            l.setStyle({
                                                weight: 1,
                                                color: 'white',
                                                dashArray: '3',
                                                fillColor: statusColor,
                                                fillOpacity: 0.7
                                            });
                                        },
                                        click: function (e) { this.openPopup(); }
                                    });
                                }
                            }).addTo(map);
                        })
                        .catch(e => console.error("Error reloading GeoJSON:", e));

                    // Update marker lokasi
                    renderMarkers(dataLokasi);

                    // Tampilkan notifikasi sukses (centered)
                    showNotification('Map berhasil di-refresh!', 'success', true);
                } else {
                    showNotification('Gagal refresh map: ' + (result.error || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.error('Error refreshing map:', error);
                showNotification('Error saat refresh map. Silakan coba lagi.', 'danger');
            } finally {
                isRefreshingMap = false;
                refreshMapBtn.innerHTML = originalHtml;
                refreshMapBtn.disabled = false;
            }
        }

        refreshMapBtn.addEventListener('click', refreshMap);

        // ==============================================================================
        // FUNGSI NOTIFIKASI
        // ==============================================================================
        function showNotification(message, type = 'info', center = false) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show shadow`;
            if (center) {
                alertDiv.style.cssText = 'position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 10000; min-width: 300px; max-width: 700px; text-align: center;';
            } else {
                alertDiv.style.cssText = 'position: fixed; top: 70px; left: 15px; z-index: 10000; min-width: 300px; max-width: 400px;';
            }
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // ==============================================================================
        // LOGIKA ABSENSI LOKASI RELAWAN (GEOLOCATION API)
        // ==============================================================================
        const btnSubmitAbsensi = document.getElementById('btn-submit-absensi');
        const absensiLat = document.getElementById('absensi_lat');
        const absensiLon = document.getElementById('absensi_lon');
        const currentLocationSpan = document.getElementById('current-location');
        const refreshLocationBtn = document.getElementById('refreshLocationBtn');

        // Fungsi untuk mendapatkan lokasi dengan retry
        function getCurrentLocation(retryCount = 0, onComplete = null) {
            const maxRetries = 3;
            
            if (!navigator.geolocation) {
                currentLocationSpan.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Geolocation tidak didukung browser ini.';
                currentLocationSpan.classList.remove('text-success', 'text-primary');
                currentLocationSpan.classList.add('text-danger');
                btnSubmitAbsensi.disabled = true;
                if (onComplete) onComplete();
                showNotification('Geolocation tidak didukung browser ini.', 'danger');
                return;
            }

            // Opsi geolocation yang lebih fleksibel
            const options = {
                enableHighAccuracy: true,  // Gunakan GPS jika tersedia
                timeout: 30000,            // Timeout 30 detik (lebih lama)
                maximumAge: 0             // Selalu ambil lokasi baru saat refresh
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = position.coords.accuracy; // Akurasi dalam meter
                    
                    // Validasi koordinat
                    if (isNaN(lat) || isNaN(lon) || lat === 0 || lon === 0) {
                        currentLocationSpan.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Koordinat tidak valid.';
                        currentLocationSpan.classList.remove('text-success', 'text-primary');
                        currentLocationSpan.classList.add('text-danger');
                        btnSubmitAbsensi.disabled = true;
                        if (onComplete) onComplete();
                        showNotification('Koordinat tidak valid. Silakan coba lagi.', 'danger');
                        return;
                    }

                    // Simpan koordinat
                    absensiLat.value = lat;
                    absensiLon.value = lon;
                    
                    // Tampilkan informasi lokasi
                    currentLocationSpan.innerHTML = `
                        <i class="fas fa-check-circle"></i> Lokasi ditemukan!<br>
                        <small>Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}<br>
                        Akurasi: ±${Math.round(accuracy)}m</small>
                    `;
                    currentLocationSpan.classList.remove('text-danger', 'text-primary');
                    currentLocationSpan.classList.add('text-success');
                    btnSubmitAbsensi.disabled = false;
                    
                    // Tampilkan notifikasi sukses (centered)
                    showNotification(`Lokasi berhasil diperbarui! Akurasi: ±${Math.round(accuracy)}m`, 'success', true);
                    
                    if (onComplete) onComplete();
                    console.log('Lokasi berhasil:', { lat, lon, accuracy });
                },
                (error) => {
                    let errorMessage = '';
                    let shouldRetry = false;
                    let notificationMsg = '';

                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '<i class="fas fa-ban"></i> Akses lokasi ditolak. Silakan izinkan akses lokasi di pengaturan browser.';
                            notificationMsg = 'Akses lokasi ditolak. Silakan izinkan akses lokasi di pengaturan browser.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '<i class="fas fa-question-circle"></i> Informasi lokasi tidak tersedia.';
                            notificationMsg = 'Informasi lokasi tidak tersedia.';
                            shouldRetry = retryCount < maxRetries;
                            break;
                        case error.TIMEOUT:
                            errorMessage = '<i class="fas fa-clock"></i> Waktu tunggu habis. Mencoba lagi...';
                            notificationMsg = 'Waktu tunggu habis. Mencoba lagi...';
                            shouldRetry = retryCount < maxRetries;
                            break;
                        default:
                            errorMessage = '<i class="fas fa-exclamation-triangle"></i> Error tidak diketahui saat mengambil lokasi.';
                            notificationMsg = 'Error saat mengambil lokasi.';
                            shouldRetry = retryCount < maxRetries;
                            break;
                    }

                    currentLocationSpan.innerHTML = errorMessage;
                    currentLocationSpan.classList.remove('text-success', 'text-primary');
                    currentLocationSpan.classList.add('text-danger');
                    btnSubmitAbsensi.disabled = true;
                    
                    console.error('Geolocation error:', {
                        code: error.code,
                        message: error.message,
                        retryCount: retryCount
                    });

                    // Retry jika memungkinkan
                    if (shouldRetry) {
                        setTimeout(() => {
                            currentLocationSpan.innerHTML = `<i class="fas fa-sync fa-spin"></i> Mencoba lagi... (${retryCount + 1}/${maxRetries})`;
                            getCurrentLocation(retryCount + 1, onComplete);
                        }, 2000);
                    } else {
                        if (retryCount >= maxRetries) {
                            currentLocationSpan.innerHTML = `
                                <i class="fas fa-exclamation-triangle"></i> Gagal mengambil lokasi setelah ${maxRetries} percobaan.<br>
                                <small>Pastikan GPS aktif dan izin lokasi sudah diberikan.</small>
                            `;
                            notificationMsg = `Gagal mengambil lokasi setelah ${maxRetries} percobaan. Pastikan GPS aktif dan izin lokasi sudah diberikan.`;
                        }
                        if (onComplete) onComplete();
                        if (notificationMsg) {
                            showNotification(notificationMsg, 'danger');
                        }
                    }
                },
                options
            );
        }

        // Event listener untuk tombol refresh lokasi
        if (refreshLocationBtn) {
            refreshLocationBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Tampilkan loading state
                const originalHtml = refreshLocationBtn.innerHTML;
                refreshLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                refreshLocationBtn.disabled = true;
                
                // Update status lokasi
                currentLocationSpan.innerHTML = '<i class="fas fa-sync fa-spin"></i> Mencari lokasi...';
                currentLocationSpan.classList.remove('text-success', 'text-danger');
                currentLocationSpan.classList.add('text-primary');
                
                // Reset koordinat
                absensiLat.value = '';
                absensiLon.value = '';
                btnSubmitAbsensi.disabled = true;
                
                // Panggil fungsi getCurrentLocation dengan callback untuk restore button
                getCurrentLocation(0, function() {
                    // Restore button setelah selesai
                    refreshLocationBtn.innerHTML = originalHtml;
                    refreshLocationBtn.disabled = false;
                });
            });
        }

        // Panggil Geolocation saat modal absensi dibuka
        document.getElementById('absensiModal').addEventListener('show.bs.modal', function () {
            currentLocationSpan.innerHTML = '<i class="fas fa-sync fa-spin"></i> Mencari lokasi...';
            currentLocationSpan.classList.remove('text-success', 'text-danger');
            currentLocationSpan.classList.add('text-primary');
            btnSubmitAbsensi.disabled = true;
            
            // Reset nilai koordinat
            absensiLat.value = '';
            absensiLon.value = '';
            
            // Mulai proses mendapatkan lokasi
            getCurrentLocation();
        });

        // Validasi form sebelum submit
        document.getElementById('absensiForm').addEventListener('submit', function(e) {
            const lat = absensiLat.value;
            const lon = absensiLon.value;
            
            if (!lat || !lon || lat === '' || lon === '') {
                e.preventDefault();
                currentLocationSpan.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Lokasi belum ditemukan. Silakan tunggu atau refresh halaman.';
                currentLocationSpan.classList.remove('text-success', 'text-primary');
                currentLocationSpan.classList.add('text-danger');
                btnSubmitAbsensi.disabled = true;
                
                // Coba lagi mendapatkan lokasi
                getCurrentLocation();
                return false;
            }
            
            // Validasi koordinat valid (bukan 0,0)
            if (parseFloat(lat) === 0 && parseFloat(lon) === 0) {
                e.preventDefault();
                currentLocationSpan.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Koordinat tidak valid. Silakan coba lagi.';
                currentLocationSpan.classList.remove('text-success', 'text-primary');
                currentLocationSpan.classList.add('text-danger');
                btnSubmitAbsensi.disabled = true;
                return false;
            }
        });

        // Carousel untuk Data Bencana & Korban
        (function () {
            const carousel = document.getElementById('bencanaCarousel');
            const pagination = document.getElementById('bencanaPagination');

            if (!carousel || !pagination) return;

            const slides = carousel.querySelectorAll('.bencana-slide');
            const totalSlides = slides.length;

            if (totalSlides === 0) return;

            let currentIndex = 0;

            // --- LOGIKA PAGINATION DOTS ---
            for (let i = 0; i < totalSlides; i++) {
                const dot = document.createElement('button');
                dot.className = 'bencana-pagination-dot';
                if (i === 0) dot.classList.add('active');
                dot.setAttribute('aria-label', `Slide ${i + 1}`);
                dot.addEventListener('click', () => {
                    goToSlide(i);
                    stopAutoPlay(); // Reset timer saat user interaksi manual
                    startAutoPlay();
                });
                pagination.appendChild(dot);
            }

            // --- FUNGSI PINDAH SLIDE UTAMA ---
            function goToSlide(index) {
                // Logika looping (infinite loop effect)
                if (index < 0) {
                    index = totalSlides - 1; // Ke slide terakhir
                } else if (index >= totalSlides) {
                    index = 0; // Ke slide pertama
                }

                currentIndex = index;
                carousel.style.transform = `translateX(-${index * 100}%)`;

                // Update active dot
                const dots = pagination.querySelectorAll('.bencana-pagination-dot');
                dots.forEach((dot, i) => {
                    dot.classList.toggle('active', i === index);
                });
            }

            // --- AUTO PLAY ---
            let autoPlayInterval;
            function startAutoPlay() {
                stopAutoPlay();
                autoPlayInterval = setInterval(() => {
                    const nextIndex = currentIndex + 1;
                    goToSlide(nextIndex);
                }, 4000);
            }

            function stopAutoPlay() {
                if (autoPlayInterval) {
                    clearInterval(autoPlayInterval);
                }
            }

            if (totalSlides > 1) {
                startAutoPlay();
                const container = carousel.closest('.bencana-carousel-container');
                if (container) {
                    container.addEventListener('mouseenter', stopAutoPlay);
                    container.addEventListener('mouseleave', startAutoPlay);
                }
            }
        })();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
            const logoutForm = document.getElementById('logoutForm');
            if (confirmLogoutBtn && logoutForm) {
                confirmLogoutBtn.addEventListener('click', function () {
                    const modalEl = document.getElementById('logoutConfirmModal');
                    const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                    modal.hide();
                    logoutForm.submit();
                });
            }
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggle');
            const closeBtn = document.getElementById('sidebarClose');

            // 1. Fungsi Buka Sidebar
            toggleBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                e.preventDefault();
                sidebar.classList.add('active');
                toggleBtn.style.visibility = 'hidden';
            });

            // 2. Fungsi Tutup Sidebar (Tombol X)
            closeBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                sidebar.classList.remove('active');
                setTimeout(() => {
                    toggleBtn.style.visibility = 'visible';
                }, 300);
            });

            // 3. Logic Tutup Sidebar saat klik di luar (Global Click)
            document.addEventListener('click', function (e) {
                if (sidebar.classList.contains('active')) {
                    
                    const clickInsideSidebar = sidebar.contains(e.target);
                    const clickToggle = toggleBtn.contains(e.target);
                    const clickInsideModal = e.target.closest('.modal-content');
                    if (!clickInsideSidebar && !clickToggle && !clickInsideModal) {
                        sidebar.classList.remove('active');
                        setTimeout(() => {
                            toggleBtn.style.visibility = 'visible';
                        }, 300);
                    }
                }
            });
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function (alert) {
                setTimeout(function () {
                    let bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 3000);
            });
        });
    </script>
</body>

</html>