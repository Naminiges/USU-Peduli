<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Peta Bencana SUMUT - SATGAS USU</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <style>
      /* Global loading overlay shown during form POSTs */
      #globalLoadingOverlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 11000; /* above modals */
        align-items: center;
        justify-content: center;
      }
      #globalLoadingOverlay .card {
        background: rgba(255, 255, 255, 0.98);
        padding: 1rem 1.25rem;
        border-radius: 8px;
        display: flex;
        gap: 0.75rem;
        align-items: center;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>

  <body>
    <!-- Global loading overlay shown during POST -->
    <div id="globalLoadingOverlay" role="status" aria-hidden="true">
      <div class="card">
        <div
          class="spinner-border text-primary"
          role="status"
          aria-hidden="true"
          style="width: 2rem; height: 2rem"
        ></div>
        <div>
          <div class="small text-muted loading-text">Mohon tunggu.</div>
        </div>
      </div>
    </div>
    <div class="flash-message-container">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="alert alert-{{ category }} alert-dismissible fade show shadow-lg"
        role="alert"
      >
        <i class="fas fa-exclamation-circle me-2"></i>
        <strong>Perhatian!</strong> {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      {% endfor %} {% endif %} {% endwith %}
    </div>

    <div
      id="map-legend"
      class="bg-white p-2 rounded shadow-sm"
      style="
        position: absolute;
        bottom: 30px;
        left: 15px;
        z-index: 999;
        font-size: 12px;
      "
    >
      <h6 class="mb-2 fw-bold">Status Wilayah</h6>
      <div class="d-flex align-items-center mb-1">
        <span
          style="
            width: 15px;
            height: 15px;
            background: #ef4444;
            display: inline-block;
            margin-right: 5px;
            border-radius: 3px;
          "
        ></span>
        Tanggap Darurat
      </div>
      <div class="d-flex align-items-center mb-1">
        <span
          style="
            width: 15px;
            height: 15px;
            background: #eab308;
            display: inline-block;
            margin-right: 5px;
            border-radius: 3px;
          "
        ></span>
        Siaga Darurat
      </div>
      <div class="d-flex align-items-center">
        <span
          style="
            width: 15px;
            height: 15px;
            background: #22c55e;
            display: inline-block;
            margin-right: 5px;
            border-radius: 3px;
          "
        ></span>
        Normal
      </div>
    </div>
    <div id="map"></div>

    <!-- Tombol Refresh Map -->
    <button
      id="refreshMapBtn"
      type="button"
      class="btn btn-success shadow-sm"
      style="
        position: absolute;
        top: 15px;
        left: 48px;
        z-index: 1000;
        border-radius: 25px;
      "
      title="Refresh Data Map"
    >
      <i class="fas fa-sync-alt"></i> Refresh Map
    </button>

    <button id="sidebarToggle" type="button" class="btn btn-light shadow-sm">
      <i class="fas fa-bars"></i>
    </button>

    <div id="sidebar">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 sidebar-title">MONITORING SATGAS USU</h4>
        <button
          id="sidebarClose"
          class="btn btn-close-sidebar d-lg-none"
          type="button"
          aria-label="Close"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      {% if logged_in %}
      <div
        class="user-profile-card p-3 mb-3 bg-light border rounded-3 d-flex align-items-center gap-3"
      >
        <div class="bg-white p-2 rounded-circle shadow-sm text-success">
          <i class="fas fa-user-circle fa-lg"></i>
        </div>
        <div>
          <small
            class="text-muted d-block"
            style="font-size: 0.75rem; line-height: 1"
            >Relawan Aktif</small
          >
          <strong class="text-dark">{{ nama_relawan }}</strong>
        </div>
      </div>

      <div class="d-grid gap-2">
        <button
          class="btn btn-primary feature-btn"
          data-bs-toggle="modal"
          data-bs-target="#permintaanModal"
        >
          <i class="fas fa-box"></i> Permintaan Logistik
        </button>
        <button
          class="btn btn-success feature-btn"
          data-bs-toggle="modal"
          data-bs-target="#absensiModal"
        >
          <i class="fas fa-location-dot"></i> Absensi Lokasi
        </button>
        {#Tambah Untuk Asesmen Kesehatan#}
        <button
          class="btn btn-success feature-btn"
          data-bs-toggle="modal"
          data-bs-target="#asesmenKesehatanModal"
        >
          <i class="fas fa-heartbeat me-2"></i> Asesmen Kesehatan
        </button>
        {#Tambah Untuk Asesmen Pendidikan#}
        <button
          class="btn btn-success feature-btn"
          data-bs-toggle="modal"
          data-bs-target="#asesmenPendidikanModal"
        >
          <i class="fas fa-graduation-cap me-2"></i> Asesmen Pendidikan
        </button>
        <!-- ================== FILTER ASESMEN (CHECKLIST) ================== -->
        <div class="p-2 bg-light rounded-3 mb-3">
          <div class="fw-bold mb-2">
            <i class="fas fa-layer-group me-2"></i>Asesmen
          </div>

          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="toggleAsesmenKesehatan"
              checked
            />
            <label class="form-check-label" for="toggleAsesmenKesehatan">
              Asesmen Kesehatan
            </label>
          </div>

          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="toggleAsesmenPendidikan"
              checked
            />
            <label class="form-check-label" for="toggleAsesmenPendidikan">
              Asesmen Pendidikan
            </label>
          </div>
        </div>
        <!-- =============================================================== -->
        <form
          action="{{ url_for('logout') }}"
          method="post"
          style="display: inline"
          id="logoutForm"
        >
          <button
            type="button"
            class="btn btn-danger feature-btn w-100"
            data-bs-toggle="modal"
            data-bs-target="#logoutConfirmModal"
          >
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </form>
      </div>
      {% else %}
      <button
        class="btn btn-primary feature-btn"
        data-bs-toggle="modal"
        data-bs-target="#loginModal"
      >
        <i class="fas fa-sign-in-alt"></i> TAMBAH DATA
      </button>
      {% endif %}

      <hr />

<div class="d-flex align-items-center mb-3 mt-4">
    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2 shadow-sm" style="width: 32px; height: 32px;">
        <i class="fas fa-truck-fast" style="font-size: 0.9rem;"></i>
    </div>
    <h5 class="mb-0 text-dark fw-bold">Pengiriman Logistik</h5>
</div>

<div class="accordion" id="accordionLogistik">
    
    {% for group in data_distribusi %}
        {% set card_id = "logistik" ~ loop.index %}
        
        <div class="accordion-item border-0 shadow-sm mb-3" style="border-radius: 10px; overflow: hidden;">
            
            <h2 class="accordion-header" id="heading{{ card_id }}">
                <button class="accordion-button collapsed bg-white py-3 px-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ card_id }}" aria-expanded="false" style="box-shadow: none;">
                    
                    <div class="w-100">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="fw-bold text-dark" style="font-size: 1rem;">
                                {{ group.header.nama }}
                            </div>
                            <span class="badge bg-light text-secondary border rounded-pill" style="font-weight: normal;">
                                <i class="far fa-calendar me-1"></i> {{ group.header.tanggal }}
                            </span>
                        </div>

                        <div class="text-muted small mt-1">
                            <i class="fas fa-map-pin text-danger me-1"></i> {{ group.header.daerah }}
                        </div>
                    </div>

                </button>
            </h2>

            <div id="collapse{{ card_id }}" class="accordion-collapse collapse" data-bs-parent="#accordionLogistik">
                <div class="accordion-body bg-light p-0">
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless mb-0">
                            <thead class="text-secondary small border-bottom">
                                <tr>
                                    <th class="ps-4 py-2">Barang</th>
                                    <th class="text-center py-2">Jml</th>
                                    <th class="text-end pe-4 py-2">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in group.items %}
                                <tr class="border-bottom border-light">
                                    <td class="ps-4 align-middle">
                                        <div class="fw-bold text-dark">{{ item.deskripsi }}</div>
                                    </td>
                                    <td class="text-center align-middle">
                                        <span class="fw-bold text-primary">{{ item.jumlah }}</span>
                                        <small class="text-muted">{{ item.satuan }}</small>
                                    </td>
                                    <td class="text-end pe-4 align-middle">
                                        {% if item.status == 'Selesai' %}
                                            <i class="fas fa-check-circle text-success" title="Selesai"></i>
                                        {% else %}
                                            <span class="badge bg-warning text-dark" style="font-size: 0.7rem;">{{ item.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="p-2 text-center text-muted small fst-italic bg-white border-top">
                        Total {{ group.items|length }} jenis barang dikirim.
                    </div>

                </div>
            </div>
        </div>
    {% else %}
        <div class="text-center py-5 text-muted bg-light rounded border border-dashed">
            <i class="fas fa-box-open fa-2x mb-3 opacity-25"></i>
            <p class="mb-0 small">Belum ada data pengiriman.</p>
        </div>
    {% endfor %}

</div>

      <hr />

      <h5><i class="fas fa-chart-bar"></i> Data Bencana & Korban</h5>
      <div class="d-flex align-items-center mb-3 gap-2">
        <div class="input-group" style="max-width: 250px">
          <span class="input-group-text bg-white"
            ><i class="fas fa-calendar-alt text-primary"></i
          ></span>
          <input
            type="date"
            id="filterTanggal"
            class="form-control form-control-sm"
          />
        </div>
        <button
          class="btn btn-sm btn-outline-secondary"
          onclick="resetFilter()"
        >
          <i class="fas fa-sync-alt"></i> Reset
        </button>
      </div>
      <div class="bencana-scroll-container mt-2">
    <div id="bencanaListTrack"> 
        
        {% for rekap in rekap_kabkota %}
            {% if (rekap.get('korban_meninggal')|int > 0) or 
                  (rekap.get('korban_hilang')|int > 0) or 
                  (rekap.get('mengungsi')|int > 0) %}
                
                <div class="filter-item mb-3" 
                     data-tanggal="{{ rekap.get('tanggal_iso') }}">
                     
                    <div class="card border-0 shadow-sm" style="border-left: 5px solid #dc3545; border-radius: 8px;">
                        <div class="card-body p-3">
                            
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h6 class="fw-bold text-dark mb-0" style="line-height: 1.2;">
                                    {{ rekap.get('kabkota') }}
                                </h6>
                                <span class="badge bg-light text-secondary border">
                                    {{ rekap.get('tanggal') }}
                                </span>
                            </div>

                            <div class="row g-2">
                                <div class="col-4">
                                    <div class="stat-box bg-red-soft">
                                        <i class="fas fa-skull-crossbones mb-1 d-block" style="font-size: 14px;"></i>
                                        <div class="fw-bold" style="font-size: 16px;">{{ rekap.get('korban_meninggal') }}</div>
                                        <small style="font-size: 10px; text-transform: uppercase;">Meninggal</small>
                                    </div>
                                </div>
                                
                                <div class="col-4">
                                    <div class="stat-box bg-orange-soft">
                                        <i class="fas fa-search mb-1 d-block" style="font-size: 14px;"></i>
                                        <div class="fw-bold" style="font-size: 16px;">{{ rekap.get('korban_hilang') }}</div>
                                        <small style="font-size: 10px; text-transform: uppercase;">Hilang</small>
                                    </div>
                                </div>

                                <div class="col-4">
                                    <div class="stat-box bg-blue-soft">
                                        <i class="fas fa-person-shelter mb-1 d-block" style="font-size: 14px;"></i>
                                        <div class="fw-bold" style="font-size: 16px;">{{ rekap.get('mengungsi') }}</div>
                                        <small style="font-size: 10px; text-transform: uppercase;">Pengungsi</small>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-2 text-end">
                                <small class="text-muted fst-italic" style="font-size: 0.75rem;">
                                    Sumber: {{ rekap.get('sumber_info') }}
                                </small>
                            </div>

                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}

        <div id="noDataMessage" class="text-center w-100 py-4 text-muted" style="display: none;">
            <div class="mb-2">
                <i class="fas fa-folder-open fa-2x text-secondary opacity-50"></i>
            </div>
            <small>Tidak ada pencatatan data pada tanggal ini.</small>
        </div>

    </div>
</div>
        </div>
        <div class="bencana-pagination" id="bencanaPagination"></div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div
      class="modal fade"
      id="logoutConfirmModal"
      tabindex="-1"
      aria-labelledby="logoutConfirmModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="logoutConfirmModalLabel">
              <i class="fas fa-sign-out-alt"></i> Konfirmasi Logout
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p class="mb-0">Anda yakin ingin logout?</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal
            </button>
            <button type="button" class="btn btn-danger" id="confirmLogoutBtn">
              Yakin
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="loginModal"
      tabindex="-1"
      aria-labelledby="loginModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="loginModalLabel">
              <i class="fas fa-user-lock"></i> Login Relawan SATGAS USU
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form action="{{ url_for('login') }}" method="POST">
            <div class="modal-body">
              <div class="mb-3">
                <label for="nama" class="form-label">Nama Relawan</label>
                <select class="form-select" id="nama" name="nama" required>
                  <option value="">Pilih Nama Anda</option>
                  {% for relawan in relawan_list %}
                  <option value="{{ relawan.get('nama_relawan') }}">
                    {{ relawan.get('nama_relawan') }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label for="kode_akses" class="form-label">Kode Akses</label>
                <input
                  type="text"
                  class="form-control"
                  id="kode_akses"
                  name="kode_akses"
                  placeholder="Masukkan Kode Akses"
                  required
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button type="submit" class="btn btn-primary">Login</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="permintaanModal"
      tabindex="-1"
      aria-labelledby="permintaanModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="permintaanModalLabel">
              <i class="fas fa-box-open"></i> Input Permintaan Posko
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form action="{{ url_for('submit_permintaan') }}" method="POST">
            <div class="modal-body">
              <div class="mb-3">
                <label for="kode_posko" class="form-label"
                  ><i class="fas fa-campground"></i> Posko Tujuan</label
                >
                <select
                  class="form-select"
                  id="kode_posko"
                  name="kode_posko"
                  required
                >
                  <option value="">Pilih Posko Tujuan</option>
                  {% for posko in data_posko %}
                  <option value="{{ posko.kode }}">
                    {{ posko.nama }} ({{ posko.kode }})
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label for="kode_barang" class="form-label">Kode Barang</label>
                <select
                  class="form-select"
                  id="kode_barang"
                  name="kode_barang"
                  required
                >
                  {% for barang in data_barang %}
                  <option value="{{ barang }}">{{ barang }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label for="jumlah_diminta" class="form-label"
                  >Jumlah Diminta</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="jumlah_diminta"
                  name="jumlah_diminta"
                  min="1"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="keterangan" class="form-label"
                  >Keterangan Tambahan</label
                >
                <textarea
                  class="form-control"
                  id="keterangan"
                  name="keterangan"
                  rows="2"
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button type="submit" class="btn btn-primary">
                Kirim Permintaan
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="absensiModal"
      tabindex="-1"
      aria-labelledby="absensiModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="absensiModalLabel">
              <i class="fas fa-map-marker-alt"></i> Absensi Lokasi Relawan
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form
            action="{{ url_for('submit_absensi') }}"
            method="POST"
            id="absensiForm"
          >
            <div class="modal-body">
              <div class="mb-3 p-3 bg-light rounded">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <label class="form-label mb-0"
                    ><i class="fas fa-map-marker-alt"></i> Lokasi GPS Saat
                    Ini:</label
                  >
                  <button
                    type="button"
                    class="btn btn-success btn-sm shadow-sm"
                    id="refreshLocationBtn"
                    title="Refresh Lokasi"
                    style="border-radius: 20px"
                  >
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
                <p class="mb-0">
                  <span id="current-location" class="text-primary fw-bold"
                    >Mencari lokasi...</span
                  >
                </p>
                <div class="mt-3">
                  <small class="text-muted d-block mb-2">
                    <i class="fas fa-map"></i> Koreksi titik: geser pin atau
                    klik peta sebelum submit.
                  </small>
                  <div
                    id="absensiMiniMap"
                    style="
                      height: 230px;
                      border-radius: 12px;
                      overflow: hidden;
                      border: 1px solid #e5e7eb;
                    "
                  ></div>
                </div>
              </div>
              <input type="hidden" id="absensi_lat" name="latitude" required />
              <input type="hidden" id="absensi_lon" name="longitude" required />
              <div class="mb-3">
                <label for="catatan" class="form-label"
                  >Catatan Kegiatan/Kondisi</label
                >
                <textarea
                  class="form-control"
                  id="catatan"
                  name="catatan"
                  rows="3"
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="submit"
                class="btn btn-success"
                id="btn-submit-absensi"
                disabled
              >
                Submit Absensi
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===================== MODAL ASESMEN KESEHATAN ===================== -->
    <div
      class="modal fade"
      id="asesmenKesehatanModal"
      tabindex="-1"
      aria-labelledby="asesmenKesehatanLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form
            method="POST"
            action="{{ url_for('submit_asesmen_kesehatan') }}"
          >
            <div class="modal-header">
              <h5 class="modal-title" id="asesmenKesehatanLabel">
                Asesmen Kesehatan
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <!-- Lokasi GPS Saat Ini (Asesmen Kesehatan) -->
              <div class="mb-3 p-3 bg-light rounded">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <div class="fw-bold">
                    <i class="fas fa-map-marker-alt"></i> Lokasi GPS Saat Ini:
                  </div>
                  <button
                    type="button"
                    id="refreshKesehatanLocationBtn"
                    class="btn btn-success btn-sm shadow-sm"
                    title="Refresh Lokasi"
                    style="border-radius: 20px"
                    onclick="getLocationForAsesmen('kesehatan')"
                  >
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>

                <div class="text-success fw-bold">
                  <span id="kesehatan-location-text">belum diambil</span>
                </div>
              </div>

              <input type="hidden" id="kesehatan_lat" name="latitude" />
              <input type="hidden" id="kesehatan_lon" name="longitude" />
              <div class="mb-2 text-muted small">
                <i class="fas fa-map me-1"></i>
                Koreksi titik: geser pin atau klik peta sebelum submit.
              </div>
              <div
                id="kesehatanMiniMap"
                style="
                  height: 220px;
                  border-radius: 12px;
                  overflow: hidden;
                  border: 1px solid #e5e7eb;
                "
              ></div>
              <div class="mb-3">
                <label class="form-label">Pilih Posko</label>
                <select class="form-select" name="kode_posko" required>
                  <option value="" selected disabled>-- pilih posko --</option>
                  {% for p in data_posko %}
                  <option value="{{ p.kode }}">
                    {{ p.kode }} - {{ p.nama }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <div class="mb-2">
                <small class="text-muted">
                  Skala penilaian: 1 Sangat Baik, 2 Baik, 3 Cukup, 4 Kurang, 5
                  Sangat Kurang.
                </small>
              </div>

              <!-- 5 pertanyaan skala 1-5 -->
              {% set kesehatan_questions = [ "1. Ada pengungsi sakit/cedera yang
              butuh penanganan segera?", "2. Ketersediaan obat-obatan dan P3K
              mencukupi?", "3. Ketersediaan tenaga medis (dokter/perawat/bidan)
              di posko?", "4. Ketersediaan air bersih untuk kebutuhan minum &
              kebersihan?", "5. Sanitasi/toilet dan pengelolaan limbah di posko
              memadai?", ] %} {% for i in range(1,6) %}
              <div class="mb-3">
                <label class="form-label">{{ kesehatan_questions[i-1] }}</label>
                <select class="form-select" name="p{{ i }}" required>
                  <option value="1">1 - Sangat Baik</option>
                  <option value="2">2 - Baik</option>
                  <option value="3" selected>3 - Cukup</option>
                  <option value="4">4 - Kurang</option>
                  <option value="5">5 - Sangat Kurang</option>
                </select>
              </div>
              {% endfor %}

              <div class="mb-3">
                <label class="form-label">Catatan (opsional)</label>
                <textarea
                  class="form-control"
                  name="catatan"
                  rows="3"
                ></textarea>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="submit"
                class="btn btn-success"
                id="btn-submit-kesehatan"
                disabled
              >
                Submit
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===================== MODAL ASESMEN PENDIDIKAN ===================== -->
    <div
      class="modal fade"
      id="asesmenPendidikanModal"
      tabindex="-1"
      aria-labelledby="asesmenPendidikanLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form
            method="POST"
            action="{{ url_for('submit_asesmen_pendidikan') }}"
          >
            <div class="modal-header">
              <h5 class="modal-title" id="asesmenPendidikanLabel">
                Asesmen Pendidikan
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <!-- Lokasi GPS Saat Ini (Asesmen Pendidikan) -->
              <div class="mb-3 p-3 bg-light rounded">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <div class="fw-bold">
                    <i class="fas fa-map-marker-alt"></i> Lokasi GPS Saat Ini:
                  </div>
                  <button
                    type="button"
                    id="refreshPendidikanLocationBtn"
                    class="btn btn-success btn-sm shadow-sm"
                    title="Refresh Lokasi"
                    style="border-radius: 20px"
                    onclick="getLocationForAsesmen('pendidikan')"
                  >
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>

                <div class="text-success fw-bold">
                  <span id="pendidikan-location-text">belum diambil</span>
                </div>
              </div>

              <input type="hidden" id="pendidikan_lat" name="latitude" />
              <input type="hidden" id="pendidikan_lon" name="longitude" />
              <div class="mb-2 text-muted small">
                <i class="fas fa-map me-1"></i>
                Koreksi titik: geser pin atau klik peta sebelum submit.
              </div>
              <div
                id="pendidikanMiniMap"
                style="
                  height: 220px;
                  border-radius: 12px;
                  overflow: hidden;
                  border: 1px solid #e5e7eb;
                "
              ></div>

              <div class="mb-3">
                <label class="form-label">Pilih Posko</label>
                <select class="form-select" name="kode_posko" required>
                  <option value="" selected disabled>-- pilih posko --</option>
                  {% for p in data_posko %}
                  <option value="{{ p.kode }}">
                    {{ p.kode }} - {{ p.nama }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <!-- 10 pertanyaan skala 1-5 -->
              {% set pendidikan_questions = [ "1. Ruang belajar sementara
              tersedia dan layak digunakan?", "2. Anak usia sekolah terdata dan
              sudah terlayani kegiatan belajar?", "3. Ada tenaga
              pengajar/relawan pendidikan yang mendampingi?", "4. Alat tulis dan
              bahan ajar tersedia?", "5. Akses listrik/charging memadai untuk
              mendukung kegiatan belajar?", "6. Keamanan area belajar (aman dari
              risiko) terjaga?", "7. Jadwal/kegiatan belajar rutin berjalan?",
              "8. Dukungan psikososial anak (trauma/stres) tersedia/terhubung?",
              "9. Fasilitas sanitasi ramah anak memadai?", "10. Kebutuhan
              prioritas pendidikan sudah diidentifikasi dan ditindaklanjuti?", ]
              %} {% for i in range(1,11) %}
              <div class="mb-3">
                <label class="form-label"
                  >{{ pendidikan_questions[i-1] }}</label
                >
                <select class="form-select" name="p{{ i }}" required>
                  <option value="1">1 - Sangat Baik</option>
                  <option value="2">2 - Baik</option>
                  <option value="3" selected>3 - Cukup</option>
                  <option value="4">4 - Kurang</option>
                  <option value="5">5 - Sangat Kurang</option>
                </select>
              </div>
              {% endfor %}

              <div class="mb-3">
                <label class="form-label">Catatan (opsional)</label>
                <textarea
                  class="form-control"
                  name="catatan"
                  rows="3"
                ></textarea>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="submit"
                class="btn btn-success"
                id="btn-submit-pendidikan"
                disabled
              >
                Submit
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
              // Data Lokasi dari Flask
              let dataLokasi = {{ data_lokasi | safe }};
              let relawanLokasi = {{ relawan_lokasi | safe }};
              let asesmenKesehatan = {{ asesmen_kesehatan | safe }};
      let asesmenPendidikan = {{ asesmen_pendidikan | safe }};


              // Inisialisasi Peta
              var map = L.map('map').setView([2.3693, 99.0763], 9); // Koordinat tengah Sumatera Utara

              // ================== PANE LAYER (URUTAN Z) ==================
              // Kab/Kota di bawah, buffer asesmen di atas (agar buffer bisa diklik)
              map.createPane('kabkotaPane');
              map.getPane('kabkotaPane').style.zIndex = 350;

              map.createPane('asesmenPane');
              map.getPane('asesmenPane').style.zIndex = 450;
              // ============================================================

              let statusData = JSON.parse('{{ status_map | safe }}');

              // Layer group untuk marker lokasi (agar bisa dihapus saat refresh)
              let markerLayerGroup = L.layerGroup().addTo(map);
              let relawanLayerGroup = L.layerGroup().addTo(map);
              // ================== LAYER ASESMEN (BUFFER 2KM) ==================
      let asesmenKesehatanLayer = L.layerGroup().addTo(map);
      let asesmenPendidikanLayer = L.layerGroup().addTo(map);


      // Map pertanyaan p1..px (untuk popup buffer)
      const ASESMEN_QUESTIONS = {
        kesehatan: {{ kesehatan_questions | tojson | safe }},
        pendidikan: {{ pendidikan_questions | tojson | safe }},
      };

      function escapeHtml(s){
        return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      }

      function formatWIB(ts){
        if (!ts) return "-";
        const d = new Date(ts);
        if (isNaN(d)) return escapeHtml(ts);
        const out = new Intl.DateTimeFormat("id-ID", {
          timeZone: "Asia/Jakarta",
          year:"numeric", month:"2-digit", day:"2-digit",
          hour:"2-digit", minute:"2-digit", second:"2-digit"
        }).format(d);
        return out.replace(",", "") + " WIB";
      }

      function statusColor(status){
        const s = String(status || "").toLowerCase();
        if (s.includes("kritis")) return "#ef4444";
        if (s.includes("waspada")) return "#f59e0b";
        if (s.includes("aman")) return "#22c55e";
        return "#3b82f6";
      }

      function jawabanHtml(j, kind){
        if (!j) return "<div class='text-muted'>-</div>";

        let obj = j;
        if (typeof obj === "string") {
          try { obj = JSON.parse(obj); } catch(e) { return `<pre class="mb-0">${escapeHtml(obj)}</pre>`; }
        }

        const keys = Object.keys(obj || {});
        keys.sort((a,b)=>{
          const na = parseInt(String(a).replace(/\D/g,"") || "0",10);
          const nb = parseInt(String(b).replace(/\D/g,"") || "0",10);
          return na - nb;
        });

        const qList = (ASESMEN_QUESTIONS && ASESMEN_QUESTIONS[kind]) ? ASESMEN_QUESTIONS[kind] : [];
        const label = {1:"Sangat Baik",2:"Baik",3:"Cukup",4:"Kurang",5:"Sangat Kurang"};

        let html = "<ul class='mb-0 ps-3'>";
        keys.forEach(k=>{
          const v = obj[k];
          const vv = Number(v);
          const info = (isFinite(vv) && label[vv]) ? ` (${label[vv]})` : "";

          const idx = parseInt(String(k).replace(/\D/g,"") || "0",10) - 1;
          let qText = (idx >= 0 && idx < (qList || []).length) ? String(qList[idx] || "") : "";
          // buang prefix "1. " agar tidak dobel dengan p1/p2
          qText = qText.replace(/^\s*\d+\.\s*/, "").trim();

          html += `
            <li style="margin-bottom:6px;">
              <div><b>${escapeHtml(k)}</b>${qText ? ` - ${escapeHtml(qText)}` : ""}</div>
              <div>Jawaban: <b>${escapeHtml(v)}</b>${escapeHtml(info)}</div>
            </li>
          `;
        });
        html += "</ul>";
        return html;
      }

      function renderAsesmenLayer(layer, rows, jenisLabel, kind){
        layer.clearLayers();
        (rows || []).forEach(r=>{
          const lat = parseFloat(r.latitude);
          const lon = parseFloat(r.longitude);
          if (!isFinite(lat) || !isFinite(lon)) return;

          const col = statusColor(r.status);

          const popup = `
            <div style="min-width:260px;">
              <div class="fw-bold mb-1">${escapeHtml(jenisLabel)}</div>
              <div><b>ID Relawan:</b> ${escapeHtml(r.id_relawan)}</div>
              <div><b>Skor:</b> ${escapeHtml(r.skor)}</div>
              <div><b>Status:</b> <span style="color:${col};font-weight:700;">${escapeHtml(r.status)}</span></div>
              <div><b>Waktu:</b> ${formatWIB(r.waktu)}</div>
              <hr class="my-2"/>
              <div class="fw-bold mb-1">Jawaban</div>
              ${jawabanHtml(r.jawaban, kind)}
            </div>
          `;

          const circle = L.circle([lat, lon], {
            pane: 'asesmenPane',
            radius: 2000,
            color: col,
            weight: 2,
            fill: true,
            fillColor: col,
            fillOpacity: 0.25,
            bubblingMouseEvents: false
          }).bindPopup(popup);

          const dot = L.circleMarker([lat, lon], {
            pane: 'asesmenPane',
            radius: 5,
            color: col,
            weight: 2,
            fillColor: col,
            fillOpacity: 0.95,
            bubblingMouseEvents: false
          }).bindPopup(popup);

          layer.addLayer(circle);
          layer.addLayer(dot);
        });
      }

      function renderAsesmenBuffers(){
        renderAsesmenLayer(asesmenKesehatanLayer, asesmenKesehatan, "Asesmen Kesehatan", "kesehatan");
        renderAsesmenLayer(asesmenPendidikanLayer, asesmenPendidikan, "Asesmen Pendidikan", "pendidikan");
      }
      renderAsesmenBuffers();

      // Toggle checkbox
      const ckKes = document.getElementById("toggleAsesmenKesehatan");
      const ckPen = document.getElementById("toggleAsesmenPendidikan");

      function setLayerVisible(layer, visible){
        if (visible) {
          if (!map.hasLayer(layer)) layer.addTo(map);
        } else {
          if (map.hasLayer(layer)) map.removeLayer(layer);
        }
      }

      if (ckKes) ckKes.addEventListener("change", ()=> setLayerVisible(asesmenKesehatanLayer, ckKes.checked));
      if (ckPen) ckPen.addEventListener("change", ()=> setLayerVisible(asesmenPendidikanLayer, ckPen.checked));
      // ================================================================


              // 2. Fungsi Penentu Warna
              function getColorByStatus(status) {
                  if (!status) return '#22c55e'; // Default Hijau
                  let s = status.toLowerCase(); // Ubah ke huruf kecil semua

                  if (s.includes('tanggap') || s.includes('awas') || s.includes('merah')) {
                      return '#ef4444'; // Merah
                  } else if (s.includes('siaga') || s.includes('waspada') || s.includes('kuning')) {
                      return '#eab308'; // Kuning
                  } else {
                      return '#22c55e'; // Hijau
                  }
              }

              function cleanName(name) {
                  if (!name) return "";

                  return name.toUpperCase()
                      // 1. Buang kata-kata atribut wilayah
                      .replace("KABUPATEN", "")
                      .replace("KOTA", "")
                      .replace("KAB.", "")
                      .replace("KAB ", "")

                      // 2. HAPUS SEMUA KECUALI HURUF A-Z
                      // (Spasi, titik, koma, strip, angka -> HILANG SEMUA)
                      .replace(/[^A-Z]/g, "");
              }

              // ---------------------------------------------------------
              // UPDATE FUNGSI PENCARI DATA (LEBIH PINTAR)
              // ---------------------------------------------------------
              function getFeatureData(feature) {
                  // 1. Ambil nama dari GeoJSON (Sesuai file .dbf kamu: 'kabkota')
                  let namaAsli = feature.properties.kabkota ||      // <--- INI YANG PALING MUNGKIN BENAR
                      feature.properties.KABKOTA ||      // Jaga-jaga kalau huruf besar
                      feature.properties.NAMOBJ ||
                      feature.properties.WADMKK ||
                      "Wilayah";

                  // 2. Bersihkan nama dari Peta (misal: "Kab. Karo" -> "KARO")
                  let namaGeoClean = cleanName(namaAsli);

                  let status = "Normal";

                  // 3. Loop data dari Excel/Sheet
                  for (let key in statusData) {
                      // Bersihkan nama dari Sheet
                      let keyClean = cleanName(key);

                      // Bandingkan INTINYA SAJA
                      if (namaGeoClean === keyClean) {
                          status = statusData[key];
                          break;
                      }
                  }

                  return { nama: namaAsli, status: status };
              }

              // 3. Load Peta
              fetch("{{ url_for('static', filename='data/kabkota_sumut.json') }}")
                  .then(res => res.json())
                  .then(data => {
                      L.geoJSON(data, {
                          pane: 'kabkotaPane',
                          // --- STYLE AWAL ---
                          style: function (feature) {
                              // Panggil fungsi pencari data
                              let info = getFeatureData(feature);

                              return {
                                  fillColor: getColorByStatus(info.status),
                                  weight: 1,
                                  opacity: 1,
                                  color: 'white',
                                  dashArray: '3',
                                  fillOpacity: 0.7
                              };
                          },

                          // --- INTERAKSI ---
                          onEachFeature: function (feature, layer) {
                              // Panggil fungsi pencari data LAGI (Pasti hasilnya sama dengan style)
                              let info = getFeatureData(feature);
                              let statusColor = getColorByStatus(info.status);

                              // Badge Class untuk Popup
                              let badgeClass = 'success';
                              let s = info.status.toLowerCase();
                              if (s.includes('tanggap') || s.includes('merah')) badgeClass = 'danger';
                              else if (s.includes('siaga') || s.includes('kuning')) badgeClass = 'warning';

                              // Popup & Tooltip
                              layer.bindTooltip(`<b>${info.nama}</b>: ${info.status}`, { sticky: true, direction: 'top' });
                              layer.bindPopup(`
                              <div class="text-center">
                                  <h6 class="mb-1 fw-bold">${info.nama}</h6>
                                  <span class="badge bg-${badgeClass}">${info.status}</span>
                              </div>
                          `);

                              // Logic Hover (Frame Effect)
                              layer.on({
                                  mouseover: function (e) {
                                      var l = e.target;
                                      l.setStyle({
                                          weight: 4,              // Frame Tebal
                                          color: statusColor,     // Warna Frame = Warna Status
                                          dashArray: '',          // Garis Solid
                                          fillColor: 'white',     // Isi Putih
                                          fillOpacity: 0.2
                                      });
                                      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) l.bringToFront();
                                  },
                                  mouseout: function (e) {
                                      var l = e.target;
                                      l.setStyle({
                                          weight: 1,              // Reset Tipis
                                          color: 'white',         // Reset Putih
                                          dashArray: '3',         // Reset Putus-putus
                                          fillColor: statusColor, // ISI BALIK KE WARNA ASAL (Kuning/Merah/Hijau)
                                          fillOpacity: 0.7
                                      });
                                  },
                                  click: function (e) { this.openPopup(); }
                              });
                          }
                      }).addTo(map);
                  })
                  .catch(e => console.error("Error GeoJSON:", e));

              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
              }).addTo(map);

              // Definisi Ikon Kustom dengan Font Awesome
              function getIcon(jenis) {
                  let iconClass, iconColor, bgColor;

                  if (jenis.includes('Posko')) {
                      // Icon Tenda untuk Posko Pengungsian
                      iconClass = 'fas fa-campground';
                      iconColor = '#ffffff';
                      bgColor = '#ef4444'; // Merah
                  } else if (jenis.includes('Gudang')) {
                      // Icon Gudang
                      iconClass = 'fas fa-warehouse';
                      iconColor = '#ffffff';
                      bgColor = '#10b981'; // Hijau
                  } else if (jenis.includes('Rusak') || jenis.includes('Putus') || jenis.includes('Longsor')) {
                      iconClass = 'fas fa-exclamation-triangle';
                      iconColor = '#ffffff';
                      bgColor = '#f59e0b'; // Orange
                  } else {
                      iconClass = 'fas fa-map-marker-alt';
                      iconColor = '#ffffff';
                      bgColor = '#3b82f6'; // Biru
                  }

                  // Buat custom HTML icon dengan Font Awesome
                  const iconHtml = `
                      <div style="
                          background-color: ${bgColor};
                          width: 40px;
                          height: 40px;
                          border-radius: 50% 50% 50% 0;
                          transform: rotate(-45deg);
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                          border: 3px solid white;
                      ">
                          <i class="${iconClass}" style="
                              color: ${iconColor};
                              transform: rotate(45deg);
                              font-size: 18px;
                          "></i>
                      </div>
                  `;

                  return L.divIcon({
                      html: iconHtml,
                      className: 'custom-marker-icon',
                      iconSize: [40, 40],
                      iconAnchor: [20, 40],
                      popupAnchor: [0, -40]
                  });
              }
              {#Relawan Marker#}
              function getRelawanIcon() {
        const iconHtml = `
          <div style="
            background-color:#0ea5e9;width:40px;height:40px;
            border-radius:50% 50% 50% 0;transform:rotate(-45deg);
            display:flex;align-items:center;justify-content:center;
            box-shadow:0 3px 10px rgba(0,0,0,.3);border:3px solid #fff;">
            <i class="fas fa-user" style="color:#fff;transform:rotate(45deg);font-size:18px;"></i>
          </div>`;
        return L.divIcon({
          html: iconHtml,
          className: 'custom-marker-icon',
          iconSize: [40, 40],
          iconAnchor: [20, 40],
          popupAnchor: [0, -40]
        });
      }

      function _formatWaktuGMT7(v) {
        if (!v) return '-';
        try {
          const d = new Date(v);
          if (isNaN(d.getTime())) return String(v);

          const fmt = new Intl.DateTimeFormat('id-ID', {
            timeZone: 'Asia/Jakarta',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });

          const parts = fmt.formatToParts(d).reduce((acc, p) => {
            acc[p.type] = p.value;
            return acc;
          }, {});

          return `${parts.year}-${parts.month}-${parts.day} ${parts.hour}:${parts.minute}:${parts.second} WIB`;
        } catch (e) {
          return String(v);
        }
      }

      function _normalizePhotoUrl(p) {
        if (!p) return '';
        const s = String(p).trim();
        if (!s) return '';
        if (s.startsWith('http://') || s.startsWith('https://')) return s;
        if (s.startsWith('/')) return s;
        return '/' + s;
      }

      function renderRelawanMarkers(relawanData) {
        relawanLayerGroup.clearLayers();
        (relawanData || []).forEach(r => {
          const lat = parseFloat(r.latitude);
          const lon = parseFloat(r.longitude);
          if (!isNaN(lat) && !isNaN(lon)) {
            const photoUrl = _normalizePhotoUrl(r.photo_path);
            const waktuText = _formatWaktuGMT7(r.waktu);
            const unitText = r.unit ? String(r.unit) : '';
            const catatanText = r.catatan ? String(r.catatan) : '-';

            const photoHtml = photoUrl
              ? `<img src="${photoUrl}" alt="Foto Relawan" style="width:78px;height:78px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;">`
              : `<div style="width:78px;height:78px;border-radius:10px;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:center;background:#f8fafc;">
                   <i class="fas fa-image" style="opacity:.45;"></i>
                 </div>`;

            L.marker([lat, lon], { icon: getRelawanIcon() })
              .addTo(relawanLayerGroup)
              .bindPopup(
                `<div style="min-width:250px;">
                   <div style="display:flex;gap:10px;align-items:flex-start;">
                     ${photoHtml}
                     <div style="flex:1;">
                       <div style="font-weight:700;line-height:1.1;">${r.id_relawan || '-'} - ${r.nama_relawan || '-'}</div>
                       ${unitText ? `<div style="margin-top:4px;"><small class="text-muted">Unit:</small> <small><b>${unitText}</b></small></div>` : ''}
                       <div style="margin-top:4px;"><small class="text-muted">Waktu:</small> <small><b>${waktuText}</b></small></div>
                       <div style="margin-top:6px;"><small class="text-muted">Catatan:</small><br><small>${catatanText}</small></div>
                     </div>
                   </div>
                 </div>`
              );
          }
        });
      }

              // 4. Fungsi untuk render marker lokasi ke peta
              function renderMarkers(lokasiData) {
                  // Hapus marker lama
                  markerLayerGroup.clearLayers();

                  // Tambah marker baru
                  lokasiData.forEach(lokasi => {
                      const lat = parseFloat(lokasi.latitude);
                      const lon = parseFloat(lokasi.longitude);
                      if (!isNaN(lat) && !isNaN(lon)) {
                          let icon = getIcon(lokasi.jenis_lokasi);

                          const photoUrl = _normalizePhotoUrl(lokasi.photo_path);
                          const photoHtml = photoUrl
                              ? `<img src="${photoUrl}" alt="Foto Lokasi" style="width:78px;height:78px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;">`
                              : `<div style="width:78px;height:78px;border-radius:10px;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:center;background:#f8fafc;">
                                   <i class="fas fa-image" style="opacity:.45;"></i>
                                 </div>`;

                          const kabkotaText = lokasi.nama_kabkota || lokasi.kabupaten_kota || '-';
                          const idLokasiText = lokasi.id_lokasi || lokasi.kode_lokasi || lokasi.kode || '-';
                          const namaLokasiText = lokasi.nama_lokasi || '-';
                          const statusLokasiText = lokasi.status_lokasi || '-';
                          const aksesText = lokasi.tingkat_akses || lokasi.akses || '-';
                          const kondisiText = lokasi.kondisi || lokasi.kondisi_umum || '-';
                          const catatanText = lokasi.catatan || '-';

                          L.marker([lat, lon], { icon: icon })
                              .addTo(markerLayerGroup)
                              .bindPopup(
                                  `<div style="min-width:270px;">
                                      <div style="display:flex;gap:10px;align-items:flex-start;">
                                          ${photoHtml}
                                          <div style="flex:1;">
                                              <div style="font-weight:700;line-height:1.1;">
                                                  <span class="text-primary">${lokasi.jenis_lokasi || '-'}</span>
                                              </div>
                                              <div style="margin-top:2px;">${kabkotaText}</div>

                                              <div style="margin-top:6px;">
                                                  <small class="text-muted">ID Lokasi:</small>
                                                  <small><b>${idLokasiText}</b></small>
                                              </div>
                                              <div style="margin-top:2px;">
                                                  <small class="text-muted">Nama Lokasi:</small>
                                                  <small><b>${namaLokasiText}</b></small>
                                              </div>

                                              <div style="margin-top:6px;">
                                                  <small class="text-muted">Status:</small>
                                                  <small><b>${statusLokasiText}</b></small>
                                                  <small class="text-muted"> | Akses:</small>
                                                  <small><b>${aksesText}</b></small>
                                                  <small class="text-muted"> | Kondisi:</small>
                                                  <small><b>${kondisiText}</b></small>
                                              </div>

                                              <div style="margin-top:6px;">
                                                  <small class="text-muted">Catatan:</small><br>
                                                  <small>${catatanText}</small>
                                              </div>
                                          </div>
                                      </div>
                                  </div>`
                              );
                      }
                  });
              }

              // Render marker awal
              renderMarkers(dataLokasi);
              renderRelawanMarkers(relawanLokasi);
              // ==============================================================================
              // FUNGSI REFRESH MAP
              // ==============================================================================
              const refreshMapBtn = document.getElementById('refreshMapBtn');
              let isRefreshingMap = false;

              async function refreshMap() {
                  if (isRefreshingMap) return;

                  isRefreshingMap = true;
                  const originalHtml = refreshMapBtn.innerHTML;
                  refreshMapBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                  refreshMapBtn.disabled = true;

                  try {
                      const response = await fetch('/api/refresh_map');
                      const result = await response.json();

                      if (result.success) {
                          // Update data
                          dataLokasi = result.data_lokasi;
                          relawanLokasi = result.relawan_lokasi || [];
                          statusData = result.status_map;

                          // Update status wilayah di peta (reload GeoJSON layer)
                          // Hapus layer GeoJSON lama jika ada
                          map.eachLayer(function(layer) {
                              if (layer instanceof L.GeoJSON) {
                                  map.removeLayer(layer);
                              }
                          });

                          // Reload GeoJSON dengan status terbaru
                          fetch("{{ url_for('static', filename='data/kabkota_sumut.json') }}")
                              .then(res => res.json())
                              .then(geoData => {
                                  L.geoJSON(geoData, {
                                      pane: 'kabkotaPane',
                                      style: function (feature) {
                                          let info = getFeatureData(feature);
                                          return {
                                              fillColor: getColorByStatus(info.status),
                                              weight: 1,
                                              opacity: 1,
                                              color: 'white',
                                              dashArray: '3',
                                              fillOpacity: 0.7
                                          };
                                      },
                                      onEachFeature: function (feature, layer) {
                                          let info = getFeatureData(feature);
                                          let statusColor = getColorByStatus(info.status);
                                          let badgeClass = 'success';
                                          let s = info.status.toLowerCase();
                                          if (s.includes('tanggap') || s.includes('merah')) badgeClass = 'danger';
                                          else if (s.includes('siaga') || s.includes('kuning')) badgeClass = 'warning';

                                          layer.bindTooltip(`<b>${info.nama}</b>: ${info.status}`, { sticky: true, direction: 'top' });
                                          layer.bindPopup(`
                                              <div class="text-center">
                                                  <h6 class="mb-1 fw-bold">${info.nama}</h6>
                                                  <span class="badge bg-${badgeClass}">${info.status}</span>
                                              </div>
                                          `);

                                          layer.on({
                                              mouseover: function (e) {
                                                  var l = e.target;
                                                  l.setStyle({
                                                      weight: 4,
                                                      color: statusColor,
                                                      dashArray: '',
                                                      fillColor: 'white',
                                                      fillOpacity: 0.2
                                                  });
                                                  if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) l.bringToFront();
                                              },
                                              mouseout: function (e) {
                                                  var l = e.target;
                                                  l.setStyle({
                                                      weight: 1,
                                                      color: 'white',
                                                      dashArray: '3',
                                                      fillColor: statusColor,
                                                      fillOpacity: 0.7
                                                  });
                                              },
                                              click: function (e) { this.openPopup(); }
                                          });
                                      }
                                  }).addTo(map);
                              })
                              .catch(e => console.error("Error reloading GeoJSON:", e));

                          // Update marker lokasi
                          renderMarkers(dataLokasi);
                          renderRelawanMarkers(relawanLokasi);

                      // Asemen buffers (kesehatan & pendidikan)
                          asesmenKesehatan = Array.isArray(result.asesmen_kesehatan) ? result.asesmen_kesehatan : (result.asesmen_kesehatan || []);
                          asesmenPendidikan = Array.isArray(result.asesmen_pendidikan) ? result.asesmen_pendidikan : (result.asesmen_pendidikan || []);
                          renderAsesmenBuffers();
                          // Tampilkan notifikasi sukses (centered)
                          showNotification('Map berhasil di-refresh!', 'success', true);
                      } else {
                          showNotification('Gagal refresh map: ' + (result.error || 'Unknown error'), 'danger');
                      }
                  } catch (error) {
                      console.error('Error refreshing map:', error);
                      showNotification('Error saat refresh map. Silakan coba lagi.', 'danger');
                  } finally {
                      isRefreshingMap = false;
                      refreshMapBtn.innerHTML = originalHtml;
                      refreshMapBtn.disabled = false;
                  }
              }

              refreshMapBtn.addEventListener('click', refreshMap);

              // ==============================================================================
              // FUNGSI NOTIFIKASI
              // ==============================================================================
              function showNotification(message, type = 'info', center = false) {
                  const alertDiv = document.createElement('div');
                  alertDiv.className = `alert alert-${type} alert-dismissible fade show shadow`;
                  if (center) {
                      alertDiv.style.cssText = 'position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 10000; min-width: 300px; max-width: 700px; text-align: center;';
                  } else {
                      alertDiv.style.cssText = 'position: fixed; top: 70px; left: 15px; z-index: 10000; min-width: 300px; max-width: 400px;';
                  }
                  alertDiv.innerHTML = `
                      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                      ${message}
                      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                  `;
                  document.body.appendChild(alertDiv);

                  setTimeout(() => {
                      if (alertDiv.parentNode) {
                          alertDiv.remove();
                      }
                  }, 3000);
              }

              // ==============================================================================
              // LOGIKA ABSENSI LOKASI RELAWAN (GEOLOCATION API)
              // ==============================================================================
              const btnSubmitAbsensi = document.getElementById('btn-submit-absensi');
              const absensiLat = document.getElementById('absensi_lat');
              const absensiLon = document.getElementById('absensi_lon');
              const currentLocationSpan = document.getElementById('current-location');
              const refreshLocationBtn = document.getElementById('refreshLocationBtn');

               // ====================== MINI MAP ABSENSI (KOREKSI TITIK) ======================
              let absensiMiniMap = null;
              let absensiMiniMarker = null;
              let absensiGeoWatchId = null;
              let absensiGeoTimer = null;

              function initAbsensiMiniMap() {
                  const el = document.getElementById('absensiMiniMap');
                  if (!el) return;
                  if (absensiMiniMap) return;

                  absensiMiniMap = L.map('absensiMiniMap', {
                      zoomControl: true,
                      attributionControl: false,
                      scrollWheelZoom: false
                  }).setView([2.3693, 99.0763], 9);

                  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                      attribution: '&copy; OpenStreetMap contributors'
                  }).addTo(absensiMiniMap);

                  // Klik peta -> pindah pin (manual koreksi)
                  absensiMiniMap.on('click', function (e) {
                      setAbsensiPoint(e.latlng.lat, e.latlng.lng, { manual: true });
                      showNotification('Titik absensi diperbarui (klik peta).', 'success', true);
                  });
              }

              function stopAbsensiGeoWatch() {
                  if (absensiGeoWatchId !== null) {
                      try { navigator.geolocation.clearWatch(absensiGeoWatchId); } catch (e) {}
                      absensiGeoWatchId = null;
                  }
                  if (absensiGeoTimer) {
                      clearTimeout(absensiGeoTimer);
                      absensiGeoTimer = null;
                  }
              }

              function setAbsensiPoint(lat, lon, opts = {}) {
                  const isManual = !!opts.manual;
                  const accuracy = typeof opts.accuracy === 'number' ? opts.accuracy : null;

                  absensiLat.value = lat;
                  absensiLon.value = lon;

                  const accHtml = (accuracy !== null)
                      ? `<br>Akurasi: ${Math.round(accuracy)}m`
                      : (isManual ? `<br><span class="text-muted">Titik dikoreksi manual</span>` : '');

                  currentLocationSpan.innerHTML = `
                      <i class="fas fa-check-circle"></i> Lokasi ditemukan!<br>
                      <small>Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}${accHtml}</small>
                  `;
                  currentLocationSpan.classList.remove('text-danger', 'text-primary');
                  currentLocationSpan.classList.add('text-success');
                  btnSubmitAbsensi.disabled = false;

                  initAbsensiMiniMap();
                  if (absensiMiniMap) {
                      if (!absensiMiniMarker) {
                          absensiMiniMarker = L.marker([lat, lon], { draggable: true }).addTo(absensiMiniMap);

                          // Geser pin -> update koordinat (manual koreksi)
                          absensiMiniMarker.on('dragend', function (ev) {
                              const p = ev.target.getLatLng();
                              setAbsensiPoint(p.lat, p.lng, { manual: true });
                              showNotification('Titik absensi diperbarui (geser pin).', 'success', true);
                          });
                      } else {
                          absensiMiniMarker.setLatLng([lat, lon]);
                      }

                      // Zoom menyesuaikan (kalau akurasi sangat besar, jangan zoom terlalu dekat)
                      const targetZoom = (accuracy !== null && accuracy <= 1000) ? 17 : 14;
                      absensiMiniMap.setView([lat, lon], Math.max(absensiMiniMap.getZoom(), targetZoom), { animate: true });
                  }
              }

              // Best-effort: ambil beberapa update lokasi, pilih yang akurasinya paling kecil.
              // Catatan: di laptop/PC akurasi bisa sangat besar karena bukan GPS (lebih ke estimasi jaringan).
              function getBestAbsensiLocation(opts) {
                  opts = opts || {};
                  const targetAcc = typeof opts.targetAccuracy === 'number' ? opts.targetAccuracy : 50;
                  const maxWaitMs = typeof opts.maxWaitMs === 'number' ? opts.maxWaitMs : 20000;
                  const onUpdate = typeof opts.onUpdate === 'function' ? opts.onUpdate : null;
                  const onDone = typeof opts.onDone === 'function' ? opts.onDone : null;

                  let bestPos = null;
                  let lastErr = null;
                  let done = false;

                  function accOf(pos) {
                      return pos && pos.coords && typeof pos.coords.accuracy === 'number'
                          ? pos.coords.accuracy
                          : 9999999;
                  }

                  function consider(pos) {
                      if (!pos || !pos.coords) return;
                      if (!bestPos || accOf(pos) < accOf(bestPos)) bestPos = pos;
                      if (onUpdate) onUpdate(bestPos);
                      if (accOf(pos) <= targetAcc) finish();
                  }

                  function fail(err) {
                      lastErr = err || lastErr;
                  }

                  function finish() {
                      if (done) return;
                      done = true;
                      stopAbsensiGeoWatch();
                      if (onDone) onDone(bestPos, lastErr);
                  }

                  stopAbsensiGeoWatch();
                  absensiGeoTimer = setTimeout(finish, maxWaitMs);

                  // 1) cepat: high accuracy
                  try {
                      navigator.geolocation.getCurrentPosition(
                          consider,
                          fail,
                          { enableHighAccuracy: true, timeout: Math.min(12000, maxWaitMs), maximumAge: 0 }
                      );
                  } catch (e) {}

                  // 2) cepat: network-based (kadang lebih baik di laptop)
                  try {
                      navigator.geolocation.getCurrentPosition(
                          consider,
                          fail,
                          { enableHighAccuracy: false, timeout: Math.min(12000, maxWaitMs), maximumAge: 0 }
                      );
                  } catch (e) {}

                  // 3) watchPosition untuk cari yang paling akurat
                  try {
                      absensiGeoWatchId = navigator.geolocation.watchPosition(
                          consider,
                          fail,
                          { enableHighAccuracy: true, maximumAge: 0 }
                      );
                  } catch (e) {}
              }


              // Fungsi untuk mendapatkan lokasi dengan retry
              function getCurrentLocation(retryCount = 0, onComplete = null) {
                  const maxRetries = 3;

                  initAbsensiMiniMap();

                  if (!navigator.geolocation) {
                      currentLocationSpan.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Geolocation tidak didukung. Silakan klik peta untuk set titik manual.';
                      currentLocationSpan.classList.remove('text-success', 'text-primary');
                      currentLocationSpan.classList.add('text-danger');
                      btnSubmitAbsensi.disabled = true;
                      if (onComplete) onComplete();
                      showNotification('Geolocation tidak didukung. Klik peta untuk set titik manual.', 'danger');
                      return;
                  }

                  // Loading state
                  currentLocationSpan.innerHTML = '<i class="fas fa-sync fa-spin"></i> Mencari lokasi (akurasi terbaik)...';
                  currentLocationSpan.classList.remove('text-success', 'text-danger');
                  currentLocationSpan.classList.add('text-primary');
                  btnSubmitAbsensi.disabled = true;

                  // Reset koordinat
                  absensiLat.value = '';
                  absensiLon.value = '';

                  getBestAbsensiLocation({
                      targetAccuracy: 50,
                      maxWaitMs: 20000,
                      onUpdate: function (bestPos) {
                          if (!bestPos || !bestPos.coords) return;

                          const lat = bestPos.coords.latitude;
                          const lon = bestPos.coords.longitude;
                          const accuracy = bestPos.coords.accuracy;

                          if (isNaN(lat) || isNaN(lon) || lat === 0 || lon === 0) return;

                          // Update UI + mini map + marker
                          setAbsensiPoint(lat, lon, { accuracy: accuracy, manual: false });
                      },
                      onDone: function (bestPos, err) {
                          if (bestPos && bestPos.coords) {
                              const lat = bestPos.coords.latitude;
                              const lon = bestPos.coords.longitude;
                              const accuracy = bestPos.coords.accuracy;

                              setAbsensiPoint(lat, lon, { accuracy: accuracy, manual: false });

                              // Jika akurasi sangat besar, arahkan user koreksi manual
                              if (accuracy && accuracy > 5000) {
                                  showNotification('Akurasi GPS rendah. Silakan geser pin/klik peta untuk koreksi titik sebelum submit.', 'warning', true);
                              } else {
                                  showNotification(`Lokasi berhasil diperbarui! Akurasi: ${Math.round(accuracy)}m`, 'success', true);
                              }

                              if (onComplete) onComplete();
                              return;
                          }

                          // Kalau gagal total -> retry atau arahkan ke manual map
                          let errorMessage = '';
                          let shouldRetry = false;
                          let notificationMsg = '';

                          if (err && err.code === err.PERMISSION_DENIED) {
                              errorMessage = '<i class="fas fa-ban"></i> Akses lokasi ditolak. Anda masih bisa klik peta untuk set titik manual.';
                              notificationMsg = 'Akses lokasi ditolak. Klik peta untuk set titik manual.';
                          } else if (err && err.code === err.POSITION_UNAVAILABLE) {
                              errorMessage = '<i class="fas fa-question-circle"></i> Informasi lokasi tidak tersedia. Anda bisa klik peta untuk set titik manual.';
                              notificationMsg = 'Lokasi tidak tersedia. Klik peta untuk set titik manual.';
                              shouldRetry = retryCount < maxRetries;
                          } else if (err && err.code === err.TIMEOUT) {
                              errorMessage = '<i class="fas fa-clock"></i> Waktu tunggu habis. Mencoba lagi...';
                              notificationMsg = 'Waktu tunggu habis. Mencoba lagi...';
                              shouldRetry = retryCount < maxRetries;
                          } else {
                              errorMessage = '<i class="fas fa-exclamation-triangle"></i> Gagal mengambil lokasi. Anda bisa klik peta untuk set titik manual.';
                              notificationMsg = 'Gagal mengambil lokasi. Klik peta untuk set titik manual.';
                              shouldRetry = retryCount < maxRetries;
                          }

                          currentLocationSpan.innerHTML = errorMessage;
                          currentLocationSpan.classList.remove('text-success', 'text-primary');
                          currentLocationSpan.classList.add('text-danger');
                          btnSubmitAbsensi.disabled = true;

                          console.error('Geolocation error:', {
                              code: err ? err.code : null,
                              message: err ? err.message : null,
                              retryCount: retryCount
                          });

                          if (shouldRetry) {
                              setTimeout(() => {
                                  currentLocationSpan.innerHTML = `<i class="fas fa-sync fa-spin"></i> Mencoba lagi... (${retryCount + 1}/${maxRetries})`;
                                  getCurrentLocation(retryCount + 1, onComplete);
                              }, 2000);
                          } else {
                              if (onComplete) onComplete();
                              if (notificationMsg) showNotification(notificationMsg, 'danger');
                          }
                      }
                  });
              }

              // Event listener untuk tombol refresh lokasi
              if (refreshLocationBtn) {
                  refreshLocationBtn.addEventListener('click', function(e) {
                      e.preventDefault();
                      e.stopPropagation();

                      // Tampilkan loading state
                      const originalHtml = refreshLocationBtn.innerHTML;
                      refreshLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                      refreshLocationBtn.disabled = true;

                      // Update status lokasi
                      currentLocationSpan.innerHTML = '<i class="fas fa-sync fa-spin"></i> Mencari lokasi...';
                      currentLocationSpan.classList.remove('text-success', 'text-danger');
                      currentLocationSpan.classList.add('text-primary');

                      // Reset koordinat
                      absensiLat.value = '';
                      absensiLon.value = '';
                      btnSubmitAbsensi.disabled = true;

                      // Panggil fungsi getCurrentLocation dengan callback untuk restore button
                      getCurrentLocation(0, function() {
                          // Restore button setelah selesai
                          refreshLocationBtn.innerHTML = originalHtml;
                          refreshLocationBtn.disabled = false;
                      });
                  });
              }

              // Panggil Geolocation saat modal absensi dibuka
              document.getElementById('absensiModal').addEventListener('show.bs.modal', function () {
                  currentLocationSpan.innerHTML = '<i class="fas fa-sync fa-spin"></i> Mencari lokasi...';
                  currentLocationSpan.classList.remove('text-success', 'text-danger');
                  currentLocationSpan.classList.add('text-primary');
                  btnSubmitAbsensi.disabled = true;

                  // Reset nilai koordinat
                  absensiLat.value = '';
                  absensiLon.value = '';

                  // Mulai proses mendapatkan lokasi
                  getCurrentLocation();
              });

              // Pastikan mini map terbaca ukurannya saat modal sudah tampil
              document.getElementById('absensiModal').addEventListener('shown.bs.modal', function () {
                  initAbsensiMiniMap();
                  if (absensiMiniMap) absensiMiniMap.invalidateSize();
              });

              // Stop watcher GPS saat modal ditutup
              document.getElementById('absensiModal').addEventListener('hidden.bs.modal', function () {
                  stopAbsensiGeoWatch();
              });


              // Validasi form sebelum submit
              document.getElementById('absensiForm').addEventListener('submit', function(e) {
                  const lat = absensiLat.value;
                  const lon = absensiLon.value;

                  if (!lat || !lon || lat === '' || lon === '') {
                      e.preventDefault();
                      currentLocationSpan.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Lokasi belum ditemukan. Silakan tunggu atau refresh halaman.';
                      currentLocationSpan.classList.remove('text-success', 'text-primary');
                      currentLocationSpan.classList.add('text-danger');
                      btnSubmitAbsensi.disabled = true;

                      // Coba lagi mendapatkan lokasi
                      getCurrentLocation();
                      return false;
                  }

                  // Validasi koordinat valid (bukan 0,0)
                  if (parseFloat(lat) === 0 && parseFloat(lon) === 0) {
                      e.preventDefault();
                      currentLocationSpan.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Koordinat tidak valid. Silakan coba lagi.';
                      currentLocationSpan.classList.remove('text-success', 'text-primary');
                      currentLocationSpan.classList.add('text-danger');
                      btnSubmitAbsensi.disabled = true;
                      return false;
                  }
              });
    </script>
    <script>
      // Global loading overlay helpers
      function showGlobalLoading(msg) {
        const ov = document.getElementById("globalLoadingOverlay");
        if (!ov) return;
        const textEl = ov.querySelector(".loading-text");
        if (msg) textEl.textContent = msg;
        ov.style.display = "flex";
      }
      function hideGlobalLoading() {
        const ov = document.getElementById("globalLoadingOverlay");
        if (!ov) return;
        ov.style.display = "none";
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Attach submit handler to all POST forms to show loading and prevent double submits
        document
          .querySelectorAll('form[method="POST"]')
          .forEach(function (form) {
            form.addEventListener("submit", function () {
              showGlobalLoading("Mengirim data...");
              form
                .querySelectorAll('button, input[type="submit"]')
                .forEach(function (el) {
                  el.disabled = true;
                });
            });
          });

        const confirmLogoutBtn = document.getElementById("confirmLogoutBtn");
        const logoutForm = document.getElementById("logoutForm");
        if (confirmLogoutBtn && logoutForm) {
          confirmLogoutBtn.addEventListener("click", function () {
            const modalEl = document.getElementById("logoutConfirmModal");
            const modal =
              bootstrap.Modal.getInstance(modalEl) ||
              new bootstrap.Modal(modalEl);
            modal.hide();
            showGlobalLoading("Logging out...");
            logoutForm.submit();
          });
        }
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const sidebar = document.getElementById("sidebar");
        const toggleBtn = document.getElementById("sidebarToggle");
        const closeBtn = document.getElementById("sidebarClose");

        // 1. Fungsi Buka Sidebar
        toggleBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          e.preventDefault();
          sidebar.classList.add("active");
          toggleBtn.style.visibility = "hidden";
        });

        // 2. Fungsi Tutup Sidebar (Tombol X)
        closeBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          sidebar.classList.remove("active");
          setTimeout(() => {
            toggleBtn.style.visibility = "visible";
          }, 300);
        });

        // 3. Logic Tutup Sidebar saat klik di luar (Global Click)
        document.addEventListener("click", function (e) {
          if (sidebar.classList.contains("active")) {
            const clickInsideSidebar = sidebar.contains(e.target);
            const clickToggle = toggleBtn.contains(e.target);
            const clickInsideModal = e.target.closest(".modal-content");
            if (!clickInsideSidebar && !clickToggle && !clickInsideModal) {
              sidebar.classList.remove("active");
              setTimeout(() => {
                toggleBtn.style.visibility = "visible";
              }, 300);
            }
          }
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const alerts = document.querySelectorAll(".alert");
        alerts.forEach(function (alert) {
          setTimeout(function () {
            let bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
          }, 3000);
        });
      });
    </script>

    <!-- ===================================================================== -->
    <!-- ASESMEN: MINI MAP + BEST GPS (SAMA DENGAN ABSENSI)                      -->
    <!-- ===================================================================== -->
    <script>
      // MINI MAP ASESMEN: konsep sama seperti absensi (GPS -> marker, bisa geser / klik peta)
      // Catatan: absensi sudah punya modul sendiri. Di sini khusus untuk asesmen (kesehatan & pendidikan).

      (function () {
        const DEFAULT_CENTER = [3.5952, 98.6722]; // Medan

        const cfg = {
          kesehatan: {
            modalId: "asesmenKesehatanModal",
            mapId: "kesehatanMiniMap",
            latId: "kesehatan_lat",
            lonId: "kesehatan_lon",
            textId: "kesehatan-location-text",
            btnId: "btn-submit-kesehatan",
            statusId: "kesehatan-location-status",
          },
          pendidikan: {
            modalId: "asesmenPendidikanModal",
            mapId: "pendidikanMiniMap",
            latId: "pendidikan_lat",
            lonId: "pendidikan_lon",
            textId: "pendidikan-location-text",
            btnId: "btn-submit-pendidikan",
            statusId: "pendidikan-location-status",
          },
        };

        const state = {
          kesehatan: {
            map: null,
            marker: null,
            watchId: null,
            timeoutId: null,
          },
          pendidikan: {
            map: null,
            marker: null,
            watchId: null,
            timeoutId: null,
          },
        };

        function _el(id) {
          return document.getElementById(id);
        }

        function _stopWatch(kind) {
          try {
            const st = state[kind];
            if (st && st.watchId) {
              navigator.geolocation.clearWatch(st.watchId);
              st.watchId = null;
            }
            if (st && st.timeoutId) {
              clearTimeout(st.timeoutId);
              st.timeoutId = null;
            }
          } catch (e) {}
        }

        function _initMap(kind) {
          const c = cfg[kind];
          const st = state[kind];
          if (!c || !st) return;

          if (st.map) return;

          const mapEl = _el(c.mapId);
          if (!mapEl) return;

          st.map = L.map(c.mapId).setView(DEFAULT_CENTER, 14);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors",
          }).addTo(st.map);

          // marker default (draggable)
          st.marker = L.marker(DEFAULT_CENTER, { draggable: true }).addTo(
            st.map
          );

          st.marker.on("dragend", function (e) {
            const pos = e.target.getLatLng();
            _setPoint(kind, pos.lat, pos.lng, { manual: true });
          });

          st.map.on("click", function (e) {
            _setPoint(kind, e.latlng.lat, e.latlng.lng, { manual: true });
          });
        }

        function _setText(kind, msg, isError = false) {
          const c = cfg[kind];
          const txt = _el(c.textId);
          if (txt) txt.textContent = msg;
          const st = _el(c.statusId);
          if (st) {
            st.textContent = isError ? "Gagal" : "OK";
            st.className = "badge " + (isError ? "bg-danger" : "bg-success");
          }
        }

        function _setPoint(kind, lat, lon, opts = {}) {
          const c = cfg[kind];
          const st = state[kind];

          if (!c || !st) return;

          const latNum = parseFloat(lat);
          const lonNum = parseFloat(lon);

          if (isNaN(latNum) || isNaN(lonNum)) {
            _setText(kind, "Koordinat tidak valid.", true);
            return;
          }

          // Update hidden inputs
          const latEl = _el(c.latId);
          const lonEl = _el(c.lonId);
          if (latEl) latEl.value = latNum.toFixed(6);
          if (lonEl) lonEl.value = lonNum.toFixed(6);

          // Update marker
          if (st.marker) st.marker.setLatLng([latNum, lonNum]);
          if (st.map) st.map.panTo([latNum, lonNum]);

          // Deteksi wilayah (pakai fungsi yang sudah ada di file ini)
          let wilayah = "";
          try {
            wilayah = cekWilayah ? cekWilayah(latNum, lonNum) : "";
          } catch (e) {
            wilayah = "";
          }

          const base = wilayah ? ` ${wilayah}` : " Lokasi dipilih";
          const extra = opts.accuracy
            ? ` (akurasi ${Math.round(opts.accuracy)}m)`
            : "";
          _setText(kind, base + extra, false);

          // Enable submit
          const btn = _el(c.btnId);
          if (btn) btn.disabled = false;

          // Notif jika manual
          if (opts.manual) {
            try {
              showNotification("Lokasi diperbarui manual di peta.", "info");
            } catch (e) {}
          }
        }

        function _getBestLocation(kind, opts = {}) {
          // Teknik: ambil beberapa sample + watchPosition, pilih yang akurasi paling kecil.
          const st = state[kind];
          const maxSamples = opts.maxSamples || 6;
          const maxWaitMs = opts.maxWaitMs || 12000;

          if (!navigator.geolocation) {
            _setText(kind, "Browser tidak mendukung GPS.", true);
            return;
          }

          _stopWatch(kind);

          _setText(kind, "Mencari lokasi GPS terbaik...", false);

          let best = null;
          let samples = 0;

          function consider(pos) {
            if (!pos || !pos.coords) return;
            const acc = pos.coords.accuracy || 999999;
            if (!best || acc < best.accuracy) {
              best = {
                lat: pos.coords.latitude,
                lon: pos.coords.longitude,
                accuracy: acc,
              };
              _setPoint(kind, best.lat, best.lon, { accuracy: best.accuracy });
            }
            samples += 1;
            if (samples >= maxSamples) finish();
          }

          function finish() {
            _stopWatch(kind);
            if (!best) {
              _setText(
                kind,
                "Gagal mendapatkan lokasi. Silakan pilih manual di peta.",
                true
              );
              return;
            }
            _setText(
              kind,
              ` Lokasi ditemukan (akurasi ${Math.round(best.accuracy)}m)`,
              false
            );
          }

          function onError(err) {
            // Jika ditolak / error, tetap biarkan user pilih manual
            _stopWatch(kind);
            const msg = err && err.message ? err.message : "Error GPS";
            _setText(kind, `Gagal GPS (${msg}). Pilih manual di peta.`, true);
          }

          // 1) High accuracy
          navigator.geolocation.getCurrentPosition(consider, onError, {
            enableHighAccuracy: true,
            timeout: 8000,
            maximumAge: 0,
          });

          // 2) Low accuracy fallback (kadang lebih cepat)
          navigator.geolocation.getCurrentPosition(consider, function () {}, {
            enableHighAccuracy: false,
            timeout: 6000,
            maximumAge: 0,
          });

          // 3) Watch for improvements
          try {
            st.watchId = navigator.geolocation.watchPosition(
              consider,
              function () {},
              { enableHighAccuracy: true, maximumAge: 0, timeout: 8000 }
            );
          } catch (e) {}

          // Stop after maxWait
          st.timeoutId = setTimeout(finish, maxWaitMs);
        }

        // Public handler (dipakai tombol "Ambil Lokasi GPS")
        window.getLocationForAsesmen = function (jenis) {
          const kind = String(jenis || "").toLowerCase();
          if (!cfg[kind]) return;

          _initMap(kind);
          _getBestLocation(kind);
        };

        // Auto-run saat modal dibuka
        Object.keys(cfg).forEach(function (kind) {
          const c = cfg[kind];

          const modal = _el(c.modalId);
          if (!modal) return;

          modal.addEventListener("show.bs.modal", function () {
            // Reset state
            _setText(kind, "Menunggu lokasi...", false);
            const btn = _el(c.btnId);
            if (btn) btn.disabled = true;

            // Init map dan ambil GPS
            _initMap(kind);
            _getBestLocation(kind);
          });

          modal.addEventListener("shown.bs.modal", function () {
            // Fix ukuran map dalam modal
            setTimeout(function () {
              if (state[kind].map) state[kind].map.invalidateSize();
            }, 200);
          });

          modal.addEventListener("hidden.bs.modal", function () {
            _stopWatch(kind);
          });
        });
      })();

      document.getElementById('filterTanggal').addEventListener('change', function() {
        const selectedDate = this.value; // Format: YYYY-MM-DD
        const slides = document.querySelectorAll('.filter-item');
        let visibleCount = 0;

        slides.forEach(slide => {
            // Ambil data tanggal dari atribut HTML
            // Asumsi format di Excel/DB bisa jadi DD/MM/YYYY atau YYYY-MM-DD
            // Kita ambil raw stringnya
            let slideDateRaw = slide.getAttribute('data-tanggal'); 
            
            // Konversi sederhana jika format beda (opsional, sesuaikan dengan data sheetmu)
            // Kalau di sheetmu sudah YYYY-MM-DD, logic ini lebih simpel:
            
            if (slideDateRaw === selectedDate) {
                slide.style.display = 'block'; // Tampilkan
                visibleCount++;
            } else {
                slide.style.display = 'none'; // Sembunyikan
            }
        });

        // Tampilkan pesan jika kosong
        const noDataMsg = document.getElementById('noDataMessage');
        if (visibleCount === 0) {
            noDataMsg.style.display = 'block';
        } else {
            noDataMsg.style.display = 'none';
        }
    });

    function resetFilter() {
        document.getElementById('filterTanggal').value = '';
        const slides = document.querySelectorAll('.filter-item');
        slides.forEach(slide => {
            slide.style.display = 'block';
        });
        document.getElementById('noDataMessage').style.display = 'none';
    }

    document.addEventListener("DOMContentLoaded", function() {
        
        const filterInput = document.getElementById('filterTanggal');
        const slides = document.querySelectorAll('.filter-item');
        const noDataMsg = document.getElementById('noDataMessage');

        // Event saat tanggal diganti
        filterInput.addEventListener('change', function() {
            const selectedDate = this.value; // Hasilnya format: '2025-12-28'
            let visibleCount = 0;

            slides.forEach(slide => {
                // Ambil data tanggal dari HTML (yang sudah kita set jadi ISO juga)
                const itemDate = slide.getAttribute('data-tanggal');
                if (itemDate === selectedDate) {
                    slide.style.display = 'block'; // Muncul
                    visibleCount++;
                } else {
                    slide.style.display = 'none'; // Sembunyi
                }
            });

            // Tampilkan pesan jika tidak ada yang cocok
            if (visibleCount === 0) {
                noDataMsg.style.display = 'block';
            } else {
                noDataMsg.style.display = 'none';
            }
        });

        // Fungsi Reset (Opsional, pasang di tombol Reset)
        window.resetFilter = function() {
            filterInput.value = ''; // Kosongkan input
            slides.forEach(slide => slide.style.display = 'block'); // Tampilkan semua
            noDataMsg.style.display = 'none';
        };

    });
    </script>
  </body>
</html>
