<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Peta Bencana SUMUT - SATGAS USU</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <style>
      /* Global loading overlay shown during form POSTs */
      #globalLoadingOverlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 11000; /* above modals */
        align-items: center;
        justify-content: center;
      }
      #globalLoadingOverlay .card {
        background: rgba(255, 255, 255, 0.98);
        padding: 1rem 1.25rem;
        border-radius: 8px;
        display: flex;
        gap: 0.75rem;
        align-items: center;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>

  <body>
    <!-- Global loading overlay shown during POST -->
    <div id="globalLoadingOverlay" role="status" aria-hidden="true">
      <div class="card">
        <div
          class="spinner-border text-primary"
          role="status"
          aria-hidden="true"
          style="width: 2rem; height: 2rem"
        ></div>
        <div>
          <div class="small text-muted loading-text">Mohon tunggu.</div>
        </div>
      </div>
    </div>
    <div class="flash-message-container">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="alert alert-{{ category }} alert-dismissible fade show shadow-lg"
        role="alert"
      >
        <i class="fas fa-exclamation-circle me-2"></i>
        <strong>Perhatian!</strong> {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      {% endfor %} {% endif %} {% endwith %}
    </div>

    <div
      id="map-legend"
      class="bg-white p-2 rounded shadow-sm"
      style="
        position: absolute;
        bottom: 30px;
        left: 15px;
        z-index: 999;
        font-size: 12px;
      "
    >
      <h6 class="mb-2 fw-bold">Status Wilayah</h6>
      <div class="d-flex align-items-center mb-1">
        <span
          style="
            width: 15px;
            height: 15px;
            background: #ef4444;
            display: inline-block;
            margin-right: 5px;
            border-radius: 3px;
          "
        ></span>
        Tanggap Darurat
      </div>
      <div class="d-flex align-items-center mb-1">
        <span
          style="
            width: 15px;
            height: 15px;
            background: #eab308;
            display: inline-block;
            margin-right: 5px;
            border-radius: 3px;
          "
        ></span>
        Siaga Darurat
      </div>
      <div class="d-flex align-items-center">
        <span
          style="
            width: 15px;
            height: 15px;
            background: #22c55e;
            display: inline-block;
            margin-right: 5px;
            border-radius: 3px;
          "
        ></span>
        Normal
      </div>
    </div>
    <div id="map"></div>

    <!-- Tombol Refresh Map -->
    <button
      id="refreshMapBtn"
      type="button"
      class="btn btn-success shadow-sm"
      style="
        position: absolute;
        top: 15px;
        left: 48px;
        z-index: 1000;
        border-radius: 25px;
      "
      title="Refresh Data Map"
    >
      <i class="fas fa-sync-alt"></i> Refresh Map
    </button>

    <button id="sidebarToggle" type="button" class="btn btn-light shadow-sm">
      <i class="fas fa-bars"></i>
    </button>

    <div id="sidebar">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 sidebar-title">MONITORING SATGAS USU</h4>
        <button
          id="sidebarClose"
          class="btn btn-close-sidebar d-lg-none"
          type="button"
          aria-label="Close"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      {% if logged_in %}
      <div
        class="user-profile-card p-3 mb-3 bg-light border rounded-3 d-flex align-items-center gap-3"
      >
        <div class="bg-white p-2 rounded-circle shadow-sm text-success">
          <i class="fas fa-user-circle fa-lg"></i>
        </div>
        <div>
          <small
            class="text-muted d-block"
            style="font-size: 0.75rem; line-height: 1"
            >Relawan Aktif</small
          >
          <strong class="text-dark">{{ nama_relawan }}</strong>
        </div>
      </div>

      <div class="d-grid gap-2">
      <button class="btn btn-info feature-btn" data-bs-toggle="modal" data-bs-target="#inputLokasiModal">
  <i class="fas fa-map-marker-alt"></i> Input Lokasi
</button>
        <button
          class="btn btn-primary feature-btn"
          data-bs-toggle="modal"
          data-bs-target="#permintaanModal"
        >
          <i class="fas fa-box"></i> Permintaan Logistik
        </button>
        <button
          class="btn btn-success feature-btn"
          data-bs-toggle="modal"
          data-bs-target="#absensiModal"
        >
          <i class="fas fa-location-dot"></i> Absensi Lokasi
        </button>
        {#Tambah Untuk Asesmen Kesehatan#}
        <button
          class="btn btn-success feature-btn"
          data-bs-toggle="modal"
          data-bs-target="#asesmenKesehatanModal"
        >
          <i class="fas fa-heartbeat me-2"></i> Asesmen Kesehatan
        </button>
        {#Tambah Untuk Asesmen Pendidikan#}
        <button
          class="btn btn-success feature-btn"
          data-bs-toggle="modal"
          data-bs-target="#asesmenPendidikanModal"
        >
          <i class="fas fa-graduation-cap me-2"></i> Asesmen Pendidikan
        </button>
        {#Tambah Untuk Asesmen Psikososial#}
        <button
          class="btn btn-success feature-btn"
          data-bs-toggle="modal"
          data-bs-target="#asesmenPsikososialModal"
        >
          <i class="fa-solid fa-hand-holding-heart me-2"></i> Asesmen
          Psikososial
        </button>
        {#Tambah Untuk Asesmen Infrastruktur#}
        <button
          class="btn btn-success feature-btn"
          data-bs-toggle="modal"
          data-bs-target="#asesmenInfrastrukturModal"
        >
          <i class="fa-solid fa-screwdriver-wrench me-2"></i> Asesmen
          Infrastruktur
        </button>
        {#Tambah Untuk Asesmen Wash#}
        <button
          class="btn btn-success feature-btn"
          data-bs-toggle="modal"
          data-bs-target="#asesmenWashModal"
        >
          <i class="fa-solid fa-droplet me-2"></i> Asesmen WASH
        </button>
        {#Tambah Untuk Asesmen Kondisi#}
        <button
          class="btn btn-success feature-btn"
          data-bs-toggle="modal"
          data-bs-target="#asesmenKondisiModal"
        >
          <i class="fa-solid fa-clipboard-list me-2"></i> Asesmen Kondisi
        </button>
        {% if is_admin %}

        <button
          class="btn btn-warning feature-btn"
          data-bs-toggle="modal"
          data-bs-target="#permintaanAdminModal"
        >
          <i class="fas fa-gear"></i> Pengaturan Permintaan
        </button>

        {% endif %}

        <form
          action="{{ url_for('logout') }}"
          method="post"
          style="display: inline"
          id="logoutForm"
        >
          <button
            type="button"
            class="btn btn-danger feature-btn w-100"
            data-bs-toggle="modal"
            data-bs-target="#logoutConfirmModal"
          >
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </form>
      </div>
      {% else %}
      <button
        class="btn btn-primary feature-btn"
        data-bs-toggle="modal"
        data-bs-target="#loginModal"
      >
        <i class="fas fa-sign-in-alt"></i> TAMBAH DATA
      </button>
      {% endif %}

      <!-- ================== FILTER LAYER (CHECKLIST) ================== -->
      <div class="p-2 bg-light rounded-3 mb-3" id="layerFilterPanel">
        <div class="fw-bold mb-2">
          <i class="fas fa-filter me-2"></i>Filtrasi Layer
        </div>

        <!-- Asesmen -->
        <div class="mb-2">
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-bold">
              <i class="fas fa-layer-group me-2"></i>Asesmen
            </div>
            <button
              class="btn btn-sm btn-link text-decoration-none p-0"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#filterAsesmenBody"
              aria-expanded="true"
              aria-controls="filterAsesmenBody"
            >
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>

          <div class="form-check mt-1">
            <input
              class="form-check-input"
              type="checkbox"
              id="toggleAsesmenAll"
              checked
            />
            <label class="form-check-label" for="toggleAsesmenAll"
              >Asesmen</label
            >
          </div>

          <div class="collapse show ms-3 mt-1" id="filterAsesmenBody">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="toggleAsesmenKesehatan"
                checked
              />
              <label class="form-check-label" for="toggleAsesmenKesehatan"
                >Asesmen Kesehatan</label
              >
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="toggleAsesmenPendidikan"
                checked
              />
              <label class="form-check-label" for="toggleAsesmenPendidikan"
                >Asesmen Pendidikan</label
              >
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="toggleAsesmenPsikososial"
                checked
              />
              <label class="form-check-label" for="toggleAsesmenPsikososial"
                >Asesmen Psikososial</label
              >
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="toggleAsesmenInfrastruktur"
                checked
              />
              <label class="form-check-label" for="toggleAsesmenInfrastruktur"
                >Asesmen Infrastruktur</label
              >
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="toggleAsesmenWash"
                checked
              />
              <label class="form-check-label" for="toggleAsesmenWash"
                >Asesmen Wash</label
              >
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="toggleAsesmenKondisi"
                checked
              />
              <label class="form-check-label" for="toggleAsesmenKondisi"
                >Asesmen Kondisi</label
              >
            </div>
          </div>
        </div>

        <!-- Lokasi -->
        <div class="mb-2">
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-bold">
              <i class="fas fa-map-marker-alt me-2"></i>Lokasi
            </div>
            <button
              class="btn btn-sm btn-link text-decoration-none p-0"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#filterLokasiBody"
              aria-expanded="true"
              aria-controls="filterLokasiBody"
            >
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>

          <div class="form-check mt-1">
            <input
              class="form-check-input"
              type="checkbox"
              id="toggleLokasiAll"
              checked
            />
            <label class="form-check-label" for="toggleLokasiAll">Lokasi</label>
          </div>

          <div class="collapse show ms-3 mt-1" id="filterLokasiBody">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="toggleLokasiPosko"
                checked
              />
              <label class="form-check-label" for="toggleLokasiPosko"
                >Posko Pengungsian</label
              >
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="toggleLokasiGudang"
                checked
              />
              <label class="form-check-label" for="toggleLokasiGudang"
                >Gudang Logistik</label
              >
            </div>
            {#
            <div class="form-check">
              #} {#
              <input
                class="form-check-input"
                type="checkbox"
                id="toggleLokasiLain"
                checked
              />#} {#
              <label class="form-check-label" for="toggleLokasiLain"
                >Lokasi</label
              >#} {#
            </div>
            #}
          </div>
        </div>

        <!-- Relawan -->
        <div class="mb-2">
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-bold"><i class="fas fa-user me-2"></i>Relawan</div>
            <button
              class="btn btn-sm btn-link text-decoration-none p-0"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#filterRelawanBody"
              aria-expanded="true"
              aria-controls="filterRelawanBody"
            >
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>

          <div class="form-check mt-1">
            <input
              class="form-check-input"
              type="checkbox"
              id="toggleRelawanAll"
              checked
            />
            <label class="form-check-label" for="toggleRelawanAll"
              >Relawan</label
            >
          </div>

          <div class="collapse show ms-3 mt-1" id="filterRelawanBody">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="toggleLokasiRelawan"
                checked
              />
              <label class="form-check-label" for="toggleLokasiRelawan"
                >Lokasi Relawan</label
              >
            </div>
          </div>
        </div>

        <!-- Permintaan Logistik -->
        <div>
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-bold">
              <i class="fas fa-box-open me-2"></i>Permintaan Logistik
            </div>
            <button
              class="btn btn-sm btn-link text-decoration-none p-0"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#filterPermintaanBody"
              aria-expanded="true"
              aria-controls="filterPermintaanBody"
            >
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>

          <div class="form-check mt-1">
            <input
              class="form-check-input"
              type="checkbox"
              id="togglePermintaanLogistik"
              checked
            />
            <label class="form-check-label" for="togglePermintaanLogistik"
              >Permintaan Logistik</label
            >
          </div>

          <div class="collapse show ms-3 mt-1" id="filterPermintaanBody">
            <div class="fw-bold mb-1" style="font-size: 0.85rem">
              Titik Permintaan (Status)
            </div>

            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="togglePermintaanDraft"
                checked
              />
              <label class="form-check-label" for="togglePermintaanDraft">
                <span
                  style="
                    display: inline-block;
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    background: #64748b;
                    margin-right: 6px;
                  "
                ></span>
                Draft
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="togglePermintaanDiproses"
                checked
              />
              <label class="form-check-label" for="togglePermintaanDiproses">
                <span
                  style="
                    display: inline-block;
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    background: #f59e0b;
                    margin-right: 6px;
                  "
                ></span>
                Diproses
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="togglePermintaanDikirim"
                checked
              />
              <label class="form-check-label" for="togglePermintaanDikirim">
                <span
                  style="
                    display: inline-block;
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    background: #3b82f6;
                    margin-right: 6px;
                  "
                ></span>
                Dikirim
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="togglePermintaanDiterima"
                checked
              />
              <label class="form-check-label" for="togglePermintaanDiterima">
                <span
                  style="
                    display: inline-block;
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    background: #22c55e;
                    margin-right: 6px;
                  "
                ></span>
                Diterima
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="togglePermintaanDitolak"
                checked
              />
              <label class="form-check-label" for="togglePermintaanDitolak">
                <span
                  style="
                    display: inline-block;
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    background: #ef4444;
                    margin-right: 6px;
                  "
                ></span>
                Ditolak
              </label>
            </div>
            {#
            <div class="form-check">
              #} {#
              <input
                class="form-check-input"
                type="checkbox"
                id="togglePermintaanSelesai"
                checked
              />#} {#
              <label class="form-check-label" for="togglePermintaanSelesai"
                >#} {#
                <span
                  style="
                    display: inline-block;
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    background: #10b981;
                    margin-right: 6px;
                  "
                ></span
                >#} {# Selesai#} {# </label
              >#} {#
            </div>
            #}
          </div>
        </div>
      </div>
      <!-- =============================================================== -->

      <hr />

      <h5>
        <i class="fas fa-warehouse"></i> Stok Gudang Pusat (Posko Logistik USU)
      </h5>
      <div class="row row-cols-2 g-2 mb-3">
        {% for stok in stok_gudang %} {% if stok.get('kode_gudang') == 'G-ME001'
        and stok.get('nama_barang') %}
        <div class="col">
          <div
            class="card data-card border-{{ 'danger' if stok.get('stok_akhir')|int <= 0 else 'success' }}"
          >
            <div class="card-body p-2">
              <h6 class="card-title mb-0 small text-truncate">
                {{ stok.get('nama_barang') }}
              </h6>
              <p class="card-text mb-0 fw-bold">
                {% if stok.get('stok_akhir') >= 0 %} {{ stok.get('stok_akhir')
                }} {% else %} Kurang {{ stok.get('stok_akhir') | abs }} {% endif
                %}
              </p>
            </div>
          </div>
        </div>
        {% endif %} {% endfor %}
      </div>

      <hr />

      <h5><i class="fas fa-chart-bar"></i> Data Bencana & Korban</h5>
      <div class="bencana-carousel-container">
        <div class="bencana-carousel-wrapper">
          <div class="bencana-carousel-track" id="bencanaCarousel">
            {% for rekap in rekap_kabkota %} {% if
            (rekap.get('korban_meninggal') or 0) >= 0 or
            (rekap.get('kk_terdampak') or 0) >= 0 %}
            <div class="bencana-slide mt-2">
              <div class="card data-card-kabupaten border-danger mb-2">
                <div class="card-body p-2">
                  <h6 class="card-title mb-1 fw-bold">
                    {{ rekap.get('kabkota') }}
                  </h6>
                  <p class="card-text mb-0 small">
                    <i class="fas fa-skull-crossbones text-danger"></i>
                    Meninggal: {{ rekap.get('korban_meninggal') or 0 }} |
                    <i class="fas fa-home text-warning"></i>
                    KK Terdampak: {{ rekap.get('kk_terdampak') or 0 }}
                  </p>
                </div>
              </div>
            </div>
            {% endif %} {% endfor %}
          </div>
        </div>
        <div class="bencana-pagination" id="bencanaPagination"></div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div
      class="modal fade"
      id="logoutConfirmModal"
      tabindex="-1"
      aria-labelledby="logoutConfirmModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="logoutConfirmModalLabel">
              <i class="fas fa-sign-out-alt"></i> Konfirmasi Logout
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p class="mb-0">Anda yakin ingin logout?</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal
            </button>
            <button type="button" class="btn btn-danger" id="confirmLogoutBtn">
              Yakin
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="loginModal"
      tabindex="-1"
      aria-labelledby="loginModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="loginModalLabel">
              <i class="fas fa-user-lock"></i> Login Relawan SATGAS USU
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form action="{{ url_for('login') }}" method="POST">
            <div class="modal-body">
              <div class="mb-3">
                <label for="nama" class="form-label">Nama Relawan</label>
                <div class="input-group dropdown" id="relawanDropdownWrap">
                  <input
                    class="form-control"
                    id="nama"
                    name="nama"
                    list="relawanDatalist"
                    placeholder="Ketik nama Anda..."
                    autocomplete="off"
                    required
                  />
                  <button
                    class="btn btn-outline-secondary dropdown-toggle"
                    type="button"
                    id="relawanDropdownBtn"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    title="Tampilkan daftar"
                  ></button>
                  <ul
                    class="dropdown-menu dropdown-menu-end"
                    id="relawanDropdownMenu"
                    style="max-height: 260px; overflow: auto"
                  ></ul>
                </div>
                <div class="form-text">
                  Ketik untuk mencari, lalu pilih dari daftar.
                </div>
                <datalist id="relawanDatalist">
                  {% for relawan in relawan_list %}
                  <option value="{{ relawan.get('nama_relawan') }}"></option>
                  {% endfor %}
                </datalist>
              </div>
              <div class="mb-3">
                <label for="kode_akses" class="form-label">Kode Akses</label>
                <div class="input-group">
                  <input
                    type="password"
                    class="form-control"
                    id="kode_akses"
                    name="kode_akses"
                    placeholder="Masukkan Kode Akses"
                    required
                  />
                  <button
                    class="btn btn-outline-secondary"
                    type="button"
                    id="toggleKodeAkses"
                    title="Tampilkan/Sembunyikan"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button type="submit" class="btn btn-primary">Login</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="permintaanModal"
      tabindex="-1"
      aria-labelledby="permintaanModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="permintaanModalLabel">
              <i class="fas fa-box-open"></i> Input Permintaan Posko
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form action="{{ url_for('submit_permintaan') }}" method="POST">
            <div class="modal-body">
              <!-- Lokasi GPS Saat Ini (Permintaan Logistik) -->
              <div class="mb-3 p-3 bg-light rounded">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <div class="fw-bold">
                    <i class="fas fa-map-marker-alt"></i> Lokasi GPS Saat Ini:
                  </div>
                  <button
                    type="button"
                    id="refreshPermintaanLocationBtn"
                    class="btn btn-success btn-sm shadow-sm"
                    title="Refresh Lokasi"
                    style="border-radius: 20px"
                    onclick="getLocationForPermintaan()"
                  >
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>

                <div class="text-success fw-bold">
                  <span id="permintaan-location-text">belum diambil</span>
                </div>
              </div>

              <input
                type="hidden"
                id="permintaan_lat"
                name="latitude"
                required
              />
              <input
                type="hidden"
                id="permintaan_lon"
                name="longitude"
                required
              />
              <div class="mb-2 text-muted small">
                <i class="fas fa-map me-1"></i>
                Koreksi titik: geser pin atau klik peta sebelum submit.
              </div>
              <div
                id="permintaanMiniMap"
                style="
                  height: 220px;
                  border-radius: 12px;
                  overflow: hidden;
                  border: 1px solid #e5e7eb;
                "
              ></div>

              <div class="mt-3 mb-3">
                <label for="kode_posko" class="form-label"
                  ><i class="fas fa-campground"></i> Posko Tujuan</label
                >
                <select
                  class="form-select"
                  id="kode_posko"
                  name="kode_posko"
                  required
                >
                  <option value="" selected disabled>Pilih Posko Tujuan</option>
                  {% for posko in data_posko %}
                  <option value="{{ posko.kode }}">
                    {{ posko.nama }} ({{ posko.kode }})
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label for="keterangan" class="form-label"
                  >Masukkan Keterangan Barang & Jumlah</label
                >
                <textarea
                  class="form-control"
                  id="keterangan"
                  name="keterangan"
                  rows="2"
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="submit"
                class="btn btn-primary"
                id="btn-submit-permintaan"
                disabled
              >
                Kirim Permintaan
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {% if is_admin %}
    <div
      class="modal fade"
      id="permintaanAdminModal"
      tabindex="-1"
      aria-labelledby="permintaanAdminModalLabel"
      aria-hidden="true"
    >
      <div
        class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable"
      >
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title" id="permintaanAdminModalLabel">
              <i class="fas fa-gear"></i> Pengaturan Status Permintaan Logistik
            </h5>
            <div class="d-flex gap-2 align-items-center">
              <button
                type="button"
                class="btn btn-sm btn-light"
                id="btnRefreshPermintaanAdmin"
                title="Refresh Data"
              >
                <i class="fas fa-sync-alt"></i>
              </button>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
          </div>
          <div class="modal-body">
            <div class="alert alert-info small mb-3">
              <i class="fas fa-info-circle me-1"></i>
              Hanya relawan admin yang bisa mengubah status. Perubahan akan
              langsung tersimpan ke database.
            </div>

            <div class="table-responsive">
              <table class="table table-sm table-bordered align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width: 90px">ID</th>
                    <th style="width: 240px">Posko</th>
                    <th style="width: 170px">Waktu</th>
                    <th>Keterangan</th>
                    <th style="width: 150px">Status</th>
                    <th style="width: 190px">Ubah Status</th>
                  </tr>
                </thead>
                <tbody id="permintaanAdminTableBody">
                  <tr>
                    <td colspan="6" class="text-muted text-center">
                      Memuat...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Tutup
            </button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <div
      class="modal fade"
      id="absensiModal"
      tabindex="-1"
      aria-labelledby="absensiModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="absensiModalLabel">
              <i class="fas fa-map-marker-alt"></i> Absensi Lokasi Relawan
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form
            action="{{ url_for('submit_absensi') }}"
            method="POST"
            id="absensiForm"
          >
            <div class="modal-body">
              <div class="mb-3 p-3 bg-light rounded">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <label class="form-label mb-0"
                    ><i class="fas fa-map-marker-alt"></i> Lokasi GPS Saat
                    Ini:</label
                  >
                  <button
                    type="button"
                    class="btn btn-success btn-sm shadow-sm"
                    id="refreshLocationBtn"
                    title="Refresh Lokasi"
                    style="border-radius: 20px"
                  >
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
                <p class="mb-0">
                  <span id="current-location" class="text-primary fw-bold"
                    >Mencari lokasi...</span
                  >
                </p>
                <div class="mt-3">
                  <small class="text-muted d-block mb-2">
                    <i class="fas fa-map"></i> Koreksi titik: geser pin atau
                    klik peta sebelum submit.
                  </small>
                  <div
                    id="absensiMiniMap"
                    style="
                      height: 230px;
                      border-radius: 12px;
                      overflow: hidden;
                      border: 1px solid #e5e7eb;
                    "
                  ></div>
                </div>
              </div>
              <input type="hidden" id="absensi_lat" name="latitude" required />
              <input type="hidden" id="absensi_lon" name="longitude" required />
              <div class="mb-3">
                <label for="catatan" class="form-label"
                  >Catatan Kegiatan/Kondisi</label
                >
                <textarea
                  class="form-control"
                  id="catatan"
                  name="catatan"
                  rows="3"
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="submit"
                class="btn btn-success"
                id="btn-submit-absensi"
                disabled
              >
                Submit Absensi
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

{#    MODAL DATA INPUT LOKASI #}
<div class="modal fade" id="inputLokasiModal" tabindex="-1" aria-labelledby="inputLokasiModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="inputLokasiModalLabel">
          <i class="fas fa-map-marker-alt"></i> Input Lokasi (data_lokasi)
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form action="{{ url_for('submit_lokasi') }}" method="POST">
        <div class="modal-body">

          <!-- Lokasi GPS Saat Ini -->
          <div class="mb-3 p-3 bg-light rounded">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold">
                <i class="fas fa-map-marker-alt"></i> Lokasi GPS Saat Ini:
              </div>
              <span id="lokasi-location-status" class="badge bg-secondary">Menunggu</span>
            </div>
            <div id="lokasi-location-text" class="small text-muted">Menunggu lokasi...</div>

            <!-- hidden lat/lon (diisi otomatis oleh modul mini-map yg sudah ada) -->
            <input type="hidden" id="lokasi_lat" name="latitude" required>
            <input type="hidden" id="lokasi_lon" name="longitude" required>

            <div class="mb-2 text-muted small">
              <i class="fas fa-map me-1"></i>
              Koreksi titik: geser pin atau klik peta sebelum submit.
            </div>
            <div id="inputLokasiMiniMap"
                 style="height:220px;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb;"></div>
          </div>

          <!-- Dropdown utama -->
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label"><i class="fas fa-tags"></i> Jenis Lokasi</label>
              <select class="form-select" name="jenis_lokasi" required>
                <option value="">-- pilih --</option>

                {% if ref_jenis_lokasi and ref_jenis_lokasi|length > 0 %}
                  {% for v in ref_jenis_lokasi %}
                    <option value="{{ v }}">{{ v }}</option>
                  {% endfor %}
                {% else %}
                  <!-- fallback kalau ref table kosong -->
                  <option value="Posko Pengungsian">Posko Pengungsian</option>
                  <option value="Gudang Logistik">Gudang Logistik</option>
                {% endif %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label"><i class="fas fa-city"></i> Nama Kab/Kota</label>
              <select class="form-select" name="nama_kabkota" required>
                <option value="">-- pilih --</option>

                {% if ref_kabkota and ref_kabkota|length > 0 %}
                  {% for v in ref_kabkota %}
                    <option value="{{ v }}">{{ v }}</option>
                  {% endfor %}
                {% else %}
                  <!-- fallback minimal -->
                  <option value="Kota Medan">Kota Medan</option>
                  <option value="Kabupaten Tapanuli Tengah">Kabupaten Tapanuli Tengah</option>
                {% endif %}
              </select>

              <div class="form-text">Auto ID: prefix + kode kab/kota + increment (di Python).</div>
            </div>

            <div class="col-md-4">
              <label class="form-label"><i class="fas fa-location-arrow"></i> Nama Lokasi</label>
              <input type="text" class="form-control" name="nama_lokasi" required
                     placeholder="Contoh: Posko Utama / Gudang Induk">
            </div>
          </div>

          <!-- Dropdown status/akses/kondisi -->
          <div class="row g-2 mt-2">
            <div class="col-md-4">
              <label class="form-label">Status Lokasi</label>
              <select class="form-select" name="status_lokasi">
                {% if ref_status_lokasi and ref_status_lokasi|length > 0 %}
                  {% for v in ref_status_lokasi %}
                    <option value="{{ v }}" {% if v|lower == "aktif" %}selected{% endif %}>{{ v }}</option>
                  {% endfor %}
                {% else %}
                  <option value="Aktif" selected>Aktif</option>
                  <option value="Nonaktif">Nonaktif</option>
                {% endif %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Tingkat Akses</label>
              <select class="form-select" name="tingkat_akses">
                {% if ref_tingkat_akses and ref_tingkat_akses|length > 0 %}
                  {% for v in ref_tingkat_akses %}
                    <option value="{{ v }}" {% if v|lower == "public" %}selected{% endif %}>{{ v }}</option>
                  {% endfor %}
                {% else %}
                  <option value="Public" selected>Public</option>
                  <option value="Internal">Internal</option>
                {% endif %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Kondisi</label>
              <select class="form-select" name="kondisi">
                {% if ref_kondisi and ref_kondisi|length > 0 %}
                  {% for v in ref_kondisi %}
                    <option value="{{ v }}" {% if v|lower == "normal" %}selected{% endif %}>{{ v }}</option>
                  {% endfor %}
                {% else %}
                  <option value="Normal" selected>Normal</option>
                  <option value="Rusak Ringan">Rusak Ringan</option>
                  <option value="Rusak Berat">Rusak Berat</option>
                {% endif %}
              </select>
            </div>
          </div>

          <!-- alamat & admin -->
          <div class="mt-3">
            <label class="form-label"><i class="fas fa-road"></i> Alamat</label>
            <input type="text" class="form-control" name="alamat" placeholder="Alamat singkat">
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-6">
              <label class="form-label">Kecamatan</label>
              <input type="text" class="form-control" name="kecamatan">
            </div>
            <div class="col-md-6">
              <label class="form-label">Desa/Kelurahan</label>
              <input type="text" class="form-control" name="desa_kelurahan">
            </div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-6">
              <label class="form-label">PIC</label>
              <input type="text" class="form-control" name="pic">
            </div>
            <div class="col-md-6">
              <label class="form-label">PIC HP</label>
              <input type="text" class="form-control" name="pic_hp" placeholder="08xxxxxxxxxx">
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label"><i class="fas fa-sticky-note"></i> Catatan</label>
            <textarea class="form-control" name="catatan" rows="3"></textarea>
          </div>

          <!-- optional -->
          <input type="hidden" name="lokasi_text" value="">
          <input type="hidden" name="photo_path" value="">

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" id="btn-submit-lokasi" class="btn btn-info" disabled>
            <i class="fas fa-save"></i> Simpan Lokasi
          </button>
        </div>
      </form>

    </div>
  </div>
</div>
    <!-- ===================== MODAL ASESMEN KESEHATAN ===================== -->
    <div
      class="modal fade"
      id="asesmenKesehatanModal"
      tabindex="-1"
      aria-labelledby="asesmenKesehatanLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form
            method="POST"
            action="{{ url_for('submit_asesmen_kesehatan') }}"
          >
            <div class="modal-header">
              <h5 class="modal-title" id="asesmenKesehatanLabel">
                Asesmen Kesehatan
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <!-- Lokasi GPS Saat Ini (Asesmen Kesehatan) -->
              <div class="mb-3 p-3 bg-light rounded">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <div class="fw-bold">
                    <i class="fas fa-map-marker-alt"></i> Lokasi GPS Saat Ini:
                  </div>
                  <button
                    type="button"
                    id="refreshKesehatanLocationBtn"
                    class="btn btn-success btn-sm shadow-sm"
                    title="Refresh Lokasi"
                    style="border-radius: 20px"
                    onclick="getLocationForAsesmen('kesehatan')"
                  >
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>

                <div class="text-success fw-bold">
                  <span id="kesehatan-location-text">belum diambil</span>
                </div>
              </div>

              <input type="hidden" id="kesehatan_lat" name="latitude" />
              <input type="hidden" id="kesehatan_lon" name="longitude" />
              <div class="mb-2 text-muted small">
                <i class="fas fa-map me-1"></i>
                Koreksi titik: geser pin atau klik peta sebelum submit.
              </div>
              <div
                id="kesehatanMiniMap"
                style="
                  height: 220px;
                  border-radius: 12px;
                  overflow: hidden;
                  border: 1px solid #e5e7eb;
                "
              ></div>
              <div class="mb-3">
                <label class="form-label">Pilih Posko</label>
                <select class="form-select" name="kode_posko" required>
                  <option value="" selected disabled>-- pilih posko --</option>
                  {% for p in data_posko %}
                  <option value="{{ p.kode }}">
                    {{ p.kode }} - {{ p.nama }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Radius Buffer (km)</label>
                <div class="input-group">
                  <input
                    type="number"
                    class="form-control"
                    id="kesehatan_radius"
                    name="radius"
                    min="0.1"
                    step="0.1"
                    value="2"
                  />
                  <span class="input-group-text">km</span>
                </div>
                <div class="form-text">
                  Default 2 km. Nilai ini menentukan buffer pada peta setelah
                  asesmen disubmit.
                </div>
              </div>

              <div class="mb-2">
                <small class="text-muted">
                  Skala penilaian: 1 Sangat Baik, 2 Baik, 3 Cukup, 4 Kurang, 5
                  Sangat Kurang.
                </small>
              </div>

              <!-- 5 pertanyaan skala 1-5 -->
              {% set kesehatan_questions = [ "1. Ada pengungsi sakit/cedera yang
              butuh penanganan segera?", "2. Ketersediaan obat-obatan dan P3K
              mencukupi?", "3. Ketersediaan tenaga medis (dokter/perawat/bidan)
              di posko?", "4. Ketersediaan air bersih untuk kebutuhan minum &
              kebersihan?", "5. Sanitasi/toilet dan pengelolaan limbah di posko
              memadai?", ] %} {% for i in range(1,6) %}
              <div class="mb-3">
                <label class="form-label">{{ kesehatan_questions[i-1] }}</label>
                <select class="form-select" name="p{{ i }}" required>
                  <option value="1">1 - Sangat Baik</option>
                  <option value="2">2 - Baik</option>
                  <option value="3" selected>3 - Cukup</option>
                  <option value="4">4 - Kurang</option>
                  <option value="5">5 - Sangat Kurang</option>
                </select>
              </div>
              {% endfor %}

              <div class="mb-3">
                <label class="form-label">Catatan (opsional)</label>
                <textarea
                  class="form-control"
                  name="catatan"
                  rows="3"
                ></textarea>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="submit"
                class="btn btn-success"
                id="btn-submit-kesehatan"
                disabled
              >
                Submit
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===================== MODAL ASESMEN PENDIDIKAN ===================== -->
    <div
      class="modal fade"
      id="asesmenPendidikanModal"
      tabindex="-1"
      aria-labelledby="asesmenPendidikanLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form
            method="POST"
            action="{{ url_for('submit_asesmen_pendidikan') }}"
          >
            <div class="modal-header">
              <h5 class="modal-title" id="asesmenPendidikanLabel">
                Asesmen Pendidikan
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <!-- Lokasi GPS Saat Ini (Asesmen Pendidikan) -->
              <div class="mb-3 p-3 bg-light rounded">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <div class="fw-bold">
                    <i class="fas fa-map-marker-alt"></i> Lokasi GPS Saat Ini:
                  </div>
                  <button
                    type="button"
                    id="refreshPendidikanLocationBtn"
                    class="btn btn-success btn-sm shadow-sm"
                    title="Refresh Lokasi"
                    style="border-radius: 20px"
                    onclick="getLocationForAsesmen('pendidikan')"
                  >
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>

                <div class="text-success fw-bold">
                  <span id="pendidikan-location-text">belum diambil</span>
                </div>
              </div>

              <input type="hidden" id="pendidikan_lat" name="latitude" />
              <input type="hidden" id="pendidikan_lon" name="longitude" />
              <div class="mb-2 text-muted small">
                <i class="fas fa-map me-1"></i>
                Koreksi titik: geser pin atau klik peta sebelum submit.
              </div>
              <div
                id="pendidikanMiniMap"
                style="
                  height: 220px;
                  border-radius: 12px;
                  overflow: hidden;
                  border: 1px solid #e5e7eb;
                "
              ></div>

              <div class="mb-3">
                <label class="form-label">Pilih Posko</label>
                <select class="form-select" name="kode_posko" required>
                  <option value="" selected disabled>-- pilih posko --</option>
                  {% for p in data_posko %}
                  <option value="{{ p.kode }}">
                    {{ p.kode }} - {{ p.nama }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Radius Buffer (km)</label>
                <div class="input-group">
                  <input
                    type="number"
                    class="form-control"
                    id="pendidikan_radius"
                    name="radius"
                    min="0.1"
                    step="0.1"
                    value="2"
                  />
                  <span class="input-group-text">km</span>
                </div>
                <div class="form-text">
                  Default 2 km. Nilai ini menentukan buffer pada peta setelah
                  asesmen disubmit.
                </div>
              </div>

              <!-- 10 pertanyaan skala 1-5 -->
              {% set pendidikan_questions = [ "1. Ruang belajar sementara
              tersedia dan layak digunakan?", "2. Anak usia sekolah terdata dan
              sudah terlayani kegiatan belajar?", "3. Ada tenaga
              pengajar/relawan pendidikan yang mendampingi?", "4. Alat tulis dan
              bahan ajar tersedia?", "5. Akses listrik/charging memadai untuk
              mendukung kegiatan belajar?", "6. Keamanan area belajar (aman dari
              risiko) terjaga?", "7. Jadwal/kegiatan belajar rutin berjalan?",
              "8. Dukungan psikososial anak (trauma/stres) tersedia/terhubung?",
              "9. Fasilitas sanitasi ramah anak memadai?", "10. Kebutuhan
              prioritas pendidikan sudah diidentifikasi dan ditindaklanjuti?", ]
              %} {% for i in range(1,11) %}
              <div class="mb-3">
                <label class="form-label"
                  >{{ pendidikan_questions[i-1] }}</label
                >
                <select class="form-select" name="p{{ i }}" required>
                  <option value="1">1 - Sangat Baik</option>
                  <option value="2">2 - Baik</option>
                  <option value="3" selected>3 - Cukup</option>
                  <option value="4">4 - Kurang</option>
                  <option value="5">5 - Sangat Kurang</option>
                </select>
              </div>
              {% endfor %}

              <div class="mb-3">
                <label class="form-label">Catatan (opsional)</label>
                <textarea
                  class="form-control"
                  name="catatan"
                  rows="3"
                ></textarea>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="submit"
                class="btn btn-success"
                id="btn-submit-pendidikan"
                disabled
              >
                Submit
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===================== MODAL ASESMEN PSIKOSOSIAL ===================== -->
    <div
      class="modal fade"
      id="asesmenPsikososialModal"
      tabindex="-1"
      aria-labelledby="asesmenPsikososialLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form
            method="POST"
            action="{{ url_for('submit_asesmen_psikososial') }}"
          >
            <div class="modal-header">
              <h5 class="modal-title" id="asesmenPsikososialLabel">
                Asesmen Psikososial
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <!-- Lokasi GPS Saat Ini (Asesmen Psikososial) -->
              <div class="mb-3 p-3 bg-light rounded">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <div class="fw-bold">
                    <i class="fas fa-map-marker-alt"></i> Lokasi GPS Saat Ini:
                  </div>
                  <button
                    type="button"
                    id="refreshPsikososialLocationBtn"
                    class="btn btn-success btn-sm shadow-sm"
                    title="Refresh Lokasi"
                    style="border-radius: 20px"
                    onclick="getLocationForAsesmen('psikososial')"
                  >
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>

                <div class="text-success fw-bold">
                  <span id="psikososial-location-text">belum diambil</span>
                </div>
              </div>

              <input type="hidden" id="psikososial_lat" name="latitude" />
              <input type="hidden" id="psikososial_lon" name="longitude" />
              <div class="mb-2 text-muted small">
                <i class="fas fa-map me-1"></i>
                Koreksi titik: geser pin atau klik peta sebelum submit.
              </div>
              <div
                id="psikososialMiniMap"
                style="
                  height: 220px;
                  border-radius: 12px;
                  overflow: hidden;
                  border: 1px solid #e5e7eb;
                "
              ></div>

              <div class="mb-3">
                <label class="form-label">Pilih Posko</label>
                <select class="form-select" name="kode_posko" required>
                  <option value="" selected disabled>-- pilih posko --</option>
                  {% for p in data_posko %}
                  <option value="{{ p.kode }}">
                    {{ p.kode }} - {{ p.nama }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Radius Buffer (km)</label>
                <div class="input-group">
                  <input
                    type="number"
                    class="form-control"
                    id="psikososial_radius"
                    name="radius"
                    min="0.1"
                    step="0.1"
                    value="2"
                  />
                  <span class="input-group-text">km</span>
                </div>
                <div class="form-text">
                  Default 2 km. Nilai ini menentukan buffer pada peta setelah
                  asesmen disubmit.
                </div>
              </div>

              <!-- 10 pertanyaan skala 1-5 -->
              {% set psikososial_questions = [ "1. Warga mendapatkan informasi
              resmi yang jelas dan konsisten?", "2. Tingkat stres/kecemasan
              warga saat ini terkendali?", "3. Anak-anak memiliki
              aktivitas/ruang aman yang membantu mengurangi stres?", "4.
              Kelompok rentan (lansia/disabilitas/ibu hamil) teridentifikasi dan
              didampingi?", "5. Rasa aman di lokasi pengungsian/posko terjaga
              (minim konflik/keributan)?", "6. Tanda stres berat/trauma (panik,
              insomnia berat, agresif) terpantau dan tertangani?", "7. Ada
              dukungan psikososial (PFA/konseling/rujukan layanan) yang bisa
              diakses?", "8. Dukungan komunitas/tokoh masyarakat aktif membantu
              pemulihan?", "9. Ada mekanisme pengaduan/perlindungan
              (kekerasan/kerentanan) yang berjalan?", "10. Kegiatan pemulihan
              rutin (dukungan emosi, edukasi coping, aktivitas komunitas)
              terlaksana?", ] %} {% for i in range(1,11) %}
              <div class="mb-3">
                <label class="form-label"
                  >{{ psikososial_questions[i-1] }}</label
                >
                <select class="form-select" name="p{{ i }}" required>
                  <option value="1">1 - Sangat Baik</option>
                  <option value="2">2 - Baik</option>
                  <option value="3" selected>3 - Cukup</option>
                  <option value="4">4 - Kurang</option>
                  <option value="5">5 - Sangat Kurang</option>
                </select>
              </div>
              {% endfor %}

              <div class="mb-3">
                <label class="form-label">Catatan (opsional)</label>
                <textarea
                  class="form-control"
                  name="catatan"
                  rows="3"
                ></textarea>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="submit"
                class="btn btn-success"
                id="btn-submit-psikososial"
                disabled
              >
                Submit
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===================== MODAL ASESMEN INFRASTRUKTUR ===================== -->
    <div
      class="modal fade"
      id="asesmenInfrastrukturModal"
      tabindex="-1"
      aria-labelledby="asesmenInfrastrukturLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form
            method="POST"
            action="{{ url_for('submit_asesmen_infrastruktur') }}"
          >
            <div class="modal-header">
              <h5 class="modal-title" id="asesmenInfrastrukturLabel">
                Asesmen Infrastruktur
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <!-- Lokasi GPS Saat Ini (Asesmen Infrastruktur) -->
              <div class="mb-3 p-3 bg-light rounded">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <div class="fw-bold">
                    <i class="fas fa-map-marker-alt"></i> Lokasi GPS Saat Ini:
                  </div>
                  <button
                    type="button"
                    id="refreshInfrastrukturLocationBtn"
                    class="btn btn-success btn-sm shadow-sm"
                    title="Refresh Lokasi"
                    style="border-radius: 20px"
                    onclick="getLocationForAsesmen('infrastruktur')"
                  >
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>

                <div class="text-success fw-bold">
                  <span id="infrastruktur-location-text">belum diambil</span>
                </div>
              </div>

              <input type="hidden" id="infrastruktur_lat" name="latitude" />
              <input type="hidden" id="infrastruktur_lon" name="longitude" />
              <div class="mb-2 text-muted small">
                <i class="fas fa-map me-1"></i>
                Koreksi titik: geser pin atau klik peta sebelum submit.
              </div>
              <div
                id="infrastrukturMiniMap"
                style="
                  height: 220px;
                  border-radius: 12px;
                  overflow: hidden;
                  border: 1px solid #e5e7eb;
                "
              ></div>

              <div class="mb-3">
                <label class="form-label">Pilih Posko</label>
                <select class="form-select" name="kode_posko" required>
                  <option value="" selected disabled>-- pilih posko --</option>
                  {% for p in data_posko %}
                  <option value="{{ p.kode }}">
                    {{ p.kode }} - {{ p.nama }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Radius Buffer (km)</label>
                <div class="input-group">
                  <input
                    type="number"
                    class="form-control"
                    id="infrastruktur_radius"
                    name="radius"
                    min="0.1"
                    step="0.1"
                    value="2"
                  />
                  <span class="input-group-text">km</span>
                </div>
                <div class="form-text">
                  Default 2 km. Nilai ini menentukan buffer pada peta setelah
                  asesmen disubmit.
                </div>
              </div>

              <!-- 10 pertanyaan skala 1-5 -->
              {% set infrastruktur_questions = [ "1. Akses jalan utama menuju
              lokasi/posko dapat dilalui kendaraan?", "2. Kondisi
              jembatan/titian/jalur penghubung utama aman digunakan?", "3.
              Jaringan listrik (PLN/genset) tersedia dan mencukupi untuk layanan
              dasar?", "4. Jaringan komunikasi (seluler/internet/radio) tersedia
              dan berfungsi?", "5. Akses transportasi untuk distribusi logistik
              memadai (jalan/armada tersedia)?", "6. Kondisi bangunan/rumah
              warga dominan masih layak huni?", "7. Kondisi tempat
              pengungsian/posko aman dari risiko (atap, struktur, lingkungan)?",
              "8. Drainase/saluran air berfungsi dan tidak tersumbat parah?",
              "9. Penerangan dan keamanan lingkungan malam hari memadai?", "10.
              Ada risiko bahaya lanjutan (longsor, reruntuhan, kabel listrik,
              dll) yang mengganggu aktivitas?", ] %} {% for i in range(1,11) %}
              <div class="mb-3">
                <label class="form-label"
                  >{{ infrastruktur_questions[i-1] }}</label
                >
                <select class="form-select" name="p{{ i }}" required>
                  <option value="1">1 - Sangat Baik</option>
                  <option value="2">2 - Baik</option>
                  <option value="3" selected>3 - Cukup</option>
                  <option value="4">4 - Kurang</option>
                  <option value="5">5 - Sangat Kurang</option>
                </select>
              </div>
              {% endfor %}

              <div class="mb-3">
                <label class="form-label">Catatan (opsional)</label>
                <textarea
                  class="form-control"
                  name="catatan"
                  rows="3"
                ></textarea>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="submit"
                class="btn btn-success"
                id="btn-submit-infrastruktur"
                disabled
              >
                Submit
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===================== MODAL ASESMEN WASH ===================== -->
    <div
      class="modal fade"
      id="asesmenWashModal"
      tabindex="-1"
      aria-labelledby="asesmenWashLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form method="POST" action="{{ url_for('submit_asesmen_wash') }}">
            <div class="modal-header">
              <h5 class="modal-title" id="asesmenWashLabel">Asesmen Wash</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <!-- Lokasi GPS Saat Ini (Asesmen Wash) -->
              <div class="mb-3 p-3 bg-light rounded">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <div class="fw-bold">
                    <i class="fas fa-map-marker-alt"></i> Lokasi GPS Saat Ini:
                  </div>
                  <button
                    type="button"
                    id="refreshWashLocationBtn"
                    class="btn btn-success btn-sm shadow-sm"
                    title="Refresh Lokasi"
                    style="border-radius: 20px"
                    onclick="getLocationForAsesmen('wash')"
                  >
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>

                <div class="text-success fw-bold">
                  <span id="wash-location-text">belum diambil</span>
                </div>
              </div>

              <input type="hidden" id="wash_lat" name="latitude" />
              <input type="hidden" id="wash_lon" name="longitude" />
              <div class="mb-2 text-muted small">
                <i class="fas fa-map me-1"></i>
                Koreksi titik: geser pin atau klik peta sebelum submit.
              </div>
              <div
                id="washMiniMap"
                style="
                  height: 220px;
                  border-radius: 12px;
                  overflow: hidden;
                  border: 1px solid #e5e7eb;
                "
              ></div>

              <div class="mb-3">
                <label class="form-label">Pilih Posko</label>
                <select class="form-select" name="kode_posko" required>
                  <option value="" selected disabled>-- pilih posko --</option>
                  {% for p in data_posko %}
                  <option value="{{ p.kode }}">
                    {{ p.kode }} - {{ p.nama }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Radius Buffer (km)</label>
                <div class="input-group">
                  <input
                    type="number"
                    class="form-control"
                    id="wash_radius"
                    name="radius"
                    min="0.1"
                    step="0.1"
                    value="2"
                  />
                  <span class="input-group-text">km</span>
                </div>
                <div class="form-text">
                  Default 2 km. Nilai ini menentukan buffer pada peta setelah
                  asesmen disubmit.
                </div>
              </div>

              <!-- 10 pertanyaan skala 1-5 -->
              {% set wash_questions = [ "1. Ketersediaan air bersih untuk minum
              dan memasak mencukupi?", "2. Kualitas air yang digunakan layak
              (tidak keruh/berbau) atau diolah (klorin/filtrasi)?", "3. Titik
              distribusi air mudah diakses dan antrian terkendali?", "4.
              Toilet/jamban yang layak tersedia dan berfungsi?", "5. Kebersihan
              toilet/jamban terjaga (pembersihan rutin)?", "6. Sarana cuci
              tangan dengan sabun tersedia di titik strategis?", "7.
              Ketersediaan sabun/perlengkapan kebersihan (hygiene kit)
              mencukupi?", "8. Fasilitas mandi/cuci (MCK) memadai dan aman
              (privasi/penerangan)?", "9. Pengelolaan sampah berjalan baik
              (pengumpulan & pembuangan)?", "10. Ada keluhan penyakit terkait
              WASH (diare/penyakit kulit) dalam beberapa hari terakhir?", ] %}
              {% for i in range(1,11) %}
              <div class="mb-3">
                <label class="form-label">{{ wash_questions[i-1] }}</label>
                <select class="form-select" name="p{{ i }}" required>
                  <option value="1">1 - Sangat Baik</option>
                  <option value="2">2 - Baik</option>
                  <option value="3" selected>3 - Cukup</option>
                  <option value="4">4 - Kurang</option>
                  <option value="5">5 - Sangat Kurang</option>
                </select>
              </div>
              {% endfor %}

              <div class="mb-3">
                <label class="form-label">Catatan (opsional)</label>
                <textarea
                  class="form-control"
                  name="catatan"
                  rows="3"
                ></textarea>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="submit"
                class="btn btn-success"
                id="btn-submit-wash"
                disabled
              >
                Submit
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===================== MODAL ASESMEN KODISI ===================== -->
    <div
      class="modal fade"
      id="asesmenKondisiModal"
      tabindex="-1"
      aria-labelledby="asesmenKondisiLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form method="POST" action="{{ url_for('submit_asesmen_kondisi') }}">
            <div class="modal-header">
              <h5 class="modal-title" id="asesmenKondisiLabel">
                Asesmen Kondisi
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <!-- Lokasi GPS Saat Ini (Asesmen Wash) -->
              <div class="mb-3 p-3 bg-light rounded">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <div class="fw-bold">
                    <i class="fas fa-map-marker-alt"></i> Lokasi GPS Saat Ini:
                  </div>
                  <button
                    type="button"
                    id="refreshKondisiLocationBtn"
                    class="btn btn-success btn-sm shadow-sm"
                    title="Refresh Lokasi"
                    style="border-radius: 20px"
                    onclick="getLocationForAsesmen('kondisi')"
                  >
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>

                <div class="text-success fw-bold">
                  <span id="wash-location-text">belum diambil</span>
                </div>
              </div>

              <input type="hidden" id="kondisi_lat" name="latitude" />
              <input type="hidden" id="kondisi_lon" name="longitude" />
              <div class="mb-2 text-muted small">
                <i class="fas fa-map me-1"></i>
                Koreksi titik: geser pin atau klik peta sebelum submit.
              </div>
              <div
                id="kondisiMiniMap"
                style="
                  height: 220px;
                  border-radius: 12px;
                  overflow: hidden;
                  border: 1px solid #e5e7eb;
                "
              ></div>

              <div class="mb-3">
                <label class="form-label">Pilih Posko</label>
                <select class="form-select" name="kode_posko" required>
                  <option value="" selected disabled>-- pilih posko --</option>
                  {% for p in data_posko %}
                  <option value="{{ p.kode }}">
                    {{ p.kode }} - {{ p.nama }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Radius Buffer (km)</label>
                <div class="input-group">
                  <input
                    type="number"
                    class="form-control"
                    id="kondisi_radius"
                    name="radius"
                    min="0.1"
                    step="0.1"
                    value="2"
                  />
                  <span class="input-group-text">km</span>
                </div>
                <div class="form-text">
                  Default 2 km. Nilai ini menentukan buffer pada peta setelah
                  asesmen disubmit.
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Lokasi Desa/Kecamatan</label>
                <input
                  type="text"
                  class="form-control"
                  id="kondisi_lokasi"
                  name="lokasi"
                  placeholder="Masukkan Desa/Kecamatan"
                  required
                />
              </div>

              <div class="mb-2 text-muted small">
                <i class="fas fa-map me-1"></i>
                Koreksi titik: geser pin atau klik peta sebelum submit.
              </div>
              <div
                id="kondisiBanjirMiniMap"
                style="
                  height: 220px;
                  border-radius: 12px;
                  overflow: hidden;
                  border: 1px solid #e5e7eb;
                "
              ></div>

              <div class="mt-3">
                <label class="form-label fw-bold"
                  >Daftar Titik Koordinat Lokasi Banjir</label
                >
                <div id="kondisi-points-list" class="vstack gap-2"></div>
              </div>

              {% set kondisi_angka = [ "Total Alamat Pengungsian", "Total Jumlah
              Pengungsi (Jiwa)", "Jumlah Warga yang Bertahan di Rumah (Jiwa)",
              "Jumlah Korban Meninggal Dunia (Jiwa)", "Total Alamat Dapur Umum",
              "Jumlah Kebutuhan Layanan Air Bersih", "Sekolah Rusak", "Sekolah
              Layak Digunakan", "Guru Tersedia" ] %}

              <!-- ===================== DATA Kondisi ===================== -->
              <div class="mt-4">
                <h6 class="fw-bold mb-3">
                  <i class="fas fa-list-numeric"></i> Data Kondisi
                </h6>

                {% for i in range(kondisi_angka|length) %}
                <div class="mb-3">
                  <label class="form-label">
                    {{ i+1 }}. {{ kondisi_angka[i] }}
                  </label>

                  <input
                    type="number"
                    class="form-control"
                    name="k{{ i+1 }}"
                    min="0"
                    step="1"
                    value="0"
                    placeholder="Masukkan angka"
                  />
                </div>
                {% endfor %}
              </div>

              <div class="mb-3">
                <label class="form-label">Catatan (opsional)</label>
                <textarea
                  class="form-control"
                  name="catatan"
                  rows="3"
                ></textarea>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="submit"
                class="btn btn-success"
                id="btn-submit-kondisi"
                disabled
              >
                Submit
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
              // Data Lokasi dari Flask
              function safeJsonParse(raw, fallback) {
                  try {
                      if (raw === null || raw === undefined) return fallback;
                      if (typeof raw === 'object') return raw;
                      const s = String(raw);
                      if (!s || s.trim() === "") return fallback;
                      return JSON.parse(s);
                  } catch (e) {
                      console.warn("JSON parse gagal:", e, raw);
                      return fallback;
                  }
              }

              let dataLokasi = safeJsonParse({{ data_lokasi | tojson | safe }}, []);
              let relawanLokasi = safeJsonParse({{ relawan_lokasi | tojson | safe }}, []);
              let asesmenKesehatan = safeJsonParse({{ asesmen_kesehatan | tojson | safe }}, []);
              let asesmenPendidikan = safeJsonParse({{ asesmen_pendidikan | tojson | safe }}, []);
              let asesmenPsikososial = safeJsonParse({{ asesmen_psikososial | tojson | safe }}, []);
              let asesmenInfrastruktur = safeJsonParse({{ asesmen_infrastruktur | tojson | safe }}, []);
              let asesmenWash = safeJsonParse({{ asesmen_wash | tojson | safe }}, []);
              let asesmenKondisi = safeJsonParse({{ asesmen_kondisi | tojson | safe }}, []);
              let permintaanLogistik = safeJsonParse({{ permintaan_logistik | tojson | safe }}, []);

              const CURRENT_IS_ADMIN = {{ 'true' if is_admin else 'false' }};

              // Inisialisasi Peta
              var map = L.map('map').setView([2.3693, 99.0763], 9); // Koordinat tengah Sumatera Utara

              // ================== PANE LAYER (URUTAN Z) ==================
              // Kab/Kota di bawah, buffer asesmen di atas (agar buffer bisa diklik)
              map.createPane('kabkotaPane');
              map.getPane('kabkotaPane').style.zIndex = 350;

              map.createPane('asesmenPane');
              map.getPane('asesmenPane').style.zIndex = 450;

              map.createPane('permintaanPane');
              map.getPane('permintaanPane').style.zIndex = 500;
              // ============================================================

              let statusData = safeJsonParse({{ status_map | tojson | safe }}, {});

              // Layer group untuk marker lokasi (agar bisa dihapus saat refresh)
              let markerLayerGroup = L.layerGroup().addTo(map);
              let relawanLayerGroup = L.layerGroup().addTo(map);
              let permintaanLayerGroup = L.layerGroup().addTo(map);
              // ================== LAYER ASESMEN (BUFFER 2KM) ==================
      let asesmenKesehatanLayer = L.layerGroup().addTo(map);
      let asesmenPendidikanLayer = L.layerGroup().addTo(map);
      let asesmenPsikososialLayer = L.layerGroup().addTo(map);
      let asesmenInfrastrukturLayer = L.layerGroup().addTo(map);
      let asesmenWashLayer = L.layerGroup().addTo(map);
      let asesmenKondisiLayer = L.layerGroup().addTo(map);


      // Map pertanyaan p1..px (untuk popup buffer)
      const ASESMEN_QUESTIONS = {
        kesehatan: {{ kesehatan_questions | tojson | safe }},
        pendidikan: {{ pendidikan_questions | tojson | safe }},
        psikososial: {{ psikososial_questions | tojson | safe }},
        infrastruktur: {{ infrastruktur_questions | tojson | safe }},
        wash: {{ wash_questions | tojson | safe }},
        kondisi: {{ kondisi_angka | tojson | safe }},
      };

      function escapeHtml(s){
        return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      }

      function _parseTsToEpochUtc(ts){
        if (!ts) return null;
        const s = String(ts).trim();

        // Ambil bagian tanggal + jam saja, abaikan offset (+0700 / Z / +07:00)
        // Contoh: "2025-12-19 01:57:33.518 +0700" -> parse "2025-12-19 01:57:33.518" sebagai UTC
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})(?:\.(\d{1,6}))?/);
        if (m) {
          const Y  = parseInt(m[1], 10);
          const Mo = parseInt(m[2], 10) - 1;
          const Da = parseInt(m[3], 10);
          const H  = parseInt(m[4], 10);
          const Mi = parseInt(m[5], 10);
          const Se = parseInt(m[6], 10);

          // ms (ambil 3 digit pertama, pad dengan nol jika perlu)
          const frac = String(m[7] || "0");
          const ms = parseInt((frac + "000").slice(0, 3), 10);

          // epoch UTC (offset diabaikan)
          return Date.UTC(Y, Mo, Da, H, Mi, Se, ms);
        }

        // Fallback (kalau format tidak match), coba Date()
        const d = new Date(s);
        if (isNaN(d.getTime())) return null;
        return d.getTime();
      }

      function _formatEpochUtcToWIB(epochUtc){
        // Konversi sederhana: UTC + 7 jam (WIB)
        const wibEpoch = epochUtc + (7 * 60 * 60 * 1000);
        const d = new Date(wibEpoch);

        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getUTCFullYear()}-${pad(d.getUTCMonth() + 1)}-${pad(d.getUTCDate())} ${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())} WIB`;
      }

      function formatWIB(ts){
        if (!ts) return "-";
        const epochUtc = _parseTsToEpochUtc(ts);
        if (epochUtc === null) return escapeHtml(ts);
        return _formatEpochUtcToWIB(epochUtc);
      }

      function statusColor(status){
        const s = String(status || "").toLowerCase();
        if (s.includes("kritis")) return "#ef4444";
        if (s.includes("waspada")) return "#f59e0b";
        if (s.includes("aman")) return "#22c55e";
        return "#3b82f6";
      }

      function jawabanHtml(j, kind){
        if (!j) return "<div class='text-muted'>-</div>";

        let obj = j;
        if (typeof obj === "string") {
          try { obj = JSON.parse(obj); } catch(e) { return `<pre class="mb-0">${escapeHtml(obj)}</pre>`; }
        }

        const keys = Object.keys(obj || {});
        keys.sort((a,b)=>{
          const na = parseInt(String(a).replace(/\D/g,"") || "0",10);
          const nb = parseInt(String(b).replace(/\D/g,"") || "0",10);
          return na - nb;
        });

        const qList = (ASESMEN_QUESTIONS && ASESMEN_QUESTIONS[kind]) ? ASESMEN_QUESTIONS[kind] : [];
        const label = {1:"Sangat Baik",2:"Baik",3:"Cukup",4:"Kurang",5:"Sangat Kurang"};

        let html = "<ul class='mb-0 ps-3'>";
        keys.forEach(k=>{
          const v = obj[k];
          const vv = Number(v);
          const info = (isFinite(vv) && label[vv]) ? ` (${label[vv]})` : "";

          const idx = parseInt(String(k).replace(/\D/g,"") || "0",10) - 1;
          let qText = (idx >= 0 && idx < (qList || []).length) ? String(qList[idx] || "") : "";
          // buang prefix "1. " agar tidak dobel dengan p1/p2
          qText = qText.replace(/^\s*\d+\.\s*/, "").trim();

          html += `
            <li style="margin-bottom:6px;">
              <div><b>${escapeHtml(k)}</b>${qText ? ` - ${escapeHtml(qText)}` : ""}</div>
              <div>Jawaban: <b>${escapeHtml(v)}</b>${escapeHtml(info)}</div>
            </li>
          `;
        });
        html += "</ul>";
        return html;
      }

      function renderAsesmenLayer(layer, rows, jenisLabel, kind){
        layer.clearLayers();
        (rows || []).forEach(r=>{
          const lat = parseFloat(r.latitude);
          const lon = parseFloat(r.longitude);
          if (!isFinite(lat) || !isFinite(lon)) return;

          const col = statusColor(r.status);
          const catatanTextRaw = (r.catatan && String(r.catatan).trim()) ? String(r.catatan) : '-';

          const catatanHtml = escapeHtml(catatanTextRaw).replace(/\r?\n/g, "<br>");


          // Buffer radius (meters)  default 2km, override dari kolom 'radius' (km) jika ada
          let radiusMeters = 2000;
          const rk = parseFloat(r.radius);
          if (isFinite(rk) && rk > 0) radiusMeters = rk * 1000;

        if (jenisLabel == 'Asesmen Kondisi'){
          console.log("Radius: "+jawabanHtml(r.jawaban, kind));
        }

          const popup = `
            <div style="min-width:260px;">
              <div class="fw-bold mb-1">${escapeHtml(jenisLabel)}</div>
              <div><b>ID Relawan:</b> ${escapeHtml(r.id_relawan)}</div>
              <div><b>Nama Relawan:</b> ${escapeHtml(r.nama_relawan)}</div>
              <div><b>Skor:</b> ${escapeHtml(r.skor)}</div>
              <div><b>Status:</b> <span style="color:${col};font-weight:700;">${escapeHtml(r.status)}</span></div>
              <div><b>Waktu:</b> ${formatWIB(r.waktu)}</div>
              <div><b>Catatan:</b><br>${catatanHtml}</div>


              <hr class="my-2"/>
              <div class="fw-bold mb-1">Jawaban</div>
              ${jawabanHtml(r.jawaban, kind)}
            </div>
          `;

          const circle = L.circle([lat, lon], {
            pane: 'asesmenPane',
            radius: radiusMeters,
            color: col,
            weight: 2,
            fill: true,
            fillColor: col,
            fillOpacity: 0.25,
            bubblingMouseEvents: false
          }).bindPopup(popup);

          const dot = L.circleMarker([lat, lon], {
            pane: 'asesmenPane',
            radius: 5,
            color: col,
            weight: 2,
            fillColor: col,
            fillOpacity: 0.95,
            bubblingMouseEvents: false
          }).bindPopup(popup);

          layer.addLayer(circle);
          layer.addLayer(dot);
        });
      }

      function jawabanKondisiHtml(j, kind) {
        if (!j) return "<div class='text-muted'>-</div>";

        let obj = j;
        if (typeof obj === "string") {
          try { obj = JSON.parse(obj); } catch(e) {
            return `<pre class="mb-0">${escapeHtml(obj)}</pre>`;
          }
        }

        // Ambil daftar pertanyaan untuk kind tertentu
        const qList = (ASESMEN_QUESTIONS && ASESMEN_QUESTIONS[kind]) ? ASESMEN_QUESTIONS[kind] : [];

        const htmlKeys = ["p1","p3","p4","p5","p6","p7","p8","p9","p10","p11"];
        let html = "<ul class='mb-0 ps-3'>";

        htmlKeys.forEach(k => {
          if (obj[k] === undefined) return;

          const idx = parseInt(String(k).replace(/\D/g,"") || "0",10) - 1;
          let qText = (idx >= 0 && idx < qList.length) ? String(qList[idx] || "") : "";
          // Hapus prefix nomor jika ada
          qText = qText.replace(/^\s*\d+\.\s*/, "").trim();

          const v = obj[k];
          html += `
            <li style="margin-bottom:6px;">
              <div><b>${escapeHtml(k)}</b>${qText ? ` - ${escapeHtml(qText)}` : ""}</div>
              <div>Jawaban: <b>${escapeHtml(v)}</b></div>
            </li>
          `;
        });

        html += "</ul>";
        return html;
      }


      function renderAsesmenKondisiLayer(layer, rows, jenisLabel, kind) {
        layer.clearLayers();

        (rows || []).forEach(r => {
          const lat = parseFloat(r.latitude);
          const lon = parseFloat(r.longitude);
          if (!isFinite(lat) || !isFinite(lon)) return;

          const col = statusColor(r.status);
          const catatanTextRaw = (r.catatan && String(r.catatan).trim()) ? String(r.catatan) : '-';
          const catatanHtml = escapeHtml(catatanTextRaw).replace(/\r?\n/g, "<br>");

          let radiusMeters = 2000;
          const rk = parseFloat(r.radius);
          if (isFinite(rk) && rk > 0) radiusMeters = rk * 1000;

          // Buat popup unik per relawan
          const popupId = `popupKondisiMap${r.id_relawan}`;

          // HTML popup
          const popupContent = `
            <div style="min-width:260px;">
              <div class="fw-bold mb-1">${escapeHtml(jenisLabel)}</div>
              <div><b>ID Relawan:</b> ${escapeHtml(r.id_relawan)}</div>
              <div><b>Nama Relawan:</b> ${escapeHtml(r.nama_relawan)}</div>
              <div><b>Status:</b> <span style="color:${col};font-weight:700;">${escapeHtml(r.status)}</span></div>
              <div><b>Waktu:</b> ${formatWIB(r.waktu)}</div>
              <div><b>Catatan:</b><br>${catatanHtml}</div>


              <hr class="my-2"/>
              <div class="fw-bold mb-1">Jawaban</div>
              ${jawabanKondisiHtml(r.jawaban, kind)}

              <!-- Map untuk p2 -->
              <div id="${popupId}" style="height:200px; margin-top:5px;"></div>
            </div>
          `;

          // Circle & dot
          const circle = L.circle([lat, lon], {
            pane: 'asesmenPane',
            radius: radiusMeters,
            color: col,
            weight: 2,
            fill: true,
            fillColor: col,
            fillOpacity: 0.25,
            bubblingMouseEvents: false
          }).bindPopup(popupContent);

          const dot = L.circleMarker([lat, lon], {
            pane: 'asesmenPane',
            radius: 5,
            color: col,
            weight: 2,
            fillColor: col,
            fillOpacity: 0.95,
            bubblingMouseEvents: false
          }).bindPopup(popupContent);

          // Tambahkan ke layer
          layer.addLayer(circle);
          layer.addLayer(dot);

          // Render map di popup saat dibuka
          [circle, dot].forEach(m => {
            m.on('popupopen', function() {
              const mapDiv = document.getElementById(popupId);
              if (!mapDiv) return;

              // Reset map jika sudah ada
              if (mapDiv._leaflet_map) {
                mapDiv._leaflet_map.remove();
              }

              const popupMap = L.map(mapDiv).setView([0,0], 5);
              mapDiv._leaflet_map = popupMap;

              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
              }).addTo(popupMap);

              // Plot titik p2
              let j = r.jawaban;
              if (typeof j === "string") {
                try { j = JSON.parse(j); } catch(e) { console.error(e); j = {}; }
              }
              if (j.p2) {
                const bounds = [];
                Object.values(j.p2).forEach(pt => {
                  if (Array.isArray(pt) && pt.length === 2) {
                    L.marker(pt).addTo(popupMap);
                    bounds.push(pt);
                  }
                });
                if (bounds.length) popupMap.fitBounds(bounds, {padding:[10,10]});
              }
            });
          });
        });
      }



      function renderAsesmenBuffers(){
        renderAsesmenLayer(asesmenKesehatanLayer, asesmenKesehatan, "Asesmen Kesehatan", "kesehatan");
        renderAsesmenLayer(asesmenPendidikanLayer, asesmenPendidikan, "Asesmen Pendidikan", "pendidikan");
        renderAsesmenLayer(asesmenPsikososialLayer,asesmenPsikososial, "Asesmen Psikososial", "psikososial");
        renderAsesmenLayer(asesmenInfrastrukturLayer,asesmenInfrastruktur,"Asesmen Infrastruktur", "infrastruktur");
        renderAsesmenLayer(asesmenWashLayer, asesmenWash, "Asesmen Wash", "wash");
        renderAsesmenKondisiLayer(asesmenKondisiLayer, asesmenKondisi, "Asesmen Kondisi", "kondisi");
      }
      renderAsesmenBuffers();

      // Toggle checkbox
      const ckAsesmenAll = document.getElementById("toggleAsesmenAll");
      const ckKes = document.getElementById("toggleAsesmenKesehatan");
      const ckPen = document.getElementById("toggleAsesmenPendidikan");
      const ckInf = document.getElementById("toggleAsesmenInfrastruktur");
      const ckPsi = document.getElementById("toggleAsesmenPsikososial");
      const ckWas = document.getElementById("toggleAsesmenWash");
      const ckKond = document.getElementById("toggleAsesmenKondisi");

      function setLayerVisible(layer, visible){
        if (visible) {
          if (!map.hasLayer(layer)) layer.addTo(map);
        } else {
          if (map.hasLayer(layer)) map.removeLayer(layer);
        }
      }

      function applyAsesmenVisibility(){
        const master = ckAsesmenAll ? ckAsesmenAll.checked : true;
        const showKes = ckKes ? ckKes.checked : true;
        const showPen = ckPen ? ckPen.checked : true;
        const showInf = ckInf ? ckInf.checked : true;
        const showPsi = ckPsi ? ckPsi.checked : true;
        const showWas = ckWas ? ckWas.checked : true;
        const showKond = ckKond ? ckKond.checked : true;

        setLayerVisible(asesmenKesehatanLayer, master && showKes);
        setLayerVisible(asesmenPendidikanLayer, master && showPen);
        setLayerVisible(asesmenInfrastrukturLayer, master && showInf);
        setLayerVisible(asesmenPsikososialLayer, master && showPsi);
        setLayerVisible(asesmenWashLayer, master && showWas);
        setLayerVisible(asesmenKondisiLayer, master && showKond);
      }

      // (visibility asesmen akan di-handle oleh blok sinkronisasi filter di bawah)
      // ================================================================


              // 2. Fungsi Penentu Warna
              function getColorByStatus(status) {
                  if (!status) return '#22c55e'; // Default Hijau
                  let s = status.toLowerCase(); // Ubah ke huruf kecil semua

                  if (s.includes('tanggap') || s.includes('awas') || s.includes('merah')) {
                      return '#ef4444'; // Merah
                  } else if (s.includes('siaga') || s.includes('waspada') || s.includes('kuning')) {
                      return '#eab308'; // Kuning
                  } else {
                      return '#22c55e'; // Hijau
                  }
              }

              function cleanName(name) {
                  if (!name) return "";

                  return name.toUpperCase()
                      // 1. Buang kata-kata atribut wilayah
                      .replace("KABUPATEN", "")
                      .replace("KOTA", "")
                      .replace("KAB.", "")
                      .replace("KAB ", "")

                      // 2. HAPUS SEMUA KECUALI HURUF A-Z
                      // (Spasi, titik, koma, strip, angka -> HILANG SEMUA)
                      .replace(/[^A-Z]/g, "");
              }

              // ---------------------------------------------------------
              // UPDATE FUNGSI PENCARI DATA (LEBIH PINTAR)
              // ---------------------------------------------------------
              function getFeatureData(feature) {
                  // 1. Ambil nama dari GeoJSON (Sesuai file .dbf kamu: 'kabkota')
                  let namaAsli = feature.properties.kabkota ||      // <--- INI YANG PALING MUNGKIN BENAR
                      feature.properties.KABKOTA ||      // Jaga-jaga kalau huruf besar
                      feature.properties.NAMOBJ ||
                      feature.properties.WADMKK ||
                      "Wilayah";

                  // 2. Bersihkan nama dari Peta (misal: "Kab. Karo" -> "KARO")
                  let namaGeoClean = cleanName(namaAsli);

                  let status = "Normal";

                  // 3. Loop data dari Excel/Sheet
                  for (let key in statusData) {
                      // Bersihkan nama dari Sheet
                      let keyClean = cleanName(key);

                      // Bandingkan INTINYA SAJA
                      if (namaGeoClean === keyClean) {
                          status = statusData[key];
                          break;
                      }
                  }

                  return { nama: namaAsli, status: status };
              }

              // 3. Load Peta
              fetch("{{ url_for('static', filename='data/kabkota_sumut.json') }}")
                  .then(res => res.json())
                  .then(data => {
                      L.geoJSON(data, {
                          pane: 'kabkotaPane',
                          // --- STYLE AWAL ---
                          style: function (feature) {
                              // Panggil fungsi pencari data
                              let info = getFeatureData(feature);

                              return {
                                  fillColor: getColorByStatus(info.status),
                                  weight: 1,
                                  opacity: 1,
                                  color: 'white',
                                  dashArray: '3',
                                  fillOpacity: 0.7
                              };
                          },

                          // --- INTERAKSI ---
                          onEachFeature: function (feature, layer) {
                              // Panggil fungsi pencari data LAGI (Pasti hasilnya sama dengan style)
                              let info = getFeatureData(feature);
                              let statusColor = getColorByStatus(info.status);

                              // Badge Class untuk Popup
                              let badgeClass = 'success';
                              let s = info.status.toLowerCase();
                              if (s.includes('tanggap') || s.includes('merah')) badgeClass = 'danger';
                              else if (s.includes('siaga') || s.includes('kuning')) badgeClass = 'warning';

                              // Popup & Tooltip
                              layer.bindTooltip(`<b>${info.nama}</b>: ${info.status}`, { sticky: true, direction: 'top' });
                              layer.bindPopup(`
                              <div class="text-center">
                                  <h6 class="mb-1 fw-bold">${info.nama}</h6>
                                  <span class="badge bg-${badgeClass}">${info.status}</span>
                              </div>
                          `);

                              // Logic Hover (Frame Effect)
                              layer.on({
                                  mouseover: function (e) {
                                      var l = e.target;
                                      l.setStyle({
                                          weight: 4,              // Frame Tebal
                                          color: statusColor,     // Warna Frame = Warna Status
                                          dashArray: '',          // Garis Solid
                                          fillColor: 'white',     // Isi Putih
                                          fillOpacity: 0.2
                                      });
                                      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) l.bringToFront();
                                  },
                                  mouseout: function (e) {
                                      var l = e.target;
                                      l.setStyle({
                                          weight: 1,              // Reset Tipis
                                          color: 'white',         // Reset Putih
                                          dashArray: '3',         // Reset Putus-putus
                                          fillColor: statusColor, // ISI BALIK KE WARNA ASAL (Kuning/Merah/Hijau)
                                          fillOpacity: 0.7
                                      });
                                  },
                                  click: function (e) { this.openPopup(); }
                              });
                          }
                      }).addTo(map);
                  })
                  .catch(e => console.error("Error GeoJSON:", e));

              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
              }).addTo(map);

              // Definisi Ikon Kustom dengan Font Awesome
              function getIcon(jenis) {
                  let iconClass, iconColor, bgColor;

                  if (jenis.includes('Posko')) {
                      // Icon Tenda untuk Posko Pengungsian
                      iconClass = 'fas fa-campground';
                      iconColor = '#ffffff';
                      bgColor = '#ef4444'; // Merah
                  } else if (jenis.includes('Gudang')) {
                      // Icon Gudang
                      iconClass = 'fas fa-warehouse';
                      iconColor = '#ffffff';
                      bgColor = '#10b981'; // Hijau
                  } else if (jenis.includes('Rusak') || jenis.includes('Putus') || jenis.includes('Longsor')) {
                      iconClass = 'fas fa-exclamation-triangle';
                      iconColor = '#ffffff';
                      bgColor = '#f59e0b'; // Orange
                  } else {
                      iconClass = 'fas fa-map-marker-alt';
                      iconColor = '#ffffff';
                      bgColor = '#3b82f6'; // Biru
                  }

                  // Buat custom HTML icon dengan Font Awesome
                  const iconHtml = `
                      <div style="
                          background-color: ${bgColor};
                          width: 40px;
                          height: 40px;
                          border-radius: 50% 50% 50% 0;
                          transform: rotate(-45deg);
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                          border: 3px solid white;
                      ">
                          <i class="${iconClass}" style="
                              color: ${iconColor};
                              transform: rotate(45deg);
                              font-size: 18px;
                          "></i>
                      </div>
                  `;

                  return L.divIcon({
                      html: iconHtml,
                      className: 'custom-marker-icon',
                      iconSize: [40, 40],
                      iconAnchor: [20, 40],
                      popupAnchor: [0, -40]
                  });
              }
              {#Relawan Marker#}
              function getRelawanIcon() {
        const iconHtml = `
          <div style="
            background-color:#0ea5e9;width:40px;height:40px;
            border-radius:50% 50% 50% 0;transform:rotate(-45deg);
            display:flex;align-items:center;justify-content:center;
            box-shadow:0 3px 10px rgba(0,0,0,.3);border:3px solid #fff;">
            <i class="fas fa-user" style="color:#fff;transform:rotate(45deg);font-size:18px;"></i>
          </div>`;
        return L.divIcon({
          html: iconHtml,
          className: 'custom-marker-icon',
          iconSize: [40, 40],
          iconAnchor: [20, 40],
          popupAnchor: [0, -40]
        });
      }

      function _formatWaktuGMT7(v) {
        try {
          if (!v) return '-';
          const out = formatWIB(v);
          return out || String(v);
        } catch (e) {
          return String(v);
        }
      }

      function _normalizePhotoUrl(p) {
        if (!p) return '';
        const s = String(p).trim();
        if (!s) return '';
        if (s.startsWith('http://') || s.startsWith('https://')) return s;
        if (s.startsWith('/')) return s;
        return '/' + s;
      }


      function _permintaanStatusKey(status){
        const s = String(status || '').toLowerCase();
        if (s.includes('draft')) return 'draft';
        if (s.includes('diproses')) return 'diproses';
        if (s.includes('dikirim')) return 'dikirim';
        if (s.includes('diterima')) return 'diterima';
        if (s.includes('ditolak')) return 'ditolak';
        {#if (s.includes('selesai')) return 'selesai';#}
        return 'draft';
      }

      function permintaanStatusColor(status){
        const k = _permintaanStatusKey(status);
        if (k === 'diproses') return '#f59e0b';
        if (k === 'dikirim') return '#3b82f6';
        if (k === 'diterima') return '#22c55e';
        if (k === 'ditolak') return '#ef4444';
        {#if (k === 'selesai') return '#10b981';#}
        return '#64748b'; // draft
      }

      function getPermintaanIcon(status) {
        const bg = permintaanStatusColor(status);
        const iconHtml = `
          <div style="
            width: 40px;
            height: 40px;
            background-color: ${bg};
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
          ">
            <i class="fas fa-box-open" style="
              color: white;
              font-size: 18px;
              transform: rotate(45deg);
            "></i>
          </div>
        `;

        return L.divIcon({
          html: iconHtml,
          className: 'custom-marker-icon',
          iconSize: [40, 40],
          iconAnchor: [20, 40],
          popupAnchor: [0, -40]
        });
      }

      function _poskoNameByKode(kode) {
        try {
          const k = String(kode || '').trim();
          if (!k) return '-';
          const found = (dataLokasi || []).find(d => String(d.kode_lokasi || d.kode || '').trim() === k);
          if (!found) return k;
          return (found.nama_lokasi || found.nama || found.kabupaten_kota || k);
        } catch (e) {
          return kode || '-';
        }
      }

      function renderPermintaanMarkers(rows) {
        permintaanLayerGroup.clearLayers();
        (rows || []).forEach(r => {
          const lat = parseFloat(r.latitude);
          const lon = parseFloat(r.longitude);
          if (!isFinite(lat) || !isFinite(lon)) return;

          const waktuText = _formatWaktuGMT7(r.tanggal || r.waktu || r.timestamp);
          const status = r.status_permintaan || r.status || 'Draft';
          const kodePosko = r.kode_posko || '-';
          const namaPosko = _poskoNameByKode(kodePosko);
          const idRelawan = r.id_relawan || '-';
          const namaRelawan = r.nama_relawan;

          const ket = (r.keterangan || '-');
          const ketHtml = escapeHtml(ket).replace(/\n/g, '<br>');

          L.marker([lat, lon], { icon: getPermintaanIcon(status), pane: 'permintaanPane' })
            .addTo(permintaanLayerGroup)
            .bindPopup(
              `<div style="min-width:260px;">
                 <div class="fw-bold mb-1">Permintaan Logistik</div>
                 <div><b>Posko:</b> ${escapeHtml(namaPosko)} <span class="text-muted">(${escapeHtml(kodePosko)})</span></div>
                 <div><b>Status:</b> ${escapeHtml(status)}</div>
                 <div><b>Relawan:</b> ${escapeHtml(idRelawan)} - ${escapeHtml(namaRelawan)}</div>
                 <div><b>Waktu:</b> ${escapeHtml(waktuText)}</div>
                 <hr class="my-2"/>
                 <div class="fw-bold mb-1">Keterangan</div>
                 <div style="white-space:normal;">${ketHtml}</div>
               </div>`
            );
        });
      }


      // =============================================================================
      // ADMIN: PENGATURAN STATUS PERMINTAAN LOGISTIK (khusus is_admin)
      // =============================================================================
      const PERMINTAAN_STATUS_OPTIONS = ["Draft", "Diproses", "Dikirim", "Diterima", "Ditolak"];

      function _renderPermintaanStatusBadge(status) {
        const bg = permintaanStatusColor(status);
        const label = status || 'Draft';
        return `<span class="badge" style="background:${bg};">${escapeHtml(label)}</span>`;
      }

      function renderPermintaanAdminTable() {
        const tbody = document.getElementById('permintaanAdminTableBody');
        if (!tbody) return;

        const rows = Array.isArray(permintaanLogistik) ? permintaanLogistik : [];
        tbody.innerHTML = '';

        if (!rows.length) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center">Belum ada permintaan (24 jam terakhir).</td></tr>';
          return;
        }

        rows.forEach(r => {
          const id = r.id;
          const kodePosko = r.kode_posko || '-';
          const namaPosko = _poskoNameByKode(kodePosko);
          const waktuText = _formatWaktuGMT7(r.waktu || r.tanggal || r.timestamp);
          const status = r.status_permintaan || r.status || 'Draft';
          const ket = String(r.keterangan || '').trim();
          const ketShort = ket.length > 120 ? (ket.slice(0, 120) + '') : (ket || '-');

          const selId = `permintaanStatusSelect_${id}`;
          const btnId = `permintaanStatusBtn_${id}`;

          const optionsHtml = PERMINTAAN_STATUS_OPTIONS.map(s => {
            const selected = (_permintaanStatusKey(s) === _permintaanStatusKey(status)) ? ' selected' : '';
            return `<option value="${escapeHtml(s)}"${selected}>${escapeHtml(s)}</option>`;
          }).join('');

          tbody.insertAdjacentHTML('beforeend', `
            <tr>
              <td><code>${escapeHtml(id)}</code></td>
              <td>
                <div class="fw-bold">${escapeHtml(namaPosko)}</div>
                <div class="text-muted small">${escapeHtml(kodePosko)}</div>
              </td>
              <td class="small">${escapeHtml(waktuText)}</td>
              <td class="small" style="white-space:normal;">${escapeHtml(ketShort)}</td>
              <td>${_renderPermintaanStatusBadge(status)}</td>
              <td>
                <div class="d-flex gap-2">
                  <select class="form-select form-select-sm" id="${escapeHtml(selId)}">
                    ${optionsHtml}
                  </select>
                  <button class="btn btn-sm btn-primary" id="${escapeHtml(btnId)}" type="button"
                          onclick="adminUpdatePermintaanStatus('${escapeHtml(id)}')">Simpan</button>
                </div>
              </td>
            </tr>
          `);
        });
      }

      async function adminUpdatePermintaanStatus(id) {
        if (!CURRENT_IS_ADMIN) {
          showNotification('Anda bukan admin.', 'danger', true);
          return;
        }

        const sel = document.getElementById(`permintaanStatusSelect_${id}`);
        const btn = document.getElementById(`permintaanStatusBtn_${id}`);
        if (!sel || !btn) return;

        const newStatus = String(sel.value || '').trim();
        if (!newStatus) return;

        sel.disabled = true;
        btn.disabled = true;

        const oldBtnHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
          const resp = await fetch('/api/update_permintaan_status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, status: newStatus })
          });

          const result = await resp.json().catch(() => ({}));
          if (resp.ok && result && result.success) {
            // Update local data
            const item = (permintaanLogistik || []).find(x => String(x.id) === String(id));
            if (item) item.status_permintaan = newStatus;

            // Refresh marker permintaan (warna/icon)
            applyPermintaanVisibility();

            // Refresh tabel admin
            renderPermintaanAdminTable();

            showNotification('Status permintaan berhasil diperbarui.', 'success', true);
          } else {
            showNotification('Gagal update status: ' + (result.error || 'Unknown error'), 'danger', true);
          }
        } catch (e) {
          console.error(e);
          showNotification('Error saat update status.', 'danger', true);
        } finally {
          sel.disabled = false;
          btn.disabled = false;
          btn.innerHTML = oldBtnHtml;
        }
      }

      // Hook modal admin (render table saat dibuka / refresh)
      document.addEventListener('DOMContentLoaded', function() {
        const modalEl = document.getElementById('permintaanAdminModal');
        if (modalEl) {
          modalEl.addEventListener('shown.bs.modal', function() {
            renderPermintaanAdminTable();
          });
        }

        const btnRefresh = document.getElementById('btnRefreshPermintaanAdmin');
        if (btnRefresh) {
          btnRefresh.addEventListener('click', async function() {
            try {
              const response = await fetch('/api/refresh_map');
              const result = await response.json();
              if (result && result.success) {
                permintaanLogistik = Array.isArray(result.permintaan_logistik)
                  ? result.permintaan_logistik
                  : (result.permintaan_logistik || []);
                applyPermintaanVisibility();
                renderPermintaanAdminTable();
                showNotification('Data permintaan diperbarui.', 'success', true);
              } else {
                showNotification('Gagal refresh permintaan: ' + (result.error || 'Unknown error'), 'danger', true);
              }
            } catch (e) {
              console.error(e);
              showNotification('Error refresh permintaan.', 'danger', true);
            }
          });
        }
      });



      function renderRelawanMarkers(relawanData) {
        relawanLayerGroup.clearLayers();

        (relawanData || []).forEach(r => {
          const lat = parseFloat(r.latitude);
          const lon = parseFloat(r.longitude);
          if (!isFinite(lat) || !isFinite(lon)) return;

          const photoUrl = _normalizePhotoUrl(r.photo_path);
          const waktuText = _formatWaktuGMT7(r.waktu);

          const unitText = r.unit ? String(r.unit) : '';
          const catatanTextRaw = (r.catatan && String(r.catatan).trim()) ? String(r.catatan) : '-';
          const catatanHtml = escapeHtml(catatanTextRaw).replace(/\n/g, "<br>");

          // === FORMAT TAMPILAN PERSIS SEPERTI YANG KAMU MAU ===
          const photoHtml = photoUrl
            ? `<img src="${escapeHtml(photoUrl)}" alt="Foto Relawan"
                    style="width:78px;height:78px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;">`
            : `<div style="width:78px;height:78px;border-radius:10px;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:center;background:#f8fafc;">
                 <i class="fas fa-image" style="opacity:.45;"></i>
               </div>`;

          L.marker([lat, lon], { icon: getRelawanIcon() })
            .addTo(relawanLayerGroup)
            .bindPopup(
              `<div style="min-width:250px;">
                 <div style="display:flex;gap:10px;align-items:flex-start;">
                   ${photoHtml}
                   <div style="flex:1;">
                     <div style="font-weight:700;line-height:1.1;">
                       ${escapeHtml(r.id_relawan || '-')} - ${escapeHtml(r.nama_relawan || r.nama || '-')}
                     </div>

                     ${unitText
                       ? `<div style="margin-top:4px;">
                            <small class="text-muted">Unit:</small>
                            <small><b>${escapeHtml(unitText)}</b></small>
                          </div>`
                       : ''}

                     <div style="margin-top:4px;">
                       <small class="text-muted">Waktu:</small>
                       <small><b>${escapeHtml(waktuText)}</b></small>
                     </div>

                     <div style="margin-top:6px;">
                       <small class="text-muted">Catatan:</small><br>
                       <small>${catatanHtml}</small>
                     </div>
                   </div>
                 </div>
               </div>`,
              { maxWidth: 380 }
            );
        });
      }


              // 4. Fungsi untuk render marker lokasi ke peta
              function renderMarkers(lokasiData, filterState) {
                  const fs = filterState || {};
                  const showPosko = fs.showPosko !== false;
                  const showGudang = fs.showGudang !== false;
                  const showLain = fs.showLain !== false;
                  // Hapus marker lama
                  markerLayerGroup.clearLayers();

                  // Tambah marker baru
                  lokasiData.forEach(lokasi => {
                      const lat = parseFloat(lokasi.latitude);
                      const lon = parseFloat(lokasi.longitude);
                      if (!isNaN(lat) && !isNaN(lon)) {
                          const jenis = String(lokasi.jenis_lokasi || '');
                          const isPosko = /posko/i.test(jenis);
                          const isGudang = /gudang/i.test(jenis);
                          if (isPosko && !showPosko) return;
                          if (isGudang && !showGudang) return;
                          if (!isPosko && !isGudang && !showLain) return;

                          let icon = getIcon(lokasi.jenis_lokasi);

                          const photoUrl = _normalizePhotoUrl(lokasi.photo_path);
                          const photoHtml = photoUrl
                              ? `<img src="${photoUrl}" alt="Foto Lokasi" style="width:78px;height:78px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;">`
                              : `<div style="width:78px;height:78px;border-radius:10px;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:center;background:#f8fafc;">
                                   <i class="fas fa-image" style="opacity:.45;"></i>
                                 </div>`;

                          const kabkotaText = lokasi.nama_kabkota || lokasi.kabupaten_kota || '-';
                          const idLokasiText = lokasi.id_lokasi || lokasi.kode_lokasi || lokasi.kode || '-';
                          const namaLokasiText = lokasi.nama_lokasi || '-';
                          const statusLokasiText = lokasi.status_lokasi || '-';
                          const aksesText = lokasi.tingkat_akses || lokasi.akses || '-';
                          const kondisiText = lokasi.kondisi || lokasi.kondisi_umum || '-';
                          const catatanText = lokasi.catatan || '-';

                          const kondisiHtml = escapeHtml(kondisiText).replace(/\r?\n/g, '<br>');
                          const catatanHtml = escapeHtml(catatanText).replace(/\r?\n/g, '<br>');

                          L.marker([lat, lon], { icon: icon })
                              .addTo(markerLayerGroup)
                              .bindPopup(
                                  `<div style="min-width:270px;">
                                      <div style="display:flex;gap:10px;align-items:flex-start;">
                                          ${photoHtml}
                                          <div style="flex:1;">
                                              <div style="font-weight:700;line-height:1.1;">
                                                  <span class="text-primary">${lokasi.jenis_lokasi || '-'}</span>
                                              </div>
                                              <div style="margin-top:2px;">${kabkotaText}</div>

                                              <div style="margin-top:6px;">
                                                  <small class="text-muted">ID Lokasi:</small>
                                                  <small><b>${idLokasiText}</b></small>
                                              </div>
                                              <div style="margin-top:2px;">
                                                  <small class="text-muted">Nama Lokasi:</small>
                                                  <small><b>${namaLokasiText}</b></small>
                                              </div>

                                              <div style="margin-top:6px;">
                                                  <small class="text-muted">Status:</small>
                                                  <small><b>${statusLokasiText}</b></small>
                                                  <small class="text-muted"> | Akses:</small>
                                                  <small><b>${aksesText}</b></small>
                                                  <small class="text-muted"> | Kondisi:</small>
                                                  <small><b>${kondisiHtml}</b></small>
                                              </div>

                                              <div style="margin-top:6px;">
                                                  <small class="text-muted">Catatan:</small><br>
                                                  <small>${catatanHtml}</small>
                                              </div>
                                          </div>
                                      </div>
                                  </div>`
                              );
                      }
                  });
              }



              // ==============================================================================
              // FILTER LAYER (CHECKLIST) - Lokasi, Relawan, Permintaan, Asesmen
              // ==============================================================================
              const ckLokPosko = document.getElementById('toggleLokasiPosko');
              const ckLokGudang = document.getElementById('toggleLokasiGudang');
              const ckLokLain = document.getElementById('toggleLokasiLain');

              const ckRelawanLok = document.getElementById('toggleLokasiRelawan');

              const ckPermintaan = document.getElementById('togglePermintaanLogistik');
              const ckPermDraft = document.getElementById('togglePermintaanDraft');
              const ckPermDiproses = document.getElementById('togglePermintaanDiproses');
              const ckPermDikirim = document.getElementById('togglePermintaanDikirim');
              const ckPermDiterima = document.getElementById('togglePermintaanDiterima');
              const ckPermDitolak = document.getElementById('togglePermintaanDitolak');
              {#const ckPermSelesai = document.getElementById('togglePermintaanSelesai');#}


              // Master checkbox + collapse body elements (agar filter bisa di-hide/show dan parent mengikuti child)
              const ckLokAll = document.getElementById('toggleLokasiAll');
              const ckRelAll = document.getElementById('toggleRelawanAll');

              const elAsesmenBody = document.getElementById('filterAsesmenBody');
              const elLokasiBody = document.getElementById('filterLokasiBody');
              const elRelawanBody = document.getElementById('filterRelawanBody');
              const elPermintaanBody = document.getElementById('filterPermintaanBody');

              let _isSyncingFilter = false;

              function _setCollapseVisible(el, visible){
                  if (!el) return;
                  try {
                      if (window.bootstrap && bootstrap.Collapse) {
                          const inst = bootstrap.Collapse.getOrCreateInstance(el, { toggle: false });
                          if (visible) inst.show(); else inst.hide();
                      } else {
                          el.style.display = visible ? '' : 'none';
                      }
                  } catch(e) {
                      el.style.display = visible ? '' : 'none';
                  }
              }

              function _setChildrenState(children, checked, disabled){
                  (children || []).forEach(ch => {
                      if (!ch) return;
                      if (typeof checked === 'boolean') ch.checked = checked;
                      if (typeof disabled === 'boolean') ch.disabled = disabled;
                  });
              }

              function _anyChecked(children){
                  return (children || []).some(ch => ch && ch.checked);
              }

              function syncGroupFromMaster(masterEl, bodyEl, children, onApply){
                  if (_isSyncingFilter) return;
                  _isSyncingFilter = true;

                  const masterOn = masterEl ? !!masterEl.checked : true;
                  if (!masterOn) {
                      _setChildrenState(children, false, true);
                      _setCollapseVisible(bodyEl, false);
                  } else {
                      _setChildrenState(children, undefined, false);
                      if (!_anyChecked(children)) _setChildrenState(children, true, false);
                      _setCollapseVisible(bodyEl, true);
                  }

                  _isSyncingFilter = false;
                  if (onApply) onApply();
              }

              function syncMasterFromChildren(masterEl, bodyEl, children, onApply){
                  if (_isSyncingFilter) return;
                  _isSyncingFilter = true;

                  const any = _anyChecked(children);
                  if (masterEl) masterEl.checked = any;
                  _setChildrenState(children, undefined, !any);
                  _setCollapseVisible(bodyEl, any);

                  _isSyncingFilter = false;
                  if (onApply) onApply();
              }

              function getLokasiFilterState(){
                  return {
                      showPosko: ckLokPosko ? ckLokPosko.checked : true,
                      showGudang: ckLokGudang ? ckLokGudang.checked : true,
                      showLain: ckLokLain ? ckLokLain.checked : true,
                  };
              }

              function applyLokasiFilter(){
                  const fs = getLokasiFilterState();
                  renderMarkers(dataLokasi, fs);
              }

              function applyRelawanVisibility(){
                  const visible = ckRelawanLok ? ckRelawanLok.checked : true;
                  setLayerVisible(relawanLayerGroup, visible);
              }

              function _permintaanAllowedMap(){
                  const m = {
                      draft: ckPermDraft ? ckPermDraft.checked : true,
                      diproses: ckPermDiproses ? ckPermDiproses.checked : true,
                      dikirim: ckPermDikirim ? ckPermDikirim.checked : true,
                      diterima: ckPermDiterima ? ckPermDiterima.checked : true,
                      ditolak: ckPermDitolak ? ckPermDitolak.checked : true,
                      {#selesai: ckPermSelesai ? ckPermSelesai.checked : true,#}
                  };
                  return m;
              }

              function applyPermintaanVisibility(){
                  const master = ckPermintaan ? ckPermintaan.checked : true;
                  if (!master) {
                      setLayerVisible(permintaanLayerGroup, false);
                      return;
                  }

                  const allowed = _permintaanAllowedMap();
                  const filtered = (permintaanLogistik || []).filter(r => {
                      const k = _permintaanStatusKey(r.status_permintaan || r.status || 'Draft');
                      return allowed[k] !== false;
                  });

                  renderPermintaanMarkers(filtered);
                  setLayerVisible(permintaanLayerGroup, true);
              }

              // Event listeners
              // Lokasi (master + child)
              if (ckLokAll) ckLokAll.addEventListener('change', () => syncGroupFromMaster(ckLokAll, elLokasiBody, [ckLokPosko, ckLokGudang, ckLokLain], applyLokasiFilter));
              [ckLokPosko, ckLokGudang, ckLokLain].forEach(el => {
                  if (el) el.addEventListener('change', () => syncMasterFromChildren(ckLokAll, elLokasiBody, [ckLokPosko, ckLokGudang, ckLokLain], applyLokasiFilter));
              });

              // Relawan
              if (ckRelAll) ckRelAll.addEventListener('change', () => syncGroupFromMaster(ckRelAll, elRelawanBody, [ckRelawanLok], applyRelawanVisibility));
              if (ckRelawanLok) ckRelawanLok.addEventListener('change', () => syncMasterFromChildren(ckRelAll, elRelawanBody, [ckRelawanLok], applyRelawanVisibility));

              // Permintaan (master + status)
              if (ckPermintaan) ckPermintaan.addEventListener('change', () => syncGroupFromMaster(ckPermintaan, elPermintaanBody, [ckPermDraft, ckPermDiproses, ckPermDikirim, ckPermDiterima, ckPermDitolak], applyPermintaanVisibility));
              [ckPermDraft, ckPermDiproses, ckPermDikirim, ckPermDiterima, ckPermDitolak].forEach(el => {
                  if (el) el.addEventListener('change', () => syncMasterFromChildren(ckPermintaan, elPermintaanBody, [ckPermDraft, ckPermDiproses, ckPermDikirim, ckPermDiterima, ckPermDitolak], applyPermintaanVisibility));
              });

              // Asesmen (master + child)
              if (ckAsesmenAll) ckAsesmenAll.addEventListener('change', () => syncGroupFromMaster(ckAsesmenAll, elAsesmenBody, [ckKes, ckPen, ckPsi, ckInf, ckWas, ckKond], applyAsesmenVisibility));
              [ckKes, ckPen, ckPsi, ckInf, ckWas, ckKond].forEach(el => {
                  if (el) el.addEventListener('change', () => syncMasterFromChildren(ckAsesmenAll, elAsesmenBody, [ckKes, ckPen, ckPsi, ckInf, ckWas, ckKond], applyAsesmenVisibility));
              });

              // Initial sync + render
              syncGroupFromMaster(ckAsesmenAll, elAsesmenBody, [ckKes, ckPen, ckPsi, ckInf, ckWas, ckKond], applyAsesmenVisibility);
              syncGroupFromMaster(ckLokAll, elLokasiBody, [ckLokPosko, ckLokGudang, ckLokLain], applyLokasiFilter);
              syncGroupFromMaster(ckRelAll, elRelawanBody, [ckRelawanLok], applyRelawanVisibility);
              syncGroupFromMaster(ckPermintaan, elPermintaanBody, [ckPermDraft, ckPermDiproses, ckPermDikirim, ckPermDiterima, ckPermDitolak], applyPermintaanVisibility);

              // Render marker awal
              applyLokasiFilter();
              renderRelawanMarkers(relawanLokasi);
              applyRelawanVisibility();
              applyPermintaanVisibility();
              // ==============================================================================
              // FUNGSI REFRESH MAP
              // ==============================================================================
              const refreshMapBtn = document.getElementById('refreshMapBtn');
              let isRefreshingMap = false;

              async function refreshMap() {
                  if (isRefreshingMap) return;

                  isRefreshingMap = true;
                  const originalHtml = refreshMapBtn.innerHTML;
                  refreshMapBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                  refreshMapBtn.disabled = true;

                  try {
                      const response = await fetch('/api/refresh_map');
                      const result = await response.json();

                      if (result.success) {
                          // Update data
                          dataLokasi = result.data_lokasi;
                          relawanLokasi = result.relawan_lokasi || [];
                          statusData = result.status_map;

                          // Update status wilayah di peta (reload GeoJSON layer)
                          // Hapus layer GeoJSON lama jika ada
                          map.eachLayer(function(layer) {
                              if (layer instanceof L.GeoJSON) {
                                  map.removeLayer(layer);
                              }
                          });

                          // Reload GeoJSON dengan status terbaru
                          fetch("{{ url_for('static', filename='data/kabkota_sumut.json') }}")
                              .then(res => res.json())
                              .then(geoData => {
                                  L.geoJSON(geoData, {
                                      pane: 'kabkotaPane',
                                      style: function (feature) {
                                          let info = getFeatureData(feature);
                                          return {
                                              fillColor: getColorByStatus(info.status),
                                              weight: 1,
                                              opacity: 1,
                                              color: 'white',
                                              dashArray: '3',
                                              fillOpacity: 0.7
                                          };
                                      },
                                      onEachFeature: function (feature, layer) {
                                          let info = getFeatureData(feature);
                                          let statusColor = getColorByStatus(info.status);
                                          let badgeClass = 'success';
                                          let s = info.status.toLowerCase();
                                          if (s.includes('tanggap') || s.includes('merah')) badgeClass = 'danger';
                                          else if (s.includes('siaga') || s.includes('kuning')) badgeClass = 'warning';

                                          layer.bindTooltip(`<b>${info.nama}</b>: ${info.status}`, { sticky: true, direction: 'top' });
                                          layer.bindPopup(`
                                              <div class="text-center">
                                                  <h6 class="mb-1 fw-bold">${info.nama}</h6>
                                                  <span class="badge bg-${badgeClass}">${info.status}</span>
                                              </div>
                                          `);

                                          layer.on({
                                              mouseover: function (e) {
                                                  var l = e.target;
                                                  l.setStyle({
                                                      weight: 4,
                                                      color: statusColor,
                                                      dashArray: '',
                                                      fillColor: 'white',
                                                      fillOpacity: 0.2
                                                  });
                                                  if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) l.bringToFront();
                                              },
                                              mouseout: function (e) {
                                                  var l = e.target;
                                                  l.setStyle({
                                                      weight: 1,
                                                      color: 'white',
                                                      dashArray: '3',
                                                      fillColor: statusColor,
                                                      fillOpacity: 0.7
                                                  });
                                              },
                                              click: function (e) { this.openPopup(); }
                                          });
                                      }
                                  }).addTo(map);
                              })
                              .catch(e => console.error("Error reloading GeoJSON:", e));

                          // Update marker lokasi (mengikuti filter layer)
                          applyLokasiFilter();
                          renderRelawanMarkers(relawanLokasi);
                          applyRelawanVisibility();

                          permintaanLogistik = Array.isArray(result.permintaan_logistik) ? result.permintaan_logistik : (result.permintaan_logistik || []);
                          applyPermintaanVisibility();

                      // Asemen buffers (kesehatan & pendidikan)
                          asesmenKesehatan = Array.isArray(result.asesmen_kesehatan) ? result.asesmen_kesehatan : (result.asesmen_kesehatan || []);
                          asesmenPendidikan = Array.isArray(result.asesmen_pendidikan) ? result.asesmen_pendidikan : (result.asesmen_pendidikan || []);
                          asesmenPsikososial = Array.isArray(result.asesmen_psikososial) ? result.asesmen_psikososial : (result.asesmen_psikososial || []);
                          asesmenInfrastruktur = Array.isArray(result.asesmen_infrastruktur) ? result.asesmen_infrastruktur : (result.asesmen_infrastruktur || []);
                          asesmenWash = Array.isArray(result.asesmen_wash) ? result.asesmen_wash : (result.asesmen_wash || []);
                          asesmenKondisi = Array.isArray(result.asesmen_kondisi) ? result.asesmen_kondisi : (result.asesmen_kondisi || []);
                          renderAsesmenBuffers();
                          applyAsesmenVisibility();
                          // Tampilkan notifikasi sukses (centered)
                          showNotification('Map berhasil di-refresh!', 'success', true);
                      } else {
                          showNotification('Gagal refresh map: ' + (result.error || 'Unknown error'), 'danger');
                      }
                  } catch (error) {
                      console.error('Error refreshing map:', error);
                      showNotification('Error saat refresh map. Silakan coba lagi.', 'danger');
                  } finally {
                      isRefreshingMap = false;
                      refreshMapBtn.innerHTML = originalHtml;
                      refreshMapBtn.disabled = false;
                  }
              }

              refreshMapBtn.addEventListener('click', refreshMap);

              // ==============================================================================
              // FUNGSI NOTIFIKASI
              // ==============================================================================
              function showNotification(message, type = 'info', center = false) {
                  const alertDiv = document.createElement('div');
                  alertDiv.className = `alert alert-${type} alert-dismissible fade show shadow`;
                  if (center) {
                      alertDiv.style.cssText = 'position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 10000; min-width: 300px; max-width: 700px; text-align: center;';
                  } else {
                      alertDiv.style.cssText = 'position: fixed; top: 70px; left: 15px; z-index: 10000; min-width: 300px; max-width: 400px;';
                  }
                  alertDiv.innerHTML = `
                      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                      ${message}
                      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                  `;
                  document.body.appendChild(alertDiv);

                  setTimeout(() => {
                      if (alertDiv.parentNode) {
                          alertDiv.remove();
                      }
                  }, 3000);
              }

              // ==============================================================================
              // LOGIKA ABSENSI LOKASI RELAWAN (GEOLOCATION API)
              // ==============================================================================
              const btnSubmitAbsensi = document.getElementById('btn-submit-absensi');
              const absensiLat = document.getElementById('absensi_lat');
              const absensiLon = document.getElementById('absensi_lon');
              const currentLocationSpan = document.getElementById('current-location');
              const refreshLocationBtn = document.getElementById('refreshLocationBtn');

               // ====================== MINI MAP ABSENSI (KOREKSI TITIK) ======================
              let absensiMiniMap = null;
              let absensiMiniMarker = null;
              let absensiGeoWatchId = null;
              let absensiGeoTimer = null;

              function initAbsensiMiniMap() {
                  const el = document.getElementById('absensiMiniMap');
                  if (!el) return;
                  if (absensiMiniMap) return;

                  absensiMiniMap = L.map('absensiMiniMap', {
                      zoomControl: true,
                      attributionControl: false,
                      scrollWheelZoom: false
                  }).setView([2.3693, 99.0763], 9);

                  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                      attribution: '&copy; OpenStreetMap contributors'
                  }).addTo(absensiMiniMap);

                  // Klik peta -> pindah pin (manual koreksi)
                  absensiMiniMap.on('click', function (e) {
                      setAbsensiPoint(e.latlng.lat, e.latlng.lng, { manual: true });
                      showNotification('Titik absensi diperbarui (klik peta).', 'success', true);
                  });
              }

              function stopAbsensiGeoWatch() {
                  if (absensiGeoWatchId !== null) {
                      try { navigator.geolocation.clearWatch(absensiGeoWatchId); } catch (e) {}
                      absensiGeoWatchId = null;
                  }
                  if (absensiGeoTimer) {
                      clearTimeout(absensiGeoTimer);
                      absensiGeoTimer = null;
                  }
              }

              function setAbsensiPoint(lat, lon, opts = {}) {
                  const isManual = !!opts.manual;
                  const accuracy = typeof opts.accuracy === 'number' ? opts.accuracy : null;

                  absensiLat.value = lat;
                  absensiLon.value = lon;

                  const accHtml = (accuracy !== null)
                      ? `<br>Akurasi: ${Math.round(accuracy)}m`
                      : (isManual ? `<br><span class="text-muted">Titik dikoreksi manual</span>` : '');

                  currentLocationSpan.innerHTML = `
                      <i class="fas fa-check-circle"></i> Lokasi ditemukan!<br>
                      <small>Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}${accHtml}</small>
                  `;
                  currentLocationSpan.classList.remove('text-danger', 'text-primary');
                  currentLocationSpan.classList.add('text-success');
                  btnSubmitAbsensi.disabled = false;

                  initAbsensiMiniMap();
                  if (absensiMiniMap) {
                      if (!absensiMiniMarker) {
                          absensiMiniMarker = L.marker([lat, lon], { draggable: true }).addTo(absensiMiniMap);

                          // Geser pin -> update koordinat (manual koreksi)
                          absensiMiniMarker.on('dragend', function (ev) {
                              const p = ev.target.getLatLng();
                              setAbsensiPoint(p.lat, p.lng, { manual: true });
                              showNotification('Titik absensi diperbarui (geser pin).', 'success', true);
                          });
                      } else {
                          absensiMiniMarker.setLatLng([lat, lon]);
                      }

                      // Zoom menyesuaikan (kalau akurasi sangat besar, jangan zoom terlalu dekat)
                      const targetZoom = (accuracy !== null && accuracy <= 1000) ? 17 : 14;
                      absensiMiniMap.setView([lat, lon], Math.max(absensiMiniMap.getZoom(), targetZoom), { animate: true });
                  }
              }

              // Best-effort: ambil beberapa update lokasi, pilih yang akurasinya paling kecil.
              // Catatan: di laptop/PC akurasi bisa sangat besar karena bukan GPS (lebih ke estimasi jaringan).
              function getBestAbsensiLocation(opts) {
                  opts = opts || {};
                  const targetAcc = typeof opts.targetAccuracy === 'number' ? opts.targetAccuracy : 50;
                  const maxWaitMs = typeof opts.maxWaitMs === 'number' ? opts.maxWaitMs : 20000;
                  const onUpdate = typeof opts.onUpdate === 'function' ? opts.onUpdate : null;
                  const onDone = typeof opts.onDone === 'function' ? opts.onDone : null;

                  let bestPos = null;
                  let lastErr = null;
                  let done = false;

                  function accOf(pos) {
                      return pos && pos.coords && typeof pos.coords.accuracy === 'number'
                          ? pos.coords.accuracy
                          : 9999999;
                  }

                  function consider(pos) {
                      if (!pos || !pos.coords) return;
                      if (!bestPos || accOf(pos) < accOf(bestPos)) bestPos = pos;
                      if (onUpdate) onUpdate(bestPos);
                      if (accOf(pos) <= targetAcc) finish();
                  }

                  function fail(err) {
                      lastErr = err || lastErr;
                  }

                  function finish() {
                      if (done) return;
                      done = true;
                      stopAbsensiGeoWatch();
                      if (onDone) onDone(bestPos, lastErr);
                  }

                  stopAbsensiGeoWatch();
                  absensiGeoTimer = setTimeout(finish, maxWaitMs);

                  // 1) cepat: high accuracy
                  try {
                      navigator.geolocation.getCurrentPosition(
                          consider,
                          fail,
                          { enableHighAccuracy: true, timeout: Math.min(12000, maxWaitMs), maximumAge: 0 }
                      );
                  } catch (e) {}

                  // 2) cepat: network-based (kadang lebih baik di laptop)
                  try {
                      navigator.geolocation.getCurrentPosition(
                          consider,
                          fail,
                          { enableHighAccuracy: false, timeout: Math.min(12000, maxWaitMs), maximumAge: 0 }
                      );
                  } catch (e) {}

                  // 3) watchPosition untuk cari yang paling akurat
                  try {
                      absensiGeoWatchId = navigator.geolocation.watchPosition(
                          consider,
                          fail,
                          { enableHighAccuracy: true, maximumAge: 0 }
                      );
                  } catch (e) {}
              }


              // Fungsi untuk mendapatkan lokasi dengan retry
              function getCurrentLocation(retryCount = 0, onComplete = null) {
                  const maxRetries = 3;

                  initAbsensiMiniMap();

                  if (!navigator.geolocation) {
                      currentLocationSpan.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Geolocation tidak didukung. Silakan klik peta untuk set titik manual.';
                      currentLocationSpan.classList.remove('text-success', 'text-primary');
                      currentLocationSpan.classList.add('text-danger');
                      btnSubmitAbsensi.disabled = true;
                      if (onComplete) onComplete();
                      showNotification('Geolocation tidak didukung. Klik peta untuk set titik manual.', 'danger');
                      return;
                  }

                  // Loading state
                  currentLocationSpan.innerHTML = '<i class="fas fa-sync fa-spin"></i> Mencari lokasi (akurasi terbaik)...';
                  currentLocationSpan.classList.remove('text-success', 'text-danger');
                  currentLocationSpan.classList.add('text-primary');
                  btnSubmitAbsensi.disabled = true;

                  // Reset koordinat
                  absensiLat.value = '';
                  absensiLon.value = '';

                  getBestAbsensiLocation({
                      targetAccuracy: 50,
                      maxWaitMs: 20000,
                      onUpdate: function (bestPos) {
                          if (!bestPos || !bestPos.coords) return;

                          const lat = bestPos.coords.latitude;
                          const lon = bestPos.coords.longitude;
                          const accuracy = bestPos.coords.accuracy;

                          if (isNaN(lat) || isNaN(lon) || lat === 0 || lon === 0) return;

                          // Update UI + mini map + marker
                          setAbsensiPoint(lat, lon, { accuracy: accuracy, manual: false });
                      },
                      onDone: function (bestPos, err) {
                          if (bestPos && bestPos.coords) {
                              const lat = bestPos.coords.latitude;
                              const lon = bestPos.coords.longitude;
                              const accuracy = bestPos.coords.accuracy;

                              setAbsensiPoint(lat, lon, { accuracy: accuracy, manual: false });

                              // Jika akurasi sangat besar, arahkan user koreksi manual
                              if (accuracy && accuracy > 5000) {
                                  showNotification('Akurasi GPS rendah. Silakan geser pin/klik peta untuk koreksi titik sebelum submit.', 'warning', true);
                              } else {
                                  showNotification(`Lokasi berhasil diperbarui! Akurasi: ${Math.round(accuracy)}m`, 'success', true);
                              }

                              if (onComplete) onComplete();
                              return;
                          }

                          // Kalau gagal total -> retry atau arahkan ke manual map
                          let errorMessage = '';
                          let shouldRetry = false;
                          let notificationMsg = '';

                          if (err && err.code === err.PERMISSION_DENIED) {
                              errorMessage = '<i class="fas fa-ban"></i> Akses lokasi ditolak. Anda masih bisa klik peta untuk set titik manual.';
                              notificationMsg = 'Akses lokasi ditolak. Klik peta untuk set titik manual.';
                          } else if (err && err.code === err.POSITION_UNAVAILABLE) {
                              errorMessage = '<i class="fas fa-question-circle"></i> Informasi lokasi tidak tersedia. Anda bisa klik peta untuk set titik manual.';
                              notificationMsg = 'Lokasi tidak tersedia. Klik peta untuk set titik manual.';
                              shouldRetry = retryCount < maxRetries;
                          } else if (err && err.code === err.TIMEOUT) {
                              errorMessage = '<i class="fas fa-clock"></i> Waktu tunggu habis. Mencoba lagi...';
                              notificationMsg = 'Waktu tunggu habis. Mencoba lagi...';
                              shouldRetry = retryCount < maxRetries;
                          } else {
                              errorMessage = '<i class="fas fa-exclamation-triangle"></i> Gagal mengambil lokasi. Anda bisa klik peta untuk set titik manual.';
                              notificationMsg = 'Gagal mengambil lokasi. Klik peta untuk set titik manual.';
                              shouldRetry = retryCount < maxRetries;
                          }

                          currentLocationSpan.innerHTML = errorMessage;
                          currentLocationSpan.classList.remove('text-success', 'text-primary');
                          currentLocationSpan.classList.add('text-danger');
                          btnSubmitAbsensi.disabled = true;

                          console.error('Geolocation error:', {
                              code: err ? err.code : null,
                              message: err ? err.message : null,
                              retryCount: retryCount
                          });

                          if (shouldRetry) {
                              setTimeout(() => {
                                  currentLocationSpan.innerHTML = `<i class="fas fa-sync fa-spin"></i> Mencoba lagi... (${retryCount + 1}/${maxRetries})`;
                                  getCurrentLocation(retryCount + 1, onComplete);
                              }, 2000);
                          } else {
                              if (onComplete) onComplete();
                              if (notificationMsg) showNotification(notificationMsg, 'danger');
                          }
                      }
                  });
              }

              // Event listener untuk tombol refresh lokasi
              if (refreshLocationBtn) {
                  refreshLocationBtn.addEventListener('click', function(e) {
                      e.preventDefault();
                      e.stopPropagation();

                      // Tampilkan loading state
                      const originalHtml = refreshLocationBtn.innerHTML;
                      refreshLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                      refreshLocationBtn.disabled = true;

                      // Update status lokasi
                      currentLocationSpan.innerHTML = '<i class="fas fa-sync fa-spin"></i> Mencari lokasi...';
                      currentLocationSpan.classList.remove('text-success', 'text-danger');
                      currentLocationSpan.classList.add('text-primary');

                      // Reset koordinat
                      absensiLat.value = '';
                      absensiLon.value = '';
                      btnSubmitAbsensi.disabled = true;

                      // Panggil fungsi getCurrentLocation dengan callback untuk restore button
                      getCurrentLocation(0, function() {
                          // Restore button setelah selesai
                          refreshLocationBtn.innerHTML = originalHtml;
                          refreshLocationBtn.disabled = false;
                      });
                  });
              }

              // Panggil Geolocation saat modal absensi dibuka
              document.getElementById('absensiModal').addEventListener('show.bs.modal', function () {
                  currentLocationSpan.innerHTML = '<i class="fas fa-sync fa-spin"></i> Mencari lokasi...';
                  currentLocationSpan.classList.remove('text-success', 'text-danger');
                  currentLocationSpan.classList.add('text-primary');
                  btnSubmitAbsensi.disabled = true;

                  // Reset nilai koordinat
                  absensiLat.value = '';
                  absensiLon.value = '';

                  // Mulai proses mendapatkan lokasi
                  getCurrentLocation();
              });

              // Pastikan mini map terbaca ukurannya saat modal sudah tampil
              document.getElementById('absensiModal').addEventListener('shown.bs.modal', function () {
                  initAbsensiMiniMap();
                  if (absensiMiniMap) absensiMiniMap.invalidateSize();
              });

              // Stop watcher GPS saat modal ditutup
              document.getElementById('absensiModal').addEventListener('hidden.bs.modal', function () {
                  stopAbsensiGeoWatch();
              });


              // Validasi form sebelum submit
              document.getElementById('absensiForm').addEventListener('submit', function(e) {
                  const lat = absensiLat.value;
                  const lon = absensiLon.value;

                  if (!lat || !lon || lat === '' || lon === '') {
                      e.preventDefault();
                      currentLocationSpan.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Lokasi belum ditemukan. Silakan tunggu atau refresh halaman.';
                      currentLocationSpan.classList.remove('text-success', 'text-primary');
                      currentLocationSpan.classList.add('text-danger');
                      btnSubmitAbsensi.disabled = true;

                      // Coba lagi mendapatkan lokasi
                      getCurrentLocation();
                      return false;
                  }

                  // Validasi koordinat valid (bukan 0,0)
                  if (parseFloat(lat) === 0 && parseFloat(lon) === 0) {
                      e.preventDefault();
                      currentLocationSpan.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Koordinat tidak valid. Silakan coba lagi.';
                      currentLocationSpan.classList.remove('text-success', 'text-primary');
                      currentLocationSpan.classList.add('text-danger');
                      btnSubmitAbsensi.disabled = true;
                      return false;
                  }
              });

              // Carousel untuk Data Bencana & Korban
              (function () {
                  const carousel = document.getElementById('bencanaCarousel');
                  const pagination = document.getElementById('bencanaPagination');

                  if (!carousel || !pagination) return;

                  const slides = carousel.querySelectorAll('.bencana-slide');
                  const totalSlides = slides.length;

                  if (totalSlides === 0) return;

                  let currentIndex = 0;

                  // --- LOGIKA PAGINATION DOTS ---
                  for (let i = 0; i < totalSlides; i++) {
                      const dot = document.createElement('button');
                      dot.className = 'bencana-pagination-dot';
                      if (i === 0) dot.classList.add('active');
                      dot.setAttribute('aria-label', `Slide ${i + 1}`);
                      dot.addEventListener('click', () => {
                          goToSlide(i);
                          stopAutoPlay(); // Reset timer saat user interaksi manual
                          startAutoPlay();
                      });
                      pagination.appendChild(dot);
                  }

                  // --- FUNGSI PINDAH SLIDE UTAMA ---
                  function goToSlide(index) {
                      // Logika looping (infinite loop effect)
                      if (index < 0) {
                          index = totalSlides - 1; // Ke slide terakhir
                      } else if (index >= totalSlides) {
                          index = 0; // Ke slide pertama
                      }

                      currentIndex = index;
                      carousel.style.transform = `translateX(-${index * 100}%)`;

                      // Update active dot
                      const dots = pagination.querySelectorAll('.bencana-pagination-dot');
                      dots.forEach((dot, i) => {
                          dot.classList.toggle('active', i === index);
                      });
                  }

                  // --- AUTO PLAY ---
                  let autoPlayInterval;
                  function startAutoPlay() {
                      stopAutoPlay();
                      autoPlayInterval = setInterval(() => {
                          const nextIndex = currentIndex + 1;
                          goToSlide(nextIndex);
                      }, 4000);
                  }

                  function stopAutoPlay() {
                      if (autoPlayInterval) {
                          clearInterval(autoPlayInterval);
                      }
                  }

                  if (totalSlides > 1) {
                      startAutoPlay();
                      const container = carousel.closest('.bencana-carousel-container');
                      if (container) {
                          container.addEventListener('mouseenter', stopAutoPlay);
                          container.addEventListener('mouseleave', startAutoPlay);
                      }
                  }
              })();
    </script>
    <script>
      // Global loading overlay helpers
      function showGlobalLoading(msg) {
        const ov = document.getElementById("globalLoadingOverlay");
        if (!ov) return;
        const textEl = ov.querySelector(".loading-text");
        if (msg) textEl.textContent = msg;
        ov.style.display = "flex";
      }
      function hideGlobalLoading() {
        const ov = document.getElementById("globalLoadingOverlay");
        if (!ov) return;
        ov.style.display = "none";
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Attach submit handler to all POST forms to show loading and prevent double submits
        document
          .querySelectorAll('form[method="POST"]')
          .forEach(function (form) {
            form.addEventListener("submit", function () {
              showGlobalLoading("Mengirim data...");
              form
                .querySelectorAll('button, input[type="submit"]')
                .forEach(function (el) {
                  el.disabled = true;
                });
            });
          });

        const confirmLogoutBtn = document.getElementById("confirmLogoutBtn");
        const logoutForm = document.getElementById("logoutForm");
        if (confirmLogoutBtn && logoutForm) {
          confirmLogoutBtn.addEventListener("click", function () {
            const modalEl = document.getElementById("logoutConfirmModal");
            const modal =
              bootstrap.Modal.getInstance(modalEl) ||
              new bootstrap.Modal(modalEl);
            modal.hide();
            showGlobalLoading("Logging out...");
            logoutForm.submit();
          });
        }
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const sidebar = document.getElementById("sidebar");
        const toggleBtn = document.getElementById("sidebarToggle");
        const closeBtn = document.getElementById("sidebarClose");

        // 1. Fungsi Buka Sidebar
        toggleBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          e.preventDefault();
          sidebar.classList.add("active");
          toggleBtn.style.visibility = "hidden";
        });

        // 2. Fungsi Tutup Sidebar (Tombol X)
        closeBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          sidebar.classList.remove("active");
          setTimeout(() => {
            toggleBtn.style.visibility = "visible";
          }, 300);
        });

        // 3. Logic Tutup Sidebar saat klik di luar (Global Click)
        document.addEventListener("click", function (e) {
          if (sidebar.classList.contains("active")) {
            const clickInsideSidebar = sidebar.contains(e.target);
            const clickToggle = toggleBtn.contains(e.target);
            const clickInsideModal = e.target.closest(".modal-content");
            if (!clickInsideSidebar && !clickToggle && !clickInsideModal) {
              sidebar.classList.remove("active");
              setTimeout(() => {
                toggleBtn.style.visibility = "visible";
              }, 300);
            }
          }
        });

        // Sort datalist relawan A-Z (client-side)
        const dl = document.getElementById("relawanDatalist");
        if (dl) {
          const opts = Array.from(dl.querySelectorAll("option"));
          opts.sort((a, b) =>
            (a.value || "").localeCompare(b.value || "", "id", {
              sensitivity: "base",
            })
          );
          dl.innerHTML = "";
          opts.forEach((o) => dl.appendChild(o));
        }

        // Toggle show/hide kode akses (password)
        const kodeAksesInput = document.getElementById("kode_akses");
        const toggleKodeAksesBtn =
          document.getElementById("toggleKodeAksesBtn");
        if (kodeAksesInput && toggleKodeAksesBtn) {
          toggleKodeAksesBtn.addEventListener("click", function () {
            const isPassword =
              (kodeAksesInput.getAttribute("type") || "password") ===
              "password";
            kodeAksesInput.setAttribute(
              "type",
              isPassword ? "text" : "password"
            );
            const icon = toggleKodeAksesBtn.querySelector("i");
            if (icon) {
              icon.classList.toggle("fa-eye", !isPassword);
              icon.classList.toggle("fa-eye-slash", isPassword);
            }
          });
        }
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const alerts = document.querySelectorAll(".alert");
        alerts.forEach(function (alert) {
          setTimeout(function () {
            let bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
          }, 3000);
        });
      });
    </script>

    <!-- ===================================================================== -->
    <!-- ASESMEN: MINI MAP + BEST GPS (SAMA DENGAN ABSENSI)                      -->
    <!-- ===================================================================== -->
    <script>
      // MINI MAP ASESMEN: konsep sama seperti absensi (GPS -> marker, bisa geser / klik peta)
      // Catatan: absensi sudah punya modul sendiri. Di sini khusus untuk asesmen (kesehatan & pendidikan).

      (function () {
        const DEFAULT_CENTER = [3.5952, 98.6722]; // Medan

        const cfg = {
            lokasi: {
        modalId: "inputLokasiModal",
        mapId: "inputLokasiMiniMap",
        latId: "lokasi_lat",
        lonId: "lokasi_lon",
        textId: "lokasi-location-text",
        btnId: "btn-submit-lokasi",
        statusId: "lokasi-location-status",
        autoOnOpen: true,
      },
          kesehatan: {
            modalId: "asesmenKesehatanModal",
            mapId: "kesehatanMiniMap",
            latId: "kesehatan_lat",
            lonId: "kesehatan_lon",
            textId: "kesehatan-location-text",
            btnId: "btn-submit-kesehatan",
            statusId: "kesehatan-location-status",
          },
          pendidikan: {
            modalId: "asesmenPendidikanModal",
            mapId: "pendidikanMiniMap",
            latId: "pendidikan_lat",
            lonId: "pendidikan_lon",
            textId: "pendidikan-location-text",
            btnId: "btn-submit-pendidikan",
            statusId: "pendidikan-location-status",
          },
          psikososial: {
            modalId: "asesmenPsikososialModal",
            mapId: "psikososialMiniMap",
            latId: "psikososial_lat",
            lonId: "psikososial_lon",
            textId: "psikososial-location-text",
            btnId: "btn-submit-psikososial",
            statusId: "psikososial-location-status",
          },
          infrastruktur: {
            modalId: "asesmenInfrastrukturModal",
            mapId: "infrastrukturMiniMap",
            latId: "infrastruktur_lat",
            lonId: "infrastruktur_lon",
            textId: "infrastruktur-location-text",
            btnId: "btn-submit-infrastruktur",
            statusId: "infrastruktur-location-status",
          },
          wash: {
            modalId: "asesmenWashModal",
            mapId: "washMiniMap",
            latId: "wash_lat",
            lonId: "wash_lon",
            textId: "wash-location-text",
            btnId: "btn-submit-wash",
            statusId: "wash-location-status",
          },
          kondisi: {
            modalId: "asesmenKondisiModal",
            mapId: "kondisiMiniMap",
            latId: "kondisi_lat",
            lonId: "kondisi_lon",
            textId: "kondisi-location-text",
            btnId: "btn-submit-kondisi",
            statusId: "kondisi-location-status",
          },
          kondisi_banjir: {
            modalId: "asesmenKondisiModal",
            mapId: "kondisiBanjirMiniMap",
            latId: "kondisiBanjir_lat",
            lonId: "kondisiBanjir_lon",
            textId: "kondisi-location-text",
            btnId: "btn-submit-kondisi",
            statusId: "kondisi-location-status",
            listId: "kondisi-points-list",
            mode: "multiple",
          },
          permintaan: {
            modalId: "permintaanModal",
            mapId: "permintaanMiniMap",
            latId: "permintaan_lat",
            lonId: "permintaan_lon",
            textId: "permintaan-location-text",
            btnId: "btn-submit-permintaan",
            statusId: "permintaan-location-status",
          },
        };

        const state = {
          kesehatan: {
            map: null,
            marker: null,
            watchId: null,
            timeoutId: null,
          },
          pendidikan: {
            map: null,
            marker: null,
            watchId: null,
            timeoutId: null,
          },
          psikososial: {
            map: null,
            marker: null,
            watchId: null,
            timeoutId: null,
          },
          infrastruktur: {
            map: null,
            marker: null,
            watchId: null,
            timeoutId: null,
          },
          wash: { map: null, marker: null, watchId: null, timeoutId: null },
          kondisi: { map: null, marker: null, watchId: null, timeoutId: null },
          kondisi_banjir: {
            map: null,
            markers: {}, // multiple
            points: {},
            watchId: null,
            timeoutId: null,
          },
          permintaan: {
            map: null,
            marker: null,
            watchId: null,
            timeoutId: null,
          },
            lokasi: { map: null, marker: null, watchId: null, timeoutId: null },

        };

        function _el(id) {
          return document.getElementById(id);
        }

        function _stopWatch(kind) {
          try {
            const st = state[kind];
            if (st && st.watchId) {
              navigator.geolocation.clearWatch(st.watchId);
              st.watchId = null;
            }
            if (st && st.timeoutId) {
              clearTimeout(st.timeoutId);
              st.timeoutId = null;
            }
          } catch (e) {}
        }

window.getLocationForLokasi = function () {
  const kind = 'lokasi';
  if (!cfg[kind]) return;
  _initMap(kind);
  _getBestLocation(kind);
};

        function _initMap(kind) {
          const c = cfg[kind];
          const st = state[kind];
          if (!c || !st) return;

          if (st.map) return;

          const mapEl = _el(c.mapId);
          if (!mapEl) return;

          st.map = L.map(c.mapId).setView(DEFAULT_CENTER, 14);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors",
          }).addTo(st.map);

          // ================= MULTIPLE =================
          // ===== MULTIPLE =====
          if (c.mode === "multiple") {
            st.markers = {};
            st.points = {};

            st.map.on("click", (e) => {
              const key = nextKey(st.points);

              const marker = L.marker(e.latlng, { draggable: true }).addTo(
                st.map
              );

              st.markers[key] = marker;
              st.points[key] = [e.latlng.lat, e.latlng.lng];

              renderPointList(kind);

              marker.on("dragend", (ev) => {
                const pos = ev.target.getLatLng();
                st.points[key] = [pos.lat, pos.lng];
                renderPointList(kind);
              });
            });
            return;
          }
          // marker default (draggable)
          //Single
          st.marker = L.marker(DEFAULT_CENTER, { draggable: true }).addTo(
            st.map
          );

          st.marker.on("dragend", function (e) {
            const pos = e.target.getLatLng();
            _setPoint(kind, pos.lat, pos.lng, { manual: true });
          });

          st.map.on("click", function (e) {
            _setPoint(kind, e.latlng.lat, e.latlng.lng, { manual: true });
          });
        }

        function _setText(kind, msg, isError = false) {
          const c = cfg[kind];
          const txt = _el(c.textId);
          if (txt) txt.textContent = msg;
          const st = _el(c.statusId);
          if (st) {
            st.textContent = isError ? "Gagal" : "OK";
            st.className = "badge " + (isError ? "bg-danger" : "bg-success");
          }
        }

        function _setPoint(kind, lat, lon, opts = {}) {
          const c = cfg[kind];
          const st = state[kind];

          if (!c || !st) return;

          const latNum = parseFloat(lat);
          const lonNum = parseFloat(lon);

          if (isNaN(latNum) || isNaN(lonNum)) {
            _setText(kind, "Koordinat tidak valid.", true);
            return;
          }

          // Update hidden inputs
          const latEl = _el(c.latId);
          const lonEl = _el(c.lonId);
          if (latEl) latEl.value = latNum.toFixed(6);
          if (lonEl) lonEl.value = lonNum.toFixed(6);

          // Update marker
          if (st.marker) st.marker.setLatLng([latNum, lonNum]);
          if (st.map) st.map.panTo([latNum, lonNum]);

          // Deteksi wilayah (pakai fungsi yang sudah ada di file ini)
          let wilayah = "";
          try {
            wilayah = cekWilayah ? cekWilayah(latNum, lonNum) : "";
          } catch (e) {
            wilayah = "";
          }

          const base = wilayah ? ` ${wilayah}` : " Lokasi dipilih";
          const extra = opts.accuracy
            ? ` (akurasi ${Math.round(opts.accuracy)}m)`
            : "";
          _setText(kind, base + extra, false);

          // Enable submit
          const btn = _el(c.btnId);
          if (btn) btn.disabled = false;

          // Notif jika manual
          if (opts.manual) {
            try {
              showNotification("Lokasi diperbarui manual di peta.", "info");
            } catch (e) {}
          }
        }

        function _getBestLocation(kind, opts = {}) {
          // Teknik: ambil beberapa sample + watchPosition, pilih yang akurasi paling kecil.
          const st = state[kind];
          const maxSamples = opts.maxSamples || 6;
          const maxWaitMs = opts.maxWaitMs || 12000;

          if (!navigator.geolocation) {
            _setText(kind, "Browser tidak mendukung GPS.", true);
            return;
          }

          _stopWatch(kind);

          _setText(kind, "Mencari lokasi GPS terbaik...", false);

          let best = null;
          let samples = 0;

          function consider(pos) {
            if (!pos || !pos.coords) return;
            const acc = pos.coords.accuracy || 999999;
            if (!best || acc < best.accuracy) {
              best = {
                lat: pos.coords.latitude,
                lon: pos.coords.longitude,
                accuracy: acc,
              };
              _setPoint(kind, best.lat, best.lon, { accuracy: best.accuracy });
            }
            samples += 1;
            if (samples >= maxSamples) finish();
          }

          function finish() {
            _stopWatch(kind);
            if (!best) {
              _setText(
                kind,
                "Gagal mendapatkan lokasi. Silakan pilih manual di peta.",
                true
              );
              return;
            }
            _setText(
              kind,
              ` Lokasi ditemukan (akurasi ${Math.round(best.accuracy)}m)`,
              false
            );
          }

          function onError(err) {
            // Jika ditolak / error, tetap biarkan user pilih manual
            _stopWatch(kind);
            const msg = err && err.message ? err.message : "Error GPS";
            _setText(kind, `Gagal GPS (${msg}). Pilih manual di peta.`, true);
          }

          // 1) High accuracy
          navigator.geolocation.getCurrentPosition(consider, onError, {
            enableHighAccuracy: true,
            timeout: 8000,
            maximumAge: 0,
          });

          // 2) Low accuracy fallback (kadang lebih cepat)
          navigator.geolocation.getCurrentPosition(consider, function () {}, {
            enableHighAccuracy: false,
            timeout: 6000,
            maximumAge: 0,
          });

          // 3) Watch for improvements
          try {
            st.watchId = navigator.geolocation.watchPosition(
              consider,
              function () {},
              { enableHighAccuracy: true, maximumAge: 0, timeout: 8000 }
            );
          } catch (e) {}

          // Stop after maxWait
          st.timeoutId = setTimeout(finish, maxWaitMs);
        }

        //============= Start Multiple Points ====================//
        function renderPointList(kind) {
          const c = cfg[kind];
          const st = state[kind];
          const box = document.getElementById(c.listId);
          if (!box) return;

          box.innerHTML = "";

          Object.entries(st.points).forEach(([key, val]) => {
            const [lat, lng] = val;

            const row = document.createElement("div");
            row.className =
              "d-flex align-items-center gap-2 p-2 border rounded bg-light";

            row.innerHTML = `
      <span class="badge bg-primary">${key}</span>
      <input class="form-control form-control-sm" value="${lat.toFixed(
        6
      )}" readonly>
      <input class="form-control form-control-sm" value="${lng.toFixed(
        6
      )}" readonly>
      <button class="btn btn-danger btn-sm">
        <i class="fas fa-trash"></i>
      </button>
    `;

            row.querySelector("button").onclick = () => removePoint(kind, key);

            box.appendChild(row);
          });
        }

        function nextKey(points) {
          return "b" + (Object.keys(points).length + 1);
        }

        function removePoint(kind, key) {
          const st = state[kind];

          if (st.markers[key]) {
            st.map.removeLayer(st.markers[key]);
            delete st.markers[key];
          }

          delete st.points[key];
          renderPointList(kind);
        }

        //============= END Multiple Points ====================//

        function syncBanjirPointsToForm(form) {
          // hapus input lama
          form.querySelectorAll(".banjir-point").forEach((e) => e.remove());

          // buat input baru untuk setiap titik
          Object.values(state.kondisi_banjir.points || {}).forEach((pt) => {
            const lat = document.createElement("input");
            lat.type = "hidden";
            lat.name = "banjir_lat[]";
            lat.value = pt[0];
            lat.className = "banjir-point";

            const lon = document.createElement("input");
            lon.type = "hidden";
            lon.name = "banjir_lon[]";
            lon.value = pt[1];
            lon.className = "banjir-point";

            form.appendChild(lat);
            form.appendChild(lon);
          });
        }
        const formKondisi = document.querySelector("#asesmenKondisiModal form");

        formKondisi.addEventListener("submit", function (e) {
          e.preventDefault();
          syncBanjirPointsToForm(formKondisi);
          formKondisi.submit();
        });

        // Public handler (dipakai tombol "Ambil Lokasi GPS")
        window.getLocationForAsesmen = function (jenis) {
          const kind = String(jenis || "").toLowerCase();
          if (!cfg[kind]) return;

          _initMap(kind);
          _getBestLocation(kind);
        };

        // Public handler (dipakai tombol permintaan)
        window.getLocationForPermintaan = function () {
          const kind = "permintaan";
          if (!cfg[kind]) return;
          _initMap(kind);
          _getBestLocation(kind);
        };

        // Auto-run saat modal dibuka
        Object.keys(cfg).forEach(function (kind) {
          const c = cfg[kind];

          const modal = _el(c.modalId);
          if (!modal) return;

          modal.addEventListener("show.bs.modal", function () {
            // Reset state
            _setText(kind, "Menunggu lokasi...", false);
            const btn = _el(c.btnId);
            if (btn) btn.disabled = true;

            // Init map dan ambil GPS
            _initMap(kind);
            _getBestLocation(kind);
          });

          modal.addEventListener("shown.bs.modal", function () {
            // Fix ukuran map dalam modal
            setTimeout(function () {
              if (state[kind].map) state[kind].map.invalidateSize();
            }, 200);
          });

          modal.addEventListener("hidden.bs.modal", function () {
            _stopWatch(kind);
          });
        });
      })();
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // ===== Login Relawan: datalist (A-Z) + dropdown click =====
        const dl = document.getElementById("relawanDatalist");
        const namaInput = document.getElementById("nama");
        const menu = document.getElementById("relawanDropdownMenu");
        const dropdownWrap = document.getElementById("relawanDropdownWrap");
        const dropdownBtn = document.getElementById("relawanDropdownBtn");

        if (dl) {
          const opts = Array.from(dl.querySelectorAll("option"))
            .map((o) => (o.value || "").trim())
            .filter(Boolean)
            .sort((a, b) => a.localeCompare(b, "id", { sensitivity: "base" }));

          // Rebuild datalist (sorted)
          dl.innerHTML = "";
          opts.forEach((v) => {
            const o = document.createElement("option");
            o.value = v;
            dl.appendChild(o);
          });

          // Build dropdown menu for click selection (keeps typing support)
          if (menu && namaInput) {
            const renderMenu = (q) => {
              const query = (q || "").toLowerCase();
              const filtered = opts
                .filter((v) => v.toLowerCase().includes(query))
                .slice(0, 200);

              menu.innerHTML = "";
              if (filtered.length === 0) {
                const li = document.createElement("li");
                const span = document.createElement("span");
                span.className = "dropdown-item-text";
                span.textContent = "Tidak ada hasil";
                li.appendChild(span);
                menu.appendChild(li);
                return;
              }

              filtered.forEach((v) => {
                const li = document.createElement("li");
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "dropdown-item";
                btn.textContent = v;
                btn.addEventListener("click", () => {
                  namaInput.value = v;
                  namaInput.focus();
                });
                li.appendChild(btn);
                menu.appendChild(li);
              });
            };

            renderMenu("");

            namaInput.addEventListener("input", () => {
              renderMenu(namaInput.value);
            });

            // Refresh menu content when dropdown opened
            if (dropdownWrap) {
              dropdownWrap.addEventListener("show.bs.dropdown", () => {
                renderMenu(namaInput.value);
              });
            }

            if (dropdownBtn) {
              dropdownBtn.addEventListener("click", () => {
                // Pastikan input fokus agar user bisa langsung mengetik
                if (namaInput) namaInput.focus();
              });
            }
          }
        }

        // ===== Toggle show/hide untuk Kode Akses =====
        const kodeInput = document.getElementById("kode_akses");
        const toggleBtn = document.getElementById("toggleKodeAkses");

        if (kodeInput && toggleBtn) {
          toggleBtn.addEventListener("click", () => {
            const isPassword = kodeInput.getAttribute("type") === "password";
            kodeInput.setAttribute("type", isPassword ? "text" : "password");

            const icon = toggleBtn.querySelector("i");
            if (icon) {
              icon.classList.toggle("fa-eye", !isPassword);
              icon.classList.toggle("fa-eye-slash", isPassword);
            }
          });
        }
      });
    </script>


  </body>
</html>
